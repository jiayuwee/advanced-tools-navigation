name: Build Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-verification:
    runs-on: ubuntu-latest
    name: Build Verification
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 2

      - name: Setup Node.js
        run: |
          echo "ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ..."
          node --version
          npm --version

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
        timeout-minutes: 2

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          echo "æ£€æŸ¥ package.json..."
          if [ -f "package.json" ]; then
            echo "package.json å­˜åœ¨ï¼Œå¼€å§‹å®‰è£…ä¾èµ–..."
            echo "æ¸…ç†npmç¼“å­˜..."
            npm cache clean --force
            echo "å®‰è£…ä¾èµ–..."
            npm install --prefer-offline --no-audit
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          else
            echo "âŒ package.json ä¸å­˜åœ¨"
            exit 1
          fi
        timeout-minutes: 5

      - name: Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡..."
          echo "VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:0:20}..."
          echo "VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY:+å·²è®¾ç½®}"
          echo "â±ï¸ æ„å»ºå¼€å§‹æ—¶é—´: $(date)"
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"
          echo "â±ï¸ æ„å»ºç»“æŸæ—¶é—´: $(date)"
        timeout-minutes: 10
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NODE_ENV: production

      - name: Verify build output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          ls -la dist/
          if [ -f "dist/index.html" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ - index.html å­˜åœ¨"
            echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
            du -sh dist/
            echo "ğŸ“ ä¸»è¦æ–‡ä»¶:"
            ls -lh dist/assets/ | head -10
          else
            echo "âŒ æ„å»ºå¤±è´¥ - index.html ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Deployment notification
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          echo "ğŸš€ ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ“¦ Netlify å°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤æ¬¡æ„å»º" 
          echo "â±ï¸ éƒ¨ç½²é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿ"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://ramusi.cn"
          echo "âœ… æ„å»ºéªŒè¯é€šè¿‡ï¼Œç­‰å¾… Netlify éƒ¨ç½²..."
