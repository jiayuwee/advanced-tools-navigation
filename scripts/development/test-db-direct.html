<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•°æ®åº“è¿æ¥æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #007acc;
        background: #f8f9fa;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #005a9e;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” æ•°æ®åº“è¿æ¥æµ‹è¯•</h1>
      <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯• Supabase æ•°æ®åº“è¿æ¥å’Œæ•°æ®æŸ¥è¯¢</p>

      <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
      <button onclick="testCategories()">æµ‹è¯•åˆ†ç±»æŸ¥è¯¢</button>
      <button onclick="testTools()">æµ‹è¯•å·¥å…·æŸ¥è¯¢</button>
      <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>

      <div id="results"></div>
    </div>

    <script type="module">
      // é…ç½®ä¿¡æ¯
      const SUPABASE_URL = 'https://fytiwsutzgmygfxnqoft.supabase.co'
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5dGl3c3V0emdteWdmeG5xb2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MDM1ODcsImV4cCI6MjA2NjM3OTU4N30.LM9vazR9QCZ4vLC_Q1lJmtCj3pEVqM6vpW4TKzntAQA'

      let supabase = null

      function addResult(message, type = 'result') {
        const results = document.getElementById('results')
        const div = document.createElement('div')
        div.className = `result ${type}`
        div.innerHTML = message
        results.appendChild(div)
        results.scrollTop = results.scrollHeight
      }

      function clearResults() {
        document.getElementById('results').innerHTML = ''
      }

      async function initSupabase() {
        if (supabase) return supabase

        try {
          const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js')
          supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          return supabase
        } catch (error) {
          addResult(`âŒ åˆå§‹åŒ– Supabase å¤±è´¥: ${error.message}`, 'error')
          throw error
        }
      }

      window.testConnection = async function () {
        addResult('ğŸ”— å¼€å§‹æµ‹è¯•è¿æ¥...')

        try {
          const client = await initSupabase()
          addResult('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success')

          // æµ‹è¯•ç®€å•æŸ¥è¯¢
          const { data, error } = await client.from('categories').select('id').limit(1)

          if (error) {
            addResult(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
          } else {
            addResult('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success')
          }
        } catch (error) {
          addResult(`âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error')
        }
      }

      window.testCategories = async function () {
        addResult('ğŸ“Š å¼€å§‹æµ‹è¯•åˆ†ç±»æŸ¥è¯¢...')

        try {
          const client = await initSupabase()

          // æŸ¥è¯¢æ‰€æœ‰åˆ†ç±»
          const { data: allCategories, error: allError } = await client
            .from('categories')
            .select('*')

          if (allError) {
            addResult(`âŒ æŸ¥è¯¢æ‰€æœ‰åˆ†ç±»å¤±è´¥: ${allError.message}`, 'error')
            return
          }

          addResult(`ğŸ“Š æ‰€æœ‰åˆ†ç±»æ•°é‡: ${allCategories?.length || 0}`)
          if (allCategories && allCategories.length > 0) {
            addResult(`<pre>${JSON.stringify(allCategories, null, 2)}</pre>`)
          }

          // æŸ¥è¯¢æ´»è·ƒåˆ†ç±»
          const { data: activeCategories, error: activeError } = await client
            .from('categories')
            .select('*')
            .eq('is_active', true)

          if (activeError) {
            addResult(`âŒ æŸ¥è¯¢æ´»è·ƒåˆ†ç±»å¤±è´¥: ${activeError.message}`, 'error')
            return
          }

          addResult(`âœ… æ´»è·ƒåˆ†ç±»æ•°é‡: ${activeCategories?.length || 0}`, 'success')
          if (activeCategories && activeCategories.length > 0) {
            addResult(`<pre>${JSON.stringify(activeCategories, null, 2)}</pre>`)
          }
        } catch (error) {
          addResult(`âŒ åˆ†ç±»æŸ¥è¯¢å¼‚å¸¸: ${error.message}`, 'error')
        }
      }

      window.testTools = async function () {
        addResult('ğŸ”§ å¼€å§‹æµ‹è¯•å·¥å…·æŸ¥è¯¢...')

        try {
          const client = await initSupabase()

          // æŸ¥è¯¢æ‰€æœ‰å·¥å…·
          const { data: allTools, error: allError } = await client.from('tools').select('*')

          if (allError) {
            addResult(`âŒ æŸ¥è¯¢æ‰€æœ‰å·¥å…·å¤±è´¥: ${allError.message}`, 'error')
            return
          }

          addResult(`ğŸ”§ æ‰€æœ‰å·¥å…·æ•°é‡: ${allTools?.length || 0}`)

          // æŸ¥è¯¢æ´»è·ƒå·¥å…·
          const { data: activeTools, error: activeError } = await client
            .from('tools')
            .select('*, category:categories(*)')
            .eq('status', 'active')

          if (activeError) {
            addResult(`âŒ æŸ¥è¯¢æ´»è·ƒå·¥å…·å¤±è´¥: ${activeError.message}`, 'error')
            return
          }

          addResult(`âœ… æ´»è·ƒå·¥å…·æ•°é‡: ${activeTools?.length || 0}`, 'success')
          if (activeTools && activeTools.length > 0) {
            addResult(`<pre>${JSON.stringify(activeTools.slice(0, 3), null, 2)}</pre>`)
          }
        } catch (error) {
          addResult(`âŒ å·¥å…·æŸ¥è¯¢å¼‚å¸¸: ${error.message}`, 'error')
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
      window.addEventListener('load', () => {
        addResult('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...')
      })
    </script>
  </body>
</html>
