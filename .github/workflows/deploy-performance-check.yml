name: ğŸš€ Deploy Performance Check

on:
  workflow_dispatch:

env:
  WEBSITE_URL: 'https://ramusi.cn'
  NODE_VERSION: '20.x'

jobs:
  # ç®€åŒ–çš„æ€§èƒ½æ£€æŸ¥ - åªåœ¨éƒ¨ç½²æ—¶è¿è¡Œ
  deploy-check:
    runs-on: ubuntu-latest
    name: ğŸ¯ Deploy Performance Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” Verify Node.js and npm setup
        run: |
          echo "ğŸ” éªŒè¯ Node.js å’Œ npm å®‰è£…..."
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          
          # éªŒè¯ npm å‘½ä»¤æ˜¯å¦å¯ç”¨
          if ! command -v npm &> /dev/null; then
            echo "âŒ npm å‘½ä»¤ä¸å¯ç”¨"
            exit 1
          fi
          
          # ç®€åŒ–éªŒè¯ï¼Œåªæ£€æŸ¥åŸºæœ¬åŠŸèƒ½
          if npm --version &> /dev/null; then
            echo "âœ… npm åŸºæœ¬åŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ npm åŸºæœ¬åŠŸèƒ½å¼‚å¸¸"
            exit 1
          fi

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          # ä½¿ç”¨npm ciï¼Œå¢åŠ é”™è¯¯å¤„ç†
          if npm ci --prefer-offline --no-audit; then
            echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ npm ci å¤±è´¥ï¼Œå°è¯• npm install..."
            npm install --prefer-offline --no-audit
          fi

      - name: ğŸ”¨ Build project
        run: |
          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build

      - name: ğŸ“Š Basic performance check
        run: |
          echo "ğŸ“Š åŸºç¡€æ€§èƒ½æ£€æŸ¥..."
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
          if [ -d "dist" ]; then
            total_size=$(du -sh dist | cut -f1)
            echo "æ„å»ºäº§ç‰©æ€»å¤§å°: $total_size"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡å¤§çš„æ–‡ä»¶
            large_files=$(find dist -type f -size +1M | wc -l)
            if [ "$large_files" -gt 0 ]; then
              echo "âš ï¸ å‘ç° $large_files ä¸ªå¤§æ–‡ä»¶ (>1MB):"
              find dist -type f -size +1M -exec ls -lh {} \;
            else
              echo "âœ… æ— è¿‡å¤§æ–‡ä»¶"
            fi
            
            # æ£€æŸ¥ JS æ–‡ä»¶æ•°é‡
            js_files=$(find dist -name "*.js" | wc -l)
            css_files=$(find dist -name "*.css" | wc -l)
            echo "JavaScript æ–‡ä»¶æ•°é‡: $js_files"
            echo "CSS æ–‡ä»¶æ•°é‡: $css_files"
            
          else
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸŒ Website accessibility check
        run: |
          echo "ğŸŒ ç½‘ç«™å¯è®¿é—®æ€§æ£€æŸ¥..."
          
          # ç®€å•çš„ç½‘ç«™å¯è®¿é—®æ€§æ£€æŸ¥
          if curl -sSf --max-time 30 "${{ env.WEBSITE_URL }}" > /dev/null 2>&1; then
            echo "âœ… ç½‘ç«™å¯è®¿é—®"
            
            # è·å–å“åº”æ—¶é—´
            response_time=$(curl -o /dev/null -s -w '%{time_total}' "${{ env.WEBSITE_URL }}")
            echo "å“åº”æ—¶é—´: ${response_time}ç§’"
            
            # æ£€æŸ¥å“åº”æ—¶é—´æ˜¯å¦åˆç†
            if (( $(echo "$response_time > 5.0" | bc -l) )); then
              echo "âš ï¸ å“åº”æ—¶é—´è¾ƒæ…¢ (>5ç§’)"
            else
              echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
            fi
            
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®"
            # ä¸è®©è¿™ä¸ªå¤±è´¥é˜»æ­¢æ•´ä¸ªæµç¨‹
          fi
        continue-on-error: true

      - name: ğŸ“‹ Generate simple report
        run: |
          echo "ğŸ“‹ ç”Ÿæˆç®€å•æŠ¥å‘Š..."
          
          echo "## ğŸš€ éƒ¨ç½²æ€§èƒ½æ£€æŸ¥æŠ¥å‘Š" > deploy_check.md
          echo "æ£€æŸ¥æ—¶é—´: $(date)" >> deploy_check.md
          echo "ç›®æ ‡ç½‘ç«™: ${{ env.WEBSITE_URL }}" >> deploy_check.md
          echo "" >> deploy_check.md
          
          if [ -d "dist" ]; then
            total_size=$(du -sh dist | cut -f1)
            echo "### ğŸ“Š æ„å»ºç»Ÿè®¡" >> deploy_check.md
            echo "- æ„å»ºäº§ç‰©å¤§å°: $total_size" >> deploy_check.md
            echo "- JavaScript æ–‡ä»¶: $(find dist -name "*.js" | wc -l) ä¸ª" >> deploy_check.md
            echo "- CSS æ–‡ä»¶: $(find dist -name "*.css" | wc -l) ä¸ª" >> deploy_check.md
            echo "- å›¾ç‰‡æ–‡ä»¶: $(find dist -name "*.png" -o -name "*.jpg" -o -name "*.svg" | wc -l) ä¸ª" >> deploy_check.md
          fi
          
          echo "" >> deploy_check.md
          echo "### ğŸŒ ç½‘ç«™çŠ¶æ€" >> deploy_check.md
          if curl -sSf --max-time 30 "${{ env.WEBSITE_URL }}" > /dev/null 2>&1; then
            response_time=$(curl -o /dev/null -s -w '%{time_total}' "${{ env.WEBSITE_URL }}")
            echo "- å¯è®¿é—®æ€§: âœ… æ­£å¸¸" >> deploy_check.md
            echo "- å“åº”æ—¶é—´: ${response_time}ç§’" >> deploy_check.md
          else
            echo "- å¯è®¿é—®æ€§: âŒ æ— æ³•è®¿é—®" >> deploy_check.md
          fi
          
          echo "" >> deploy_check.md
          echo "### ğŸ“ˆ ä¼˜åŒ–å»ºè®®" >> deploy_check.md
          echo "- ç›‘æ§æ„å»ºäº§ç‰©å¤§å°å˜åŒ–" >> deploy_check.md
          echo "- å®šæœŸæ£€æŸ¥ç½‘ç«™å“åº”æ—¶é—´" >> deploy_check.md
          echo "- ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº" >> deploy_check.md
          
          cat deploy_check.md

      - name: ğŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: deploy-check-report
          path: deploy_check.md
          retention-days: 7

  # å¯é€‰çš„è¯¦ç»†æ€§èƒ½æµ‹è¯• - åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
  detailed-performance:
    runs-on: ubuntu-latest
    name: ğŸ” Detailed Performance Test
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ” Run detailed tests
        run: |
          echo "ğŸ” è¿è¡Œè¯¦ç»†æ€§èƒ½æµ‹è¯•..."
          echo "è¿™ä¸ªæ­¥éª¤åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼Œé¿å…å½±å“æ­£å¸¸éƒ¨ç½²"
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æ€§èƒ½æµ‹è¯•
          # æ¯”å¦‚ Lighthouseã€è´Ÿè½½æµ‹è¯•ç­‰
          
          echo "âœ… è¯¦ç»†æµ‹è¯•å®Œæˆ"
