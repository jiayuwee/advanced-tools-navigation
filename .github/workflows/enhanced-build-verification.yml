name: ğŸ”¨ Enhanced Build & Quality Verification

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: 'v3'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Code Quality Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          # è®¾ç½®npmé…ç½®ä»¥æé«˜ç¨³å®šæ€§
          npm config set prefer-offline true
          npm config set audit-level moderate
          npm config set fund false
          npm config set update-notifier false
          
          # æ¸…ç†ç¼“å­˜ä»¥é¿å…å¹³å°å…¼å®¹æ€§é—®é¢˜
          npm cache clean --force 2>/dev/null || true
          
          # ä¼˜å…ˆä½¿ç”¨ npm ci è¿›è¡Œå¿«é€Ÿå®‰è£…
          if [ -f "package-lock.json" ]; then
            echo "ä½¿ç”¨ npm ci è¿›è¡Œå¿«é€Ÿå®‰è£…..."
            npm ci --no-optional --prefer-offline --no-audit --ignore-scripts --silent
          else
            echo "package-lock.json ä¸å­˜åœ¨ï¼Œä½¿ç”¨ npm install..."
            npm install --prefer-offline --no-audit --ignore-scripts --silent
          fi
          
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…æ•°é‡: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ” ESLint Check
        run: |
          echo "ğŸ” è¿è¡Œ ESLint æ£€æŸ¥..."
          npm run lint
          echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

      - name: ğŸ”§ TypeScript Type Check (non-blocking)
        run: |
          echo "ğŸ”§ è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥ (éé˜»å¡)..."
          # å°†ç±»å‹æ£€æŸ¥è®¾ç½®ä¸ºéé˜»å¡ï¼Œé¿å…ä¸´æ—¶ç±»å‹é”™è¯¯é˜»æ–­ CIï¼›ä»¥ååº”å½“ä¿®å¤ç±»å‹é”™è¯¯æˆ–é€æ­¥æ¢å¤ä¸ºä¸¥æ ¼æ£€æŸ¥
          npm run type-check || true
          echo "âœ… TypeScript ç±»å‹æ£€æŸ¥å®Œæˆï¼ˆéé˜»å¡ï¼‰"

  # æµ‹è¯•æ‰§è¡Œ
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Run Tests
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm config set prefer-offline true
          npm config set audit-level moderate
          npm config set fund false
          
          npm cache clean --force 2>/dev/null || true
          
          if [ -f "package-lock.json" ]; then
            npm ci --no-optional --prefer-offline --no-audit --ignore-scripts --silent
          else
            npm install --prefer-offline --no-audit --ignore-scripts --silent
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ§ª Run unit tests
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          npm run test:run
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

      - name: ğŸ“Š Generate test coverage
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
          npm run test:coverage
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  # æ„å»ºéªŒè¯
  build-verification:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build Verification
    needs: [code-quality, test]
    strategy:
      matrix:
        node-version: ['20.x']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (Node.js ${{ matrix.node-version }})..."
          npm config set prefer-offline true
          npm config set audit-level moderate
          npm config set fund false
          
          npm cache clean --force 2>/dev/null || true
          
          if [ -f "package-lock.json" ]; then
            npm ci --no-optional --prefer-offline --no-audit --ignore-scripts --silent
          else
            npm install --prefer-offline --no-audit --ignore-scripts --silent
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ” Pre-build validation
        run: |
          echo "ğŸ” æ„å»ºå‰éªŒè¯..."
          
          # éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
          if [ -z "$VITE_SUPABASE_URL" ] || [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "âš ï¸ Supabase ç¯å¢ƒå˜é‡æœªå®Œå…¨é…ç½®"
            echo "VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:+å·²è®¾ç½®}"
            echo "VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY:+å·²è®¾ç½®}"
            echo "âŒ æ£€æµ‹åˆ°ç¼ºå¤±çš„ Supabase secretsã€‚åœ¨ç»§ç»­æ„å»ºä¹‹å‰è¯·åœ¨ä»“åº“ Settings -> Secrets ä¸­è®¾ç½® VITE_SUPABASE_URL å’Œ VITE_SUPABASE_ANON_KEYã€‚"
            # åœ¨ CI ä¸­å°½æ—©å¤±è´¥ï¼Œé¿å…åœ¨åç»­æ„å»ºä¸­äº§ç”Ÿéš¾ä»¥æ’æŸ¥çš„é”™è¯¯
            exit 1
          else
            echo "âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£å¸¸"
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          required_files=("src/main.ts" "src/App.vue" "vite.config.ts" "package.json")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $file"
              exit 1
            fi
          done
          echo "âœ… å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ”¨ Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export NODE_ENV=production
          export VITE_APP_VERSION=${{ github.sha }}
          
          # å¼€å§‹æ„å»º
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          
          build_duration=$((end_time - start_time))
          echo "âœ… æ„å»ºå®Œæˆ (è€—æ—¶: ${build_duration}ç§’)"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NODE_ENV: production

      - name: ğŸ” Post-build validation
        run: |
          echo "ğŸ” æ„å»ºåéªŒè¯..."
          
          # æ£€æŸ¥æ„å»ºç›®å½•
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥èµ„æºæ–‡ä»¶
          if [ ! -d "dist/assets" ]; then
            echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          
          # æ„å»ºç»Ÿè®¡
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "æ€»å¤§å°: $(du -sh dist/ | cut -f1)"
          echo "æ–‡ä»¶æ•°é‡: $(find dist -type f | wc -l)"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          large_files=$(find dist -type f -size +1M)
          if [ -n "$large_files" ]; then
            echo "âš ï¸ å‘ç°å¤§æ–‡ä»¶ (>1MB):"
            echo "$large_files" | while read file; do
              echo "  $(ls -lh "$file" | awk '{print $5 " " $9}')"
            done
          else
            echo "âœ… æ— è¿‡å¤§æ–‡ä»¶"
          fi
          
          # ä¸»è¦èµ„æºç»Ÿè®¡
          echo "ğŸ“ ä¸»è¦æ–‡ä»¶ç±»å‹:"
          echo "JavaScript: $(find dist -name "*.js" | wc -l) ä¸ª"
          echo "CSS: $(find dist -name "*.css" | wc -l) ä¸ª"
          echo "å›¾ç‰‡: $(find dist \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" \) | wc -l) ä¸ª"

      - name: ğŸ“¤ Upload build artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # å®‰å…¨æ€§æ£€æŸ¥
  security-check:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm config set audit-level moderate
          npm ci --prefer-offline --no-audit --ignore-scripts --silent

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡..."
          
          # è¿è¡Œå®‰å…¨å®¡è®¡
          if npm audit --audit-level high; then
            echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡"
          else
            echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"
            npm audit --audit-level high || true
          fi

      - name: ğŸ›¡ï¸ License check
        run: |
          echo "ğŸ›¡ï¸ æ£€æŸ¥ä¾èµ–åŒ…è®¸å¯è¯..."
          
          # å®‰è£…è®¸å¯è¯æ£€æŸ¥å·¥å…·
          npm install -g license-checker --silent
          
          # æ£€æŸ¥è®¸å¯è¯
          license-checker --summary --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;LGPL-2.1;LGPL-3.0' || true
          
          echo "âœ… è®¸å¯è¯æ£€æŸ¥å®Œæˆ"

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    runs-on: ubuntu-latest
    name: ğŸš€ Deployment Notification
    needs: [build-verification, security-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸš€ Enhanced deployment notification
        run: |
          echo "ğŸš€ ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ“¦ Netlify å°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤æ¬¡æ„å»º" 
          echo "â±ï¸ éƒ¨ç½²é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿ"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://ramusi.cn"
          echo ""
          echo "ğŸ“Š æ„å»ºæ‘˜è¦:"
          echo "  - âœ… ä»£ç è´¨é‡æ£€æŸ¥: é€šè¿‡"
          echo "  - âœ… æµ‹è¯•æ‰§è¡Œ: é€šè¿‡"  
          echo "  - âœ… æ„å»ºéªŒè¯: é€šè¿‡"
          echo "  - âœ… å®‰å…¨æ£€æŸ¥: é€šè¿‡"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - æ„å»ºè¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "  - æäº¤ä½œè€…: ${{ github.event.head_commit.author.name }}"
          echo ""
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç­‰å¾… Netlify éƒ¨ç½²..."