name: ğŸ”¨ Enhanced Build & Quality Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: 'v3'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Code Quality Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (ç®€åŒ– & ç¨³å®šæ¨¡å¼)..."
          echo "Node: $(node -v)"
          echo "NPM: $(npm -v)"

          # å°è¯•å¿«é€Ÿã€æœ€å°å‰¯ä½œç”¨çš„å®‰è£…ã€‚ä¸ä½¿ç”¨ --ignore-scripts ä»¥å…è®¸å¿…è¦çš„ postinstall (å¦‚äºŒè¿›åˆ¶è§£å‹)ã€‚
          if [ -f "package-lock.json" ]; then
            echo "ä½¿ç”¨ npm ci (åŒ…å«å¯é€‰ä¾èµ–)..."
            if npm ci --no-audit --include=optional; then
              echo "âœ… npm ci æˆåŠŸ"
            else
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå°è¯•å›é€€ npm install"
              rm -rf node_modules
              npm install --no-audit --include=optional
            fi
          else
            echo "æ—  package-lock.jsonï¼Œä½¿ç”¨ npm install"
            npm install --no-audit --include=optional
          fi

          echo "ğŸ“‹ é¡¶å±‚ä¾èµ–æ•°é‡: $(npm ls --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"
          echo "âœ… ä¾èµ–å®‰è£…é˜¶æ®µå®Œæˆ"

      - name: ğŸ” ESLint Check
        run: |
          echo "ğŸ” è¿è¡Œ ESLint æ£€æŸ¥..."
          npm run lint
          echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

      - name: ğŸ”§ TypeScript Type Check (non-blocking)
        run: |
          echo "ğŸ”§ è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥ (éé˜»å¡)..."
          # å°†ç±»å‹æ£€æŸ¥è®¾ç½®ä¸ºéé˜»å¡ï¼Œé¿å…ä¸´æ—¶ç±»å‹é”™è¯¯é˜»æ–­ CIï¼›ä»¥ååº”å½“ä¿®å¤ç±»å‹é”™è¯¯æˆ–é€æ­¥æ¢å¤ä¸ºä¸¥æ ¼æ£€æŸ¥
          npm run type-check || true
          echo "âœ… TypeScript ç±»å‹æ£€æŸ¥å®Œæˆï¼ˆéé˜»å¡ï¼‰"

  # æµ‹è¯•æ‰§è¡Œ
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Run Tests
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (æµ‹è¯•ä»»åŠ¡)..."
          echo "Node: $(node -v) | NPM: $(npm -v)"
          if [ -f "package-lock.json" ]; then
            if ! npm ci --no-audit --include=optional; then
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€ npm install"
              rm -rf node_modules
              npm install --no-audit --include=optional
            fi
          else
            npm install --no-audit --include=optional
          fi
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ§ª Run unit tests
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          npm run test:run
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

      - name: ğŸ“Š Generate test coverage
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
          npm run test:coverage
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  # æ„å»ºéªŒè¯
  build-verification:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build Verification
    needs: [code-quality, test]
    strategy:
      matrix:
        node-version: ['20.x']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ“¦ Install dependencies (Enhanced)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (Node.js ${{ matrix.node-version }})..."
          if [ -f "package-lock.json" ]; then
            if ! npm ci --no-audit --include=optional; then
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€ npm install"
              rm -rf node_modules
              npm install --no-audit --include=optional
            fi
          else
            npm install --no-audit --include=optional
          fi
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ” Pre-build validation
        run: |
          echo "ğŸ” æ„å»ºå‰éªŒè¯..."
          
          # éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
          if [ -z "$VITE_SUPABASE_URL" ] || [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "âš ï¸ Supabase ç¯å¢ƒå˜é‡æœªå®Œå…¨é…ç½®"
            echo "VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:+å·²è®¾ç½®}"
            echo "VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY:+å·²è®¾ç½®}"
            echo "âŒ æ£€æµ‹åˆ°ç¼ºå¤±çš„ Supabase secretsã€‚åœ¨ç»§ç»­æ„å»ºä¹‹å‰è¯·åœ¨ä»“åº“ Settings -> Secrets ä¸­è®¾ç½® VITE_SUPABASE_URL å’Œ VITE_SUPABASE_ANON_KEYã€‚"
            # åœ¨ CI ä¸­å°½æ—©å¤±è´¥ï¼Œé¿å…åœ¨åç»­æ„å»ºä¸­äº§ç”Ÿéš¾ä»¥æ’æŸ¥çš„é”™è¯¯
            exit 1
          else
            echo "âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£å¸¸"
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          required_files=("src/main.ts" "src/App.vue" "vite.config.ts" "package.json")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $file"
              exit 1
            fi
          done
          echo "âœ… å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ”¨ Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export NODE_ENV=production
          export VITE_APP_VERSION=${{ github.sha }}
          
          # å¼€å§‹æ„å»º
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          
          build_duration=$((end_time - start_time))
          echo "âœ… æ„å»ºå®Œæˆ (è€—æ—¶: ${build_duration}ç§’)"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NODE_ENV: production

      - name: ğŸ” Post-build validation
        run: |
          echo "ğŸ” æ„å»ºåéªŒè¯..."
          
          # æ£€æŸ¥æ„å»ºç›®å½•
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥èµ„æºæ–‡ä»¶
          if [ ! -d "dist/assets" ]; then
            echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          
          # æ„å»ºç»Ÿè®¡
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "æ€»å¤§å°: $(du -sh dist/ | cut -f1)"
          echo "æ–‡ä»¶æ•°é‡: $(find dist -type f | wc -l)"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          large_files=$(find dist -type f -size +1M)
          if [ -n "$large_files" ]; then
            echo "âš ï¸ å‘ç°å¤§æ–‡ä»¶ (>1MB):"
            echo "$large_files" | while read file; do
              echo "  $(ls -lh "$file" | awk '{print $5 " " $9}')"
            done
          else
            echo "âœ… æ— è¿‡å¤§æ–‡ä»¶"
          fi
          
          # ä¸»è¦èµ„æºç»Ÿè®¡
          echo "ğŸ“ ä¸»è¦æ–‡ä»¶ç±»å‹:"
          echo "JavaScript: $(find dist -name "*.js" | wc -l) ä¸ª"
          echo "CSS: $(find dist -name "*.css" | wc -l) ä¸ª"
          echo "å›¾ç‰‡: $(find dist \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" \) | wc -l) ä¸ª"

      - name: ï¿½ Generate dependency snapshot
        run: |
          echo "ğŸ“¦ ç”Ÿæˆä¾èµ–å¿«ç…§..."
          npm ls --depth=0 > dependency-tree.txt 2>&1 || true
          jq -n --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --arg commit "${GITHUB_SHA}" '{generated_at:$date, commit:$commit}' > meta.json
          echo "âœ… ä¾èµ–å¿«ç…§ç”Ÿæˆå®Œæˆ"

      - name: ğŸ“Š Bundle size report
        run: |
           echo "ğŸ“Š ç»Ÿè®¡ bundle å¤§å°..."
           du -ah dist | sort -h | tail -40 > bundle-size-top40.txt
           find dist -type f -name '*.js' -exec wc -c {} + | awk '{sum+=$1} END {print "Total JS bytes:", sum}' > bundle-summary.txt
           echo "âœ… Bundle ç»Ÿè®¡å®Œæˆ"

      - name: ğŸ“¤ Upload build analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-analysis
          path: |
            dependency-tree.txt
            bundle-size-top40.txt
            bundle-summary.txt
            meta.json
          retention-days: 7

      - name: ï¿½ Enforce bundle gzip thresholds
        run: |
          echo "ğŸš¨ æ£€æŸ¥ gzip ä½“ç§¯é˜ˆå€¼..."
          # é˜ˆå€¼ (å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)
          MAX_MAIN_GZIP_KB=300
          MAX_TOTAL_GZIP_KB=900

          # ç»Ÿè®¡ dist ä¸‹æ‰€æœ‰ JS/CSS gzip åå¤§å°
          mapfile -t files < <(find dist -type f \( -name '*.js' -o -name '*.css' \))
          total_bytes=0
          main_bytes=0
          for f in "${files[@]}"; do
            sz=$(gzip -c "$f" | wc -c)
            total_bytes=$((total_bytes + sz))
            if [[ "$f" == *"main"* || "$f" == *"index"* ]]; then
              main_bytes=$((main_bytes + sz))
            fi
          done

            echo "Total gzip(KB): $total_kb"
            echo "Main bundle gzip(KB): $main_kb"
          total_kb=$(( (total_bytes + 1023)/1024 ))
          main_kb=$(( (main_bytes + 1023)/1024 ))

          status=0
          if [ $main_kb -gt $MAX_MAIN_GZIP_KB ]; then
            echo "âŒ ä¸»å…¥å£ gzip å¤§å°è¶…å‡ºé˜ˆå€¼ ($main_kb KB > $MAX_MAIN_GZIP_KB KB)"
            status=1
          else
            echo "âœ… ä¸»å…¥å£ gzip å¤§å°: $main_kb KB"
          fi

          if [ $total_kb -gt $MAX_TOTAL_GZIP_KB ]; then
            echo "âŒ æ€» gzip å¤§å°è¶…å‡ºé˜ˆå€¼ ($total_kb KB > $MAX_TOTAL_GZIP_KB KB)"
            status=1
          else
            echo "âœ… æ€» gzip å¤§å°: $total_kb KB"
          fi

          echo "main_gzip_kb=$main_kb" >> $GITHUB_OUTPUT
          echo "total_gzip_kb=$total_kb" >> $GITHUB_OUTPUT

          exit $status

      - name: ï¿½ï¿½ğŸ“¤ Upload build artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # å®‰å…¨æ€§æ£€æŸ¥
  security-check:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (å®‰å…¨å®¡è®¡ä»»åŠ¡)..."
          if [ -f "package-lock.json" ]; then
            if ! npm ci --no-audit --include=optional; then
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€ npm install"
              rm -rf node_modules
              npm install --no-audit --include=optional
            fi
          else
            npm install --no-audit --include=optional
          fi

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡..."
          
          # è¿è¡Œå®‰å…¨å®¡è®¡
          if npm audit --audit-level high; then
            echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡"
          else
            echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"
            npm audit --audit-level high || true
          fi

      - name: ğŸ›¡ï¸ License check
        run: |
          echo "ğŸ›¡ï¸ æ£€æŸ¥ä¾èµ–åŒ…è®¸å¯è¯..."
          
          # å®‰è£…è®¸å¯è¯æ£€æŸ¥å·¥å…·
          npm install -g license-checker --silent
          
          # æ£€æŸ¥è®¸å¯è¯
          license-checker --summary --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;LGPL-2.1;LGPL-3.0' || true
          
          echo "âœ… è®¸å¯è¯æ£€æŸ¥å®Œæˆ"

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    runs-on: ubuntu-latest
    name: ğŸš€ Deployment Notification
    needs: [build-verification, security-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸš€ Enhanced deployment notification
        run: |
          echo "ğŸš€ ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ“¦ Netlify å°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤æ¬¡æ„å»º" 
          echo "â±ï¸ éƒ¨ç½²é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿ"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://ramusi.cn"
          echo ""
          echo "ğŸ“Š æ„å»ºæ‘˜è¦:"
          echo "  - âœ… ä»£ç è´¨é‡æ£€æŸ¥: é€šè¿‡"
          echo "  - âœ… æµ‹è¯•æ‰§è¡Œ: é€šè¿‡"  
          echo "  - âœ… æ„å»ºéªŒè¯: é€šè¿‡"
          echo "  - âœ… å®‰å…¨æ£€æŸ¥: é€šè¿‡"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - æ„å»ºè¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "  - æäº¤ä½œè€…: ${{ github.event.head_commit.author.name }}"
          echo ""
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç­‰å¾… Netlify éƒ¨ç½²..."
