name: ğŸš€ Deploy to Netlify

on:
  workflow_run:
    workflows: ["ğŸ”¨ Enhanced Build & Quality Verification"]
    types:
      - completed
    branches: [main]
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  NETLIFY_DIR: 'dist'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (éƒ¨ç½²ä»»åŠ¡)..."
          echo "Node: $(node -v)"
          echo "NPM(before): $(npm -v)"
          npm install -g npm@10.8.2 --silent || true
          echo "NPM(after): $(npm -v)"
          if [ -f "package-lock.json" ]; then
            if ! npm ci --no-audit --include=optional; then
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€ npm install"
              rm -rf node_modules
              npm install --no-audit --include=optional
            fi
          else
            npm install --no-audit --include=optional
          fi
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ“¦ Install Netlify CLI
        run: |
          echo "ğŸ“¦ å®‰è£… Netlify CLI..."
          npm install -g netlify-cli
          echo "âœ… Netlify CLI å®‰è£…å®Œæˆ"

      - name: ğŸ“ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ${{ env.NETLIFY_DIR }}

      - name: ğŸ” Verify build artifacts
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ ! -d "${{ env.NETLIFY_DIR }}" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "${{ env.NETLIFY_DIR }}/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š æ„å»ºäº§ç‰©ç»Ÿè®¡:"
          du -sh ${{ env.NETLIFY_DIR }}/
          ls -la ${{ env.NETLIFY_DIR }}/

      - name: ğŸš€ Deploy to Netlify
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Netlify..."
          
          # è®¾ç½® Netlify è®¤è¯
          export NETLIFY_AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          export NETLIFY_SITE_ID=${{ secrets.NETLIFY_SITE_ID }}
          
          # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
          npx netlify deploy \
            --dir=${{ env.NETLIFY_DIR }} \
            --prod \
            --message="Automated deployment from GitHub Actions ğŸš€" \
            --json | tee deploy-output.json
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          
          # æå–éƒ¨ç½²ä¿¡æ¯
          if [ -f "deploy-output.json" ]; then
            DEPLOY_URL=$(cat deploy-output.json | jq -r '.deploy_url // empty')
            DEPLOY_ID=$(cat deploy-output.json | jq -r '.deploy_id // empty')
            
            echo "ğŸŒ éƒ¨ç½²URL: $DEPLOY_URL"
            echo "ğŸ“‹ éƒ¨ç½²ID: $DEPLOY_ID"
            
            # è®¾ç½®è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_OUTPUT
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ“Š éƒ¨ç½²æ€»ç»“æŠ¥å‘Š"
          echo "================================"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
          echo "æäº¤: ${{ github.event.workflow_run.head_sha }}"
          echo "æ„å»ºå·¥ä½œæµ: ${{ github.event.workflow_run.name }}"
          echo "éƒ¨ç½²çŠ¶æ€: âœ… æˆåŠŸ"
          
          if [ -n "$DEPLOY_URL" ]; then
            echo "ç”Ÿäº§ç¯å¢ƒ: $DEPLOY_URL"
          fi
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "- ç½‘ç«™: https://ramusi.cn"
          echo "- Netlify æ§åˆ¶å°: https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}"
          echo "- GitHub ä»“åº“: ${{ github.repository }}"
        env:
          DEPLOY_URL: ${{ steps.deploy.outputs.DEPLOY_URL }}

      - name: ğŸ’¬ Deployment notification
        if: success()
        run: |
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "================================"
          echo "âœ… åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
          echo "ğŸŒ è®¿é—®åœ°å€: https://ramusi.cn"
          echo "â±ï¸ éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…:"
          echo "- æ„å»ºéªŒè¯: âœ… é€šè¿‡"
          echo "- æµ‹è¯•æ‰§è¡Œ: âœ… é€šè¿‡"
          echo "- å®‰å…¨æ‰«æ: âœ… é€šè¿‡"
          echo "- éƒ¨ç½²çŠ¶æ€: âœ… æˆåŠŸ"