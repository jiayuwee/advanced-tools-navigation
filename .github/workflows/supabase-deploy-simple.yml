# Supabase éƒ¨ç½²å·¥ä½œæµï¼ˆç®€åŒ–ç‰ˆï¼‰
# æ³¨æ„ï¼šGitHub Actions å¯èƒ½ä¼šæ˜¾ç¤º secrets è®¿é—®è­¦å‘Šï¼Œè¿™æ˜¯æ­£å¸¸çš„
# è¿™äº›è­¦å‘Šä¸ä¼šå½±å“å·¥ä½œæµçš„å®é™…è¿è¡Œ

name: Deploy to Supabase (Simple)

on:
  push:
    branches: [main]
    paths:
      - 'supabase/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Database and Frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ä»…åœ¨é…ç½®äº† Supabase secrets æ—¶è¿è¡Œæ•°æ®åº“éƒ¨ç½²
      - name: Setup Supabase CLI
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        uses: supabase/setup-cli@v1
        with:
          version: latest
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy database changes
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        run: |
          echo "ğŸš€ Deploying database changes..."

          # é“¾æ¥åˆ°é¡¹ç›®
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

          # è¿è¡Œè¿ç§»
          supabase db push

          echo "âœ… Database deployment completed"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Build frontend
        run: |
          echo "ğŸ—ï¸  Building frontend..."
          npm run build
          echo "âœ… Frontend build completed"
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deployment summary
        run: |
          echo "ğŸ“‹ Deployment Summary:"
          echo "===================="

          if [ -n "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "âœ… Database: Deployed to Supabase"
            echo "ğŸ”— Dashboard: https://supabase.com/dashboard/project/${{ secrets.SUPABASE_PROJECT_REF }}"
          else
            echo "âš ï¸  Database: Skipped (secrets not configured)"
          fi

          echo "âœ… Frontend: Built successfully"
          echo "ğŸŒ Site: https://ramusi.cn (via Netlify auto-deploy)"
          echo ""
          echo "ğŸ“š Configuration help: docs/SUPABASE_SETUP.md"

# é…ç½®è¯´æ˜ï¼š
# 1. åœ¨ GitHub ä»“åº“è®¾ç½® > Secrets ä¸­æ·»åŠ ï¼š
#    - SUPABASE_ACCESS_TOKEN: Supabase è®¿é—®ä»¤ç‰Œ
#    - SUPABASE_PROJECT_REF: Supabase é¡¹ç›® ID
#    - VITE_SUPABASE_URL: Supabase é¡¹ç›® URL
#    - VITE_SUPABASE_ANON_KEY: Supabase åŒ¿åå¯†é’¥
#
# 2. å¦‚æœæœªé…ç½® Supabase secretsï¼Œæ•°æ®åº“éƒ¨ç½²å°†è¢«è·³è¿‡
#    ä½†å‰ç«¯æ„å»ºä»ä¼šç»§ç»­
#
# 3. GitHub Actions å¯èƒ½æ˜¾ç¤º "Context access might be invalid" è­¦å‘Š
#    è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º GitHub æ— æ³•åœ¨é™æ€åˆ†ææ—¶éªŒè¯ secrets
#    è¿™äº›è­¦å‘Šä¸ä¼šå½±å“å·¥ä½œæµçš„å®é™…è¿è¡Œ
