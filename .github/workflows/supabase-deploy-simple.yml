# Supabase 部署工作流（简化版）
# 注意：GitHub Actions 可能会显示 secrets 访问警告，这是正常的
# 这些警告不会影响工作流的实际运行

name: Deploy to Supabase (Simple)

on:
  push:
    branches: [main]
    paths:
      - 'supabase/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Database and Frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 仅在配置了 Supabase secrets 时运行数据库部署
      - name: Setup Supabase CLI
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        uses: supabase/setup-cli@v1
        with:
          version: latest
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy database changes
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        run: |
          echo "🚀 Deploying database changes..."

          # 链接到项目
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

          # 运行迁移
          supabase db push

          echo "✅ Database deployment completed"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Build frontend
        run: |
          echo "🏗️  Building frontend..."
          npm run build
          echo "✅ Frontend build completed"
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deployment summary
        run: |
          echo "📋 Deployment Summary:"
          echo "===================="

          if [ -n "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "✅ Database: Deployed to Supabase"
            echo "🔗 Dashboard: https://supabase.com/dashboard/project/${{ secrets.SUPABASE_PROJECT_REF }}"
          else
            echo "⚠️  Database: Skipped (secrets not configured)"
          fi

          echo "✅ Frontend: Built successfully"
          echo "🌐 Site: https://ramusi.cn (via Netlify auto-deploy)"
          echo ""
          echo "📚 Configuration help: docs/SUPABASE_SETUP.md"

# 配置说明：
# 1. 在 GitHub 仓库设置 > Secrets 中添加：
#    - SUPABASE_ACCESS_TOKEN: Supabase 访问令牌
#    - SUPABASE_PROJECT_REF: Supabase 项目 ID
#    - VITE_SUPABASE_URL: Supabase 项目 URL
#    - VITE_SUPABASE_ANON_KEY: Supabase 匿名密钥
#
# 2. 如果未配置 Supabase secrets，数据库部署将被跳过
#    但前端构建仍会继续
#
# 3. GitHub Actions 可能显示 "Context access might be invalid" 警告
#    这是正常的，因为 GitHub 无法在静态分析时验证 secrets
#    这些警告不会影响工作流的实际运行
