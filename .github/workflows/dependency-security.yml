name: ğŸ“¦ Dependency & Security Management

on:
  schedule:
    - cron: "0 9 * * 1" # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: "0 0 1 * *" # æ¯æœˆ1å·æ£€æŸ¥å®‰å…¨æ¼æ´
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'security'
        type: choice
        options:
        - 'security'
        - 'dependencies'
        - 'both'

env:
  NODE_VERSION: '18.19.0'

jobs:
  # å®‰å…¨æ¼æ´æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Vulnerability Scan
    if: github.event.inputs.check_type == 'security' || github.event.inputs.check_type == 'both' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit

      - name: ğŸ” Run security audit
        run: |
          echo "ğŸ” è¿è¡Œå®‰å…¨å®¡è®¡..."
          echo "æ£€æŸ¥é«˜å±å’Œä¸¥é‡æ¼æ´..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´
          if npm audit --audit-level high --json > audit_results.json; then
            echo "âœ… æ²¡æœ‰å‘ç°é«˜å±æˆ–ä¸¥é‡å®‰å…¨æ¼æ´"
          else
            echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯¦ç»†ä¿¡æ¯ï¼š"
            cat audit_results.json | jq '.vulnerabilities'
            
            # å°è¯•è‡ªåŠ¨ä¿®å¤
            echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤..."
            npm audit fix --force
            
            # å†æ¬¡æ£€æŸ¥
            if npm audit --audit-level high; then
              echo "âœ… æ¼æ´å·²ä¿®å¤"
            else
              echo "âŒ ä»å­˜åœ¨é«˜å±æ¼æ´ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
              exit 1
            fi
          fi

      - name: ğŸ“Š Generate security report
        run: |
          echo "ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."
          npm audit --json > security_report.json
          
          echo "## ğŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Š" > security_summary.md
          echo "æ‰«ææ—¶é—´: $(date)" >> security_summary.md
          echo "" >> security_summary.md
          
          # æå–å…³é”®ä¿¡æ¯
          total_vulns=$(cat security_report.json | jq '.metadata.vulnerabilities.total // 0')
          critical_vulns=$(cat security_report.json | jq '.metadata.vulnerabilities.critical // 0')
          high_vulns=$(cat security_report.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "- æ€»æ¼æ´æ•°: $total_vulns" >> security_summary.md
          echo "- ä¸¥é‡æ¼æ´: $critical_vulns" >> security_summary.md
          echo "- é«˜å±æ¼æ´: $high_vulns" >> security_summary.md
          
          cat security_summary.md

      - name: ğŸ“¤ Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security_report.json
            security_summary.md
          retention-days: 30

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-check:
    runs-on: ubuntu-latest
    name: ğŸ“ˆ Dependency Update Check
    if: github.event.inputs.check_type == 'dependencies' || github.event.inputs.check_type == 'both' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit

      - name: ğŸ” Check for outdated packages
        run: |
          echo "ğŸ” æ£€æŸ¥è¿‡æ—¶çš„åŒ…..."
          
          # ç”Ÿæˆè¿‡æ—¶åŒ…æŠ¥å‘Š
          npm outdated --json > outdated_packages.json || true
          
          if [ -s outdated_packages.json ] && [ "$(cat outdated_packages.json)" != "{}" ]; then
            echo "ğŸ“‹ å‘ç°å¯æ›´æ–°çš„åŒ…ï¼š"
            cat outdated_packages.json | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"'
            
            echo "## ğŸ“ˆ ä¾èµ–æ›´æ–°æŠ¥å‘Š" > dependency_summary.md
            echo "æ£€æŸ¥æ—¶é—´: $(date)" >> dependency_summary.md
            echo "" >> dependency_summary.md
            echo "### å¯æ›´æ–°çš„åŒ…:" >> dependency_summary.md
            cat outdated_packages.json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> dependency_summary.md
          else
            echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "## ğŸ“ˆ ä¾èµ–æ›´æ–°æŠ¥å‘Š" > dependency_summary.md
            echo "æ£€æŸ¥æ—¶é—´: $(date)" >> dependency_summary.md
            echo "" >> dependency_summary.md
            echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬" >> dependency_summary.md
          fi
          
          cat dependency_summary.md

      - name: ğŸ”§ Check for major version updates
        run: |
          echo "ğŸ”§ æ£€æŸ¥ä¸»è¦ç‰ˆæœ¬æ›´æ–°..."
          
          # æ£€æŸ¥ä¸»è¦æ¡†æ¶çš„ç‰ˆæœ¬
          echo "### æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬æ£€æŸ¥:" >> dependency_summary.md
          
          current_vue=$(npm list vue --depth=0 --json | jq -r '.dependencies.vue.version')
          current_vite=$(npm list vite --depth=0 --json | jq -r '.dependencies.vite.version // "æœªå®‰è£…"')
          current_typescript=$(npm list typescript --depth=0 --json | jq -r '.dependencies.typescript.version // "æœªå®‰è£…"')
          
          echo "- Vue: $current_vue" >> dependency_summary.md
          echo "- Vite: $current_vite" >> dependency_summary.md
          echo "- TypeScript: $current_typescript" >> dependency_summary.md

      - name: ğŸ›¡ï¸ License compliance check
        run: |
          echo "ğŸ›¡ï¸ æ£€æŸ¥è®¸å¯è¯åˆè§„æ€§..."
          
          # å®‰è£…license-checker
          npm install -g license-checker
          
          # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
          license-checker --json > licenses.json
          
          echo "### ğŸ“œ è®¸å¯è¯ä¿¡æ¯:" >> dependency_summary.md
          echo "æ€»åŒ…æ•°: $(cat licenses.json | jq 'keys | length')" >> dependency_summary.md
          
          # æ£€æŸ¥æ½œåœ¨æœ‰é—®é¢˜çš„è®¸å¯è¯
          problematic_licenses=$(cat licenses.json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|LGPL"; "i")) | .key')
          
          if [ -n "$problematic_licenses" ]; then
            echo "âš ï¸ å‘ç°å¯èƒ½æœ‰é—®é¢˜çš„è®¸å¯è¯:" >> dependency_summary.md
            echo "$problematic_licenses" | while read -r package; do
              echo "- $package" >> dependency_summary.md
            done
          else
            echo "âœ… æ‰€æœ‰è®¸å¯è¯éƒ½æ˜¯å…¼å®¹çš„" >> dependency_summary.md
          fi

      - name: ğŸ“¤ Upload dependency artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            outdated_packages.json
            dependency_summary.md
            licenses.json
          retention-days: 30

  # è‡ªåŠ¨åŒ–ä¿®å¤ PR
  auto-fix-pr:
    runs-on: ubuntu-latest
    name: ğŸ”„ Auto-fix Security Issues
    needs: [security-scan]
    if: needs.security-scan.result == 'failure' && github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”§ Auto-fix security issues
        run: |
          echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤å®‰å…¨é—®é¢˜..."
          
          # å°è¯•è‡ªåŠ¨ä¿®å¤
          npm audit fix --force
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --quiet; then
            echo "æ²¡æœ‰å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜"
            exit 0
          else
            echo "å‘ç°å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜"
          fi

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ”’ è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´'
          title: 'ğŸ”’ è‡ªåŠ¨å®‰å…¨ä¿®å¤'
          body: |
            ## ğŸ”’ è‡ªåŠ¨å®‰å…¨ä¿®å¤
            
            æ­¤ PR ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»ºï¼Œç”¨äºä¿®å¤æ£€æµ‹åˆ°çš„å®‰å…¨æ¼æ´ã€‚
            
            ### ä¿®å¤å†…å®¹
            - è‡ªåŠ¨æ›´æ–°å­˜åœ¨å®‰å…¨æ¼æ´çš„ä¾èµ–åŒ…
            - æ‰§è¡Œäº† `npm audit fix --force`
            
            ### æ£€æŸ¥æ¸…å•
            - [ ] ç¡®è®¤ä¿®å¤æ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½
            - [ ] è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
            - [ ] æ£€æŸ¥æ„å»ºæ˜¯å¦æ­£å¸¸
            
            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          branch: auto-security-fix
          delete-branch: true

  # æŠ¥å‘Šæ±‡æ€»
  summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Summary Report
    needs: [security-scan, dependency-check]
    if: always()
    steps:
      - name: ğŸ“Š Generate final summary
        run: |
          echo "ğŸ“Š ä¾èµ–å’Œå®‰å…¨ç®¡ç†æ€»ç»“"
          echo "=================================="
          echo "æ£€æŸ¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # å®‰å…¨æ‰«æç»“æœ
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "âœ… å®‰å…¨æ‰«æ: é€šè¿‡"
          elif [ "${{ needs.security-scan.result }}" = "failure" ]; then
            echo "âŒ å®‰å…¨æ‰«æ: å‘ç°é—®é¢˜"
          else
            echo "â­ï¸ å®‰å…¨æ‰«æ: è·³è¿‡"
          fi
          
          # ä¾èµ–æ£€æŸ¥ç»“æœ
          if [ "${{ needs.dependency-check.result }}" = "success" ]; then
            echo "âœ… ä¾èµ–æ£€æŸ¥: é€šè¿‡"
          elif [ "${{ needs.dependency-check.result }}" = "failure" ]; then
            echo "âŒ ä¾èµ–æ£€æŸ¥: å‘ç°é—®é¢˜"
          else
            echo "â­ï¸ ä¾èµ–æ£€æŸ¥: è·³è¿‡"
          fi
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "- å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- ä»“åº“: ${{ github.server_url }}/${{ github.repository }}"