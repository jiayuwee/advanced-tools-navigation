name: ğŸš€ Direct Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆè·³è¿‡æ„å»ºéªŒè¯ï¼‰'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  NETLIFY_DIR: 'dist'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build & Deploy
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm config set prefer-offline true
          npm config set audit-level moderate
          npm config set fund false
          
          npm cache clean --force 2>/dev/null || true
          
          if [ -f "package-lock.json" ]; then
            npm ci --no-optional --prefer-offline --no-audit --ignore-scripts --silent
          else
            npm install --prefer-offline --no-audit --ignore-scripts --silent
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…æ•°é‡: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"

      - name: ğŸ” Quick lint check
        run: |
          echo "ğŸ” å¿«é€Ÿä»£ç æ£€æŸ¥..."
          npm run lint || echo "âš ï¸ ä»£ç æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­æ„å»º"
          echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

      - name: ğŸ”¨ Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export NODE_ENV=production
          export VITE_APP_VERSION=${{ github.sha }}
          export VITE_APP_ENV=production
          
          # å¼€å§‹æ„å»º
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          
          build_duration=$((end_time - start_time))
          echo "âœ… æ„å»ºå®Œæˆ (è€—æ—¶: ${build_duration}ç§’)"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}
          NODE_ENV: production

      - name: ğŸ” Verify build output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºæˆåŠŸéªŒè¯"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "æ€»å¤§å°: $(du -sh dist/ | cut -f1)"
          echo "æ–‡ä»¶æ•°é‡: $(find dist -type f | wc -l)"
          
          echo "ğŸ“ ä¸»è¦æ–‡ä»¶:"
          find dist -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | xargs ls -lh || true

      - name: ğŸ“¦ Install Netlify CLI
        run: |
          echo "ğŸ“¦ å®‰è£… Netlify CLI..."
          npm install -g netlify-cli
          echo "âœ… Netlify CLI å®‰è£…å®Œæˆ"

      - name: ğŸš€ Deploy to Netlify
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Netlify..."
          
          # æ£€æŸ¥å¿…è¦çš„å¯†é’¥
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ] || [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
            echo "âŒ Netlify è®¤è¯ä¿¡æ¯æœªé…ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½®:"
            echo "- NETLIFY_AUTH_TOKEN"
            echo "- NETLIFY_SITE_ID"
            exit 1
          fi
          
          # è®¾ç½® Netlify è®¤è¯
          export NETLIFY_AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          export NETLIFY_SITE_ID=${{ secrets.NETLIFY_SITE_ID }}
          
          # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
          npx netlify deploy \
            --dir=${{ env.NETLIFY_DIR }} \
            --prod \
            --message="Direct deployment from GitHub Actions ğŸš€ (commit: ${{ github.sha }})" \
            --json | tee deploy-output.json
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          
          # æå–éƒ¨ç½²ä¿¡æ¯
          if [ -f "deploy-output.json" ]; then
            DEPLOY_URL=$(cat deploy-output.json | jq -r '.deploy_url // empty')
            DEPLOY_ID=$(cat deploy-output.json | jq -r '.deploy_id // empty')
            
            echo "ğŸŒ éƒ¨ç½²URL: $DEPLOY_URL"
            echo "ğŸ“‹ éƒ¨ç½²ID: $DEPLOY_ID"
            
            # è®¾ç½®è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_OUTPUT
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: ğŸŒ Post-deployment verification
        run: |
          echo "ğŸŒ éƒ¨ç½²åéªŒè¯..."
          
          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 10
          
          # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
          if command -v curl >/dev/null 2>&1; then
            echo "æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."
            if curl -sSf -o /dev/null "https://ramusi.cn" || curl -sSf -o /dev/null "$DEPLOY_URL"; then
              echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
            else
              echo "âš ï¸ ç½‘ç«™å¯èƒ½è¿˜åœ¨éƒ¨ç½²ä¸­ï¼Œè¯·ç¨åéªŒè¯"
            fi
          fi

      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ“Š éƒ¨ç½²æ€»ç»“æŠ¥å‘Š"
          echo "================================"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "æäº¤ä½œè€…: ${{ github.event.head_commit.author.name }}"
          echo "éƒ¨ç½²çŠ¶æ€: âœ… æˆåŠŸ"
          
          if [ -n "$DEPLOY_URL" ]; then
            echo "éƒ¨ç½²URL: $DEPLOY_URL"
          fi
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "- ç”Ÿäº§ç½‘ç«™: https://ramusi.cn"
          echo "- Netlify æ§åˆ¶å°: https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}"
          echo "- GitHub ä»“åº“: ${{ github.repository }}"
          echo "- æ„å»ºæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          DEPLOY_URL: ${{ steps.deploy.outputs.DEPLOY_URL }}

      - name: ğŸ’¬ Success notification
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "================================"
          echo "âœ… åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
          echo "ğŸŒ è®¿é—®åœ°å€: https://ramusi.cn"
          echo "â±ï¸ éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${{ github.sha }}"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…:"
          echo "- ä»£ç æ£€æŸ¥: âœ… å®Œæˆ"
          echo "- é¡¹ç›®æ„å»º: âœ… æˆåŠŸ"
          echo "- æ–‡ä»¶éªŒè¯: âœ… é€šè¿‡"
          echo "- Netlify éƒ¨ç½²: âœ… æˆåŠŸ"
          echo "- å¯è®¿é—®æ€§éªŒè¯: âœ… å®Œæˆ"