name: ğŸš€ Performance Monitoring

on:
  schedule:
    - cron: "0 2 * * 0" # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æ€§èƒ½æµ‹è¯•ç±»å‹'
        required: false
        default: 'lighthouse'
        type: choice
        options:
        - 'lighthouse'
        - 'load-test'
        - 'comprehensive'

env:
  WEBSITE_URL: 'https://ramusi.cn'
  NODE_VERSION: '18.19.0'

jobs:
  # Lighthouse æ€§èƒ½æµ‹è¯•
  lighthouse-audit:
    runs-on: ubuntu-latest
    name: ğŸ’¡ Lighthouse Performance Audit
    if: github.event.inputs.test_type == 'lighthouse' || github.event.inputs.test_type == 'comprehensive' || github.event_name == 'schedule'
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Lighthouse CI
        run: |
          echo "ğŸ“¦ å®‰è£… Lighthouse CI..."
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ä»¥ç¡®ä¿ç¨³å®šæ€§
          npm install -g @lhci/cli@0.13.x
          
          # éªŒè¯å®‰è£…
          lhci --version

      - name: ğŸƒ Run Lighthouse audit
        run: |
          echo "ğŸƒ è¿è¡Œ Lighthouse å®¡è®¡..."
          
          # ç­‰å¾…ç½‘ç«™å®Œå…¨åŠ è½½
          echo "âš™ï¸ ç­‰å¾…ç½‘ç«™å‡†å¤‡å°±ç»ª..."
          sleep 10
          
          # æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§
          echo "ğŸ” æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."
          if ! curl -sSf --max-time 30 "${{ env.WEBSITE_URL }}" > /dev/null 2>&1; then
            echo "âš ï¸ ç½‘ç«™ä¸å¯è®¿é—®æˆ–å“åº”è¿‡æ…¢ï¼Œè·³è¿‡ Lighthouse æµ‹è¯•"
            # åˆ›å»ºä¸€ä¸ªç©ºçš„æŠ¥å‘Šæ–‡ä»¶
            mkdir -p .lighthouseci
            echo '{"error": "Website not accessible"}' > .lighthouseci/empty_report.json
            exit 0
          fi
          
          echo "âœ… ç½‘ç«™å¯è®¿é—®ï¼Œå¼€å§‹ Lighthouse æµ‹è¯•..."
          
          # åˆ›å»º Lighthouse é…ç½®
          cat > lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "url": ["${{ env.WEBSITE_URL }}"],
                "numberOfRuns": 1,
                "settings": {
                  "chromeFlags": ["--no-sandbox", "--disable-dev-shm-usage", "--disable-gpu"],
                  "timeout": 60000,
                  "maxWaitForLoad": 45000
                }
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0.3}],
                  "categories:accessibility": ["warn", {"minScore": 0.7}],
                  "categories:best-practices": ["warn", {"minScore": 0.6}],
                  "categories:seo": ["warn", {"minScore": 0.6}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF
          
          # è¿è¡Œ Lighthouse
          echo "ğŸš€ æ­£åœ¨è¿è¡Œ Lighthouse å®¡è®¡..."
          if lhci autorun --config=lighthouserc.json; then
            echo "âœ… Lighthouse è¿è¡ŒæˆåŠŸ"
          else
            echo "âš ï¸ Lighthouse è¿è¡Œå¤±è´¥ï¼Œä½†ä¸é˜»æ–­éƒ¨ç½²æµç¨‹"
            # åˆ›å»ºä¸€ä¸ªç©ºçš„æŠ¥å‘Šæ–‡ä»¶
            mkdir -p .lighthouseci
            echo '{"error": "Lighthouse run failed"}' > .lighthouseci/failed_report.json
          fi
        continue-on-error: true

      - name: ğŸ“Š Parse Lighthouse results
        run: |
          echo "ğŸ“Š è§£æ Lighthouse ç»“æœ..."
          
          # æ£€æŸ¥ .lighthouseci ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d ".lighthouseci" ]; then
            echo "âš ï¸ .lighthouseci ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºçš„æ‘˜è¦æŠ¥å‘Š"
            echo "## ğŸ’¡ Lighthouse æ€§èƒ½æŠ¥å‘Š" > lighthouse_summary.md
            echo "æµ‹è¯•æ—¶é—´: $(date)" >> lighthouse_summary.md
            echo "æµ‹è¯•URL: ${{ env.WEBSITE_URL }}" >> lighthouse_summary.md
            echo "" >> lighthouse_summary.md
            echo "âš ï¸ Lighthouse æµ‹è¯•æœªæˆåŠŸè¿è¡Œï¼Œå¯èƒ½çš„åŸå› ï¼š" >> lighthouse_summary.md
            echo "- ç½‘ç«™æ— æ³•è®¿é—®" >> lighthouse_summary.md
            echo "- Lighthouse CI é…ç½®é—®é¢˜" >> lighthouse_summary.md
            echo "- è¿è¡Œæ—¶ç¯å¢ƒé—®é¢˜" >> lighthouse_summary.md
            cat lighthouse_summary.md
            exit 0
          fi
          
          # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          latest_report=$(find .lighthouseci -name "*.json" | head -1)
          
          if [ -f "$latest_report" ]; then
            echo "âœ… æ‰¾åˆ° Lighthouse æŠ¥å‘Š: $latest_report"
            
            # éªŒè¯ JSON æ–‡ä»¶æ ¼å¼
            if ! jq empty "$latest_report" 2>/dev/null; then
              echo "âŒ JSON æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œåˆ›å»ºåŸºç¡€æŠ¥å‘Š"
              echo "## ğŸ’¡ Lighthouse æ€§èƒ½æŠ¥å‘Š" > lighthouse_summary.md
              echo "æµ‹è¯•æ—¶é—´: $(date)" >> lighthouse_summary.md
              echo "æµ‹è¯•URL: ${{ env.WEBSITE_URL }}" >> lighthouse_summary.md
              echo "" >> lighthouse_summary.md
              echo "âŒ æŠ¥å‘Šæ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œæ— æ³•è§£ææ€§èƒ½æ•°æ®" >> lighthouse_summary.md
              cat lighthouse_summary.md
              exit 0
            fi
            
            echo "## ğŸ’¡ Lighthouse æ€§èƒ½æŠ¥å‘Š" > lighthouse_summary.md
            echo "æµ‹è¯•æ—¶é—´: $(date)" >> lighthouse_summary.md
            echo "æµ‹è¯•URL: ${{ env.WEBSITE_URL }}" >> lighthouse_summary.md
            echo "" >> lighthouse_summary.md
            
            # å®‰å…¨åœ°æå–æ ¸å¿ƒæŒ‡æ ‡
            performance=$(cat "$latest_report" | jq '.categories.performance.score * 100 | floor' 2>/dev/null || echo "N/A")
            accessibility=$(cat "$latest_report" | jq '.categories.accessibility.score * 100 | floor' 2>/dev/null || echo "N/A")
            best_practices=$(cat "$latest_report" | jq '.categories["best-practices"].score * 100 | floor' 2>/dev/null || echo "N/A")
            seo=$(cat "$latest_report" | jq '.categories.seo.score * 100 | floor' 2>/dev/null || echo "N/A")
            
            echo "### ğŸ“ˆ æ ¸å¿ƒæŒ‡æ ‡" >> lighthouse_summary.md
            echo "- ğŸš€ æ€§èƒ½: ${performance}/100" >> lighthouse_summary.md
            echo "- â™¿ å¯è®¿é—®æ€§: ${accessibility}/100" >> lighthouse_summary.md
            echo "- âœ… æœ€ä½³å®è·µ: ${best_practices}/100" >> lighthouse_summary.md
            echo "- ğŸ” SEO: ${seo}/100" >> lighthouse_summary.md
            echo "" >> lighthouse_summary.md
            
            # å®‰å…¨åœ°æå– Web Vitals
            echo "### ğŸ¯ Core Web Vitals" >> lighthouse_summary.md
            
            fcp=$(cat "$latest_report" | jq '.audits["first-contentful-paint"].numericValue | floor' 2>/dev/null || echo "N/A")
            lcp=$(cat "$latest_report" | jq '.audits["largest-contentful-paint"].numericValue | floor' 2>/dev/null || echo "N/A")
            cls=$(cat "$latest_report" | jq '.audits["cumulative-layout-shift"].numericValue' 2>/dev/null || echo "N/A")
            
            echo "- First Contentful Paint: ${fcp}ms" >> lighthouse_summary.md
            echo "- Largest Contentful Paint: ${lcp}ms" >> lighthouse_summary.md
            echo "- Cumulative Layout Shift: ${cls}" >> lighthouse_summary.md
            
            cat lighthouse_summary.md
          else
            echo "âŒ æœªæ‰¾åˆ° Lighthouse æŠ¥å‘Šæ–‡ä»¶"
            echo "## ğŸ’¡ Lighthouse æ€§èƒ½æŠ¥å‘Š" > lighthouse_summary.md
            echo "æµ‹è¯•æ—¶é—´: $(date)" >> lighthouse_summary.md
            echo "æµ‹è¯•URL: ${{ env.WEBSITE_URL }}" >> lighthouse_summary.md
            echo "" >> lighthouse_summary.md
            echo "âŒ æœªç”Ÿæˆ Lighthouse æŠ¥å‘Šæ–‡ä»¶" >> lighthouse_summary.md
            echo "å¯èƒ½çš„åŸå› ï¼š" >> lighthouse_summary.md
            echo "- ç½‘ç«™å“åº”æ—¶é—´è¿‡é•¿" >> lighthouse_summary.md
            echo "- Lighthouse è¿è¡Œè¶…æ—¶" >> lighthouse_summary.md
            echo "- ç½‘ç»œè¿æ¥é—®é¢˜" >> lighthouse_summary.md
            cat lighthouse_summary.md
          fi
        continue-on-error: true

      - name: ğŸ“¤ Upload Lighthouse artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lighthouse_summary.md
          retention-days: 30

  # æ„å»ºæ€§èƒ½åˆ†æ
  build-performance:
    runs-on: ubuntu-latest
    name: ğŸ”§ Build Performance Analysis
    if: github.event.inputs.test_type == 'comprehensive' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit

      - name: ğŸ”§ Analyze build performance
        run: |
          echo "ğŸ”§ åˆ†ææ„å»ºæ€§èƒ½..."
          
          # ç¡®ä¿å…ˆè¿›è¡Œæ„å»º
          echo "ğŸ”¨ å…ˆè¿›è¡Œæ„å»º..."
          npm run build
          
          # è®°å½•æ„å»ºå¼€å§‹æ—¶é—´
          start_time=$(date +%s)
          
          # å†æ¬¡è¿è¡Œæ„å»ºå¹¶è®°å½•è¯¦ç»†ä¿¡æ¯
          npm run build 2>&1 | tee build_output.log
          
          # è®°å½•æ„å»ºç»“æŸæ—¶é—´
          end_time=$(date +%s)
          build_duration=$((end_time - start_time))
          
          echo "## ğŸ”§ æ„å»ºæ€§èƒ½åˆ†æ" > build_performance.md
          echo "æ„å»ºæ—¶é—´: $(date)" >> build_performance.md
          echo "æ„å»ºè€—æ—¶: ${build_duration}ç§’" >> build_performance.md
          echo "" >> build_performance.md
          
          # åˆ†ææ„å»ºäº§ç‰©å¤§å°
          if [ -d "dist" ]; then
            echo "### ğŸ“Š æ„å»ºäº§ç‰©åˆ†æ" >> build_performance.md
            echo "æ€»å¤§å°: $(du -sh dist | cut -f1)" >> build_performance.md
            echo "" >> build_performance.md
            
            echo "### ğŸ“ ä¸»è¦æ–‡ä»¶å¤§å°" >> build_performance.md
            find dist -type f -name "*.js" -o -name "*.css" | \
            while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "- $(basename "$file"): $size" >> build_performance.md
            done
            
            # æ£€æŸ¥å¤§æ–‡ä»¶
            echo "" >> build_performance.md
            echo "### âš ï¸ å¤§æ–‡ä»¶è­¦å‘Š (>100KB)" >> build_performance.md
            find dist -type f -size +100k | \
            while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "- $(basename "$file"): $size" >> build_performance.md
            done || echo "æ— å¤§æ–‡ä»¶" >> build_performance.md
          fi
          
          cat build_performance.md

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "ğŸ“Š è¿è¡Œ bundle åˆ†æ..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ dist ç›®å½•
          if [ ! -d "dist" ]; then
            echo "âš ï¸ dist ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ bundle åˆ†æ"
            echo "### ğŸ“ Bundle åˆ†æ" >> build_performance.md
            echo "è·³è¿‡ bundle åˆ†æ - dist ç›®å½•ä¸å­˜åœ¨" >> build_performance.md
            exit 0
          fi
          
          # å®‰è£…åˆ†æå·¥å…·ï¼ˆä½¿ç”¨æ›´ç¨³å®šçš„å·¥å…·ï¼‰
          npm install --no-save webpack-bundle-analyzer || {
            echo "âš ï¸ bundle åˆ†æå·¥å…·å®‰è£…å¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
            echo "### ğŸ“ Bundle åˆ†æ" >> build_performance.md
            echo "è·³è¿‡ bundle åˆ†æ - å·¥å…·å®‰è£…å¤±è´¥" >> build_performance.md
            exit 0
          }
          
          echo "### ğŸ“¦ Bundle åˆ†æ" >> build_performance.md
          echo "Bundle åˆ†æå·²å®Œæˆ" >> build_performance.md

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-performance
          path: |
            build_performance.md
            build_output.log
            bundle-analysis.json
          retention-days: 30

  # è´Ÿè½½æµ‹è¯•
  load-test:
    runs-on: ubuntu-latest
    name: ğŸ”¥ Load Testing
    if: github.event.inputs.test_type == 'load-test' || github.event.inputs.test_type == 'comprehensive'
    steps:
      - name: ğŸ”¥ Run load test
        run: |
          echo "ğŸ”¥ è¿è¡Œè´Ÿè½½æµ‹è¯•..."
          
          # ä½¿ç”¨ Apache Bench è¿›è¡Œç®€å•è´Ÿè½½æµ‹è¯•
          echo "å®‰è£…æµ‹è¯•å·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y apache2-utils
          
          echo "## ğŸ”¥ è´Ÿè½½æµ‹è¯•æŠ¥å‘Š" > load_test.md
          echo "æµ‹è¯•æ—¶é—´: $(date)" >> load_test.md
          echo "æµ‹è¯•ç›®æ ‡: ${{ env.WEBSITE_URL }}" >> load_test.md
          echo "" >> load_test.md
          
          # å¹¶å‘æµ‹è¯• - 10ä¸ªå¹¶å‘ç”¨æˆ·ï¼Œ100ä¸ªè¯·æ±‚
          echo "### ğŸ“Š å¹¶å‘æµ‹è¯• (10å¹¶å‘, 100è¯·æ±‚)" >> load_test.md
          ab -n 100 -c 10 -g load_test_data.tsv ${{ env.WEBSITE_URL }}/ > load_test_output.txt 2>&1
          
          # æå–å…³é”®æŒ‡æ ‡
          if [ -f "load_test_output.txt" ]; then
            requests_per_second=$(grep "Requests per second" load_test_output.txt | cut -d: -f2 | xargs)
            time_per_request=$(grep "Time per request" load_test_output.txt | head -1 | cut -d: -f2 | xargs)
            failed_requests=$(grep "Failed requests" load_test_output.txt | cut -d: -f2 | xargs)
            
            echo "- æ¯ç§’è¯·æ±‚æ•°: $requests_per_second" >> load_test.md
            echo "- å¹³å‡è¯·æ±‚æ—¶é—´: $time_per_request" >> load_test.md
            echo "- å¤±è´¥è¯·æ±‚æ•°: $failed_requests" >> load_test.md
          fi
          
          echo "" >> load_test.md
          echo "### ğŸ“ˆ æ€§èƒ½åŸºå‡†" >> load_test.md
          echo "- âœ… ä¼˜ç§€: >50 req/sec" >> load_test.md
          echo "- âš ï¸ ä¸€èˆ¬: 20-50 req/sec" >> load_test.md
          echo "- âŒ éœ€ä¼˜åŒ–: <20 req/sec" >> load_test.md
          
          cat load_test.md

      - name: ğŸ“¤ Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            load_test.md
            load_test_output.txt
            load_test_data.tsv
          retention-days: 30

  # æ€§èƒ½ç›‘æ§æ€»ç»“
  performance-summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Performance Summary
    needs: [lighthouse-audit, build-performance, load-test]
    if: always()
    steps:
      - name: ğŸ“Š Generate performance summary
        run: |
          echo "ğŸ“Š æ€§èƒ½ç›‘æ§æ€»ç»“æŠ¥å‘Š"
          echo "=================================="
          echo "ç›‘æ§æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo ""
          
          # Lighthouse ç»“æœ
          if [ "${{ needs.lighthouse-audit.result }}" = "success" ]; then
            echo "âœ… Lighthouse å®¡è®¡: å®Œæˆ"
          elif [ "${{ needs.lighthouse-audit.result }}" = "failure" ]; then
            echo "âŒ Lighthouse å®¡è®¡: å¤±è´¥"
          else
            echo "â­ï¸ Lighthouse å®¡è®¡: è·³è¿‡"
          fi
          
          # æ„å»ºæ€§èƒ½ç»“æœ
          if [ "${{ needs.build-performance.result }}" = "success" ]; then
            echo "âœ… æ„å»ºæ€§èƒ½åˆ†æ: å®Œæˆ"
          elif [ "${{ needs.build-performance.result }}" = "failure" ]; then
            echo "âŒ æ„å»ºæ€§èƒ½åˆ†æ: å¤±è´¥"
          else
            echo "â­ï¸ æ„å»ºæ€§èƒ½åˆ†æ: è·³è¿‡"
          fi
          
          # è´Ÿè½½æµ‹è¯•ç»“æœ
          if [ "${{ needs.load-test.result }}" = "success" ]; then
            echo "âœ… è´Ÿè½½æµ‹è¯•: å®Œæˆ"
          elif [ "${{ needs.load-test.result }}" = "failure" ]; then
            echo "âŒ è´Ÿè½½æµ‹è¯•: å¤±è´¥"
          else
            echo "â­ï¸ è´Ÿè½½æµ‹è¯•: è·³è¿‡"
          fi
          
          echo ""
          echo "ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®:"
          echo "- å®šæœŸç›‘æ§ Core Web Vitals"
          echo "- ä¼˜åŒ–å¤§æ–‡ä»¶å’Œèµ„æºåŠ è½½"
          echo "- å®æ–½ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½"
          echo "- ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº"
          echo "- ç›‘æ§æ„å»ºæ—¶é—´å’Œäº§ç‰©å¤§å°"
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "- ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo "- å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- é¡¹ç›®: ${{ github.server_url }}/${{ github.repository }}"