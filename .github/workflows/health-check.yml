name: ğŸ¥ Website Health Monitor

on:
  schedule:
    - cron: "0 0 * * 1" # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œ
  workflow_dispatch:

env:
  WEBSITE_URL: 'https://ramusi.cn'
  TIMEOUT: 30

jobs:
  # åŸºæœ¬å¥åº·æ£€æŸ¥
  basic-health-check:
    runs-on: ubuntu-latest
    name: ğŸ” Basic Health Check
    steps:
      - name: ğŸŒ Check website accessibility
        run: |
          echo "ğŸ” æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."
          echo "ç›®æ ‡URL: ${{ env.WEBSITE_URL }}"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time ${{ env.TIMEOUT }} "${{ env.WEBSITE_URL }}")
          
          echo "å“åº”çŠ¶æ€ç : $response"
          
          if [ "$response" = "200" ]; then
            echo "âœ… ç½‘ç«™æ­£å¸¸è®¿é—® (HTTP $response)"
          else
            echo "âŒ ç½‘ç«™è®¿é—®å¼‚å¸¸ (HTTP $response)"
            echo "å°è¯•è¯¦ç»†è¯Šæ–­..."
            curl -v --connect-timeout 10 --max-time ${{ env.TIMEOUT }} "${{ env.WEBSITE_URL }}" || true
            exit 1
          fi

      - name: ğŸ“„ Check page content
        run: |
          echo "ğŸ” æ£€æŸ¥é¡µé¢å†…å®¹..."
          
          # è·å–é¡µé¢å†…å®¹
          content=$(curl -s --connect-timeout 10 --max-time ${{ env.TIMEOUT }} "${{ env.WEBSITE_URL }}")
          
          if [ -z "$content" ]; then
            echo "âŒ æ— æ³•è·å–é¡µé¢å†…å®¹"
            exit 1
          fi
          
          # æ£€æŸ¥åŸºæœ¬ HTML ç»“æ„
          if echo "$content" | grep -q "<!doctype html>\|<!DOCTYPE html>"; then
            echo "âœ… HTMLç»“æ„æ­£å¸¸"
          else
            echo "âŒ HTMLç»“æ„å¼‚å¸¸"
            echo "é¡µé¢å†…å®¹é¢„è§ˆ: $(echo "$content" | head -n 5)"
            exit 1
          fi
          
          # æ£€æŸ¥ç½‘ç«™æ ‡é¢˜æˆ–å…³é”®å†…å®¹
          if echo "$content" | grep -qi "ramusi\|tools\|navigation"; then
            echo "âœ… ç½‘ç«™å…³é”®å†…å®¹æ­£å¸¸"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„æœŸçš„å…³é”®å†…å®¹"
            echo "é¡µé¢æ ‡é¢˜: $(echo "$content" | grep -o '<title[^>]*>[^<]*</title>' | head -1)"
          fi

      - name: âš¡ Performance check
        run: |
          echo "âš¡ æ£€æŸ¥ç½‘ç«™æ€§èƒ½..."
          
          # æµ‹é‡å“åº”æ—¶é—´
          start_time=$(date +%s%3N)
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time ${{ env.TIMEOUT }} "${{ env.WEBSITE_URL }}")
          end_time=$(date +%s%3N)
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ æ€§èƒ½æ£€æŸ¥å¤±è´¥ï¼Œç½‘ç«™ä¸å¯è®¿é—® (HTTP $http_code)"
            exit 1
          fi
          
          duration=$((end_time - start_time))
          
          echo "å“åº”æ—¶é—´: ${duration}ms"
          
          if [ $duration -lt 3000 ]; then
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸ (${duration}ms < 3000ms)"
          elif [ $duration -lt 5000 ]; then
            echo "âš ï¸ å“åº”æ—¶é—´è¾ƒæ…¢ (${duration}ms)"
          else
            echo "âš ï¸ å“åº”æ—¶é—´è¿‡æ…¢ (${duration}ms)"
            # ä¸å°†æ€§èƒ½é—®é¢˜ä½œä¸ºå¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
          fi

  # å¥åº·æ£€æŸ¥æ€»ç»“
  health-summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Health Check Summary
    needs: [basic-health-check]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "ğŸ“Š å¥åº·æ£€æŸ¥æ€»ç»“æŠ¥å‘Š"
          echo "==========================================="
          echo "æ£€æŸ¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo ""
          
          # æ£€æŸ¥åŸºæœ¬å¥åº·æ£€æŸ¥ç»“æœ
          if [ "${{ needs.basic-health-check.result }}" = "success" ]; then
            echo "âœ… åŸºæœ¬å¥åº·æ£€æŸ¥: é€šè¿‡"
            echo "  - âœ… ç½‘ç«™å¯è®¿é—®æ€§: æ­£å¸¸"
            echo "  - âœ… é¡µé¢å†…å®¹: æ­£å¸¸"
            echo "  - âœ… æ€§èƒ½æ£€æŸ¥: æ­£å¸¸"
          else
            echo "âŒ åŸºæœ¬å¥åº·æ£€æŸ¥: å¤±è´¥"
            echo "  è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—"
          fi
          
          echo ""
          echo "ğŸ“ˆ ç›‘æ§å»ºè®®:"
          echo "  - å®šæœŸæ£€æŸ¥ç½‘ç«™å¯ç”¨æ€§"
          echo "  - ç›‘æ§å“åº”æ—¶é—´å˜åŒ–"
          echo "  - å…³æ³¨é”™è¯¯æ—¥å¿—"
          echo "  - å¤‡ä»½é‡è¦æ•°æ®"
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo "  - GitHub: https://github.com/jiayuwee/advanced-tools-navigation"
          echo "  - å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸš¨ Alert on failure
        if: needs.basic-health-check.result == 'failure'
        run: |
          echo "ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥å‘Šè­¦"
          echo "==========================================="
          echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo "çŠ¶æ€: å¼‚å¸¸"
          echo "å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "è¯·ç«‹å³æ£€æŸ¥ç½‘ç«™çŠ¶æ€å¹¶é‡‡å–ç›¸åº”æªæ–½ã€‚"
