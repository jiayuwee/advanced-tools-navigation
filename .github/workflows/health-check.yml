name: Health Check

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
    - cron: '0 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: System Health Check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Clean npm artifacts
        run: npm run clean
      - name: Install dependencies
      
        run: npm run monitor:health
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`
            const body = `
            ## ğŸš¨ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥

            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
            **å·¥ä½œæµ**: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### ğŸ“‹ æ£€æŸ¥é¡¹ç›®
            - ç½‘ç«™å¯è®¿é—®æ€§
            - GitHub Actions çŠ¶æ€  
            - Supabase æ•°æ®åº“è¿æ¥

            ### ğŸ”§ å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®: https://ramusi.cn
            2. æŸ¥çœ‹ GitHub Actions å·¥ä½œæµçŠ¶æ€
            3. æ£€æŸ¥ Supabase é¡¹ç›®çŠ¶æ€
            4. æŸ¥çœ‹ Netlify éƒ¨ç½²æ—¥å¿—

            ### ğŸ”— æœ‰ç”¨çš„é“¾æ¥
            - ğŸŒ [ç½‘ç«™](https://ramusi.cn)
            - ğŸ“Š [GitHub Actions](https://github.com/jiayuwee/advanced-tools-navigation/actions)
            - ğŸ“¦ [Netlify æ§åˆ¶å°](https://app.netlify.com/sites/spiffy-torrone-5454e1/deploys)
            - ğŸ—„ï¸ [Supabase æ§åˆ¶å°](https://supabase.com/dashboard/project/ndmxwdejswybvbwrxsai)

            ---
            *æ­¤é—®é¢˜ç”±è‡ªåŠ¨å¥åº·æ£€æŸ¥ç³»ç»Ÿåˆ›å»º*
            `

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é—®é¢˜
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,automated'
            })

            const existingIssue = issues.find(issue => 
              issue.title.includes('ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥') && 
              issue.title.includes(new Date().toISOString().split('T')[0])
            )

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'automated', 'bug']
              })
              console.log('å·²åˆ›å»ºå¥åº·æ£€æŸ¥å¤±è´¥é—®é¢˜')
            } else {
              console.log('ä»Šæ—¥å·²å­˜åœ¨å¥åº·æ£€æŸ¥å¤±è´¥é—®é¢˜ï¼Œè·³è¿‡åˆ›å»º')
            }

  # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ°å…¶ä»–å¹³å°
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: health-check
    if: failure()
    name: Send Failure Notification
    
    steps:
      - name: Send notification
        run: |
          echo "ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥é€šçŸ¥"
          echo "æ—¶é—´: $(date)"
          echo "å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘é€é‚®ä»¶ã€Slack æˆ–å…¶ä»–é€šçŸ¥çš„é€»è¾‘"
          echo "å·¥ä½œæµé“¾æ¥: https://github.com/jiayuwee/advanced-tools-navigation/actions/runs/${{ github.run_id }}"
