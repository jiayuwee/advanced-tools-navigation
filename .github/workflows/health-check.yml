name: ğŸ¥ Website Health Monitor

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: "0 8 * * 1" # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œå®Œæ•´æ£€æŸ¥
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'basic'
        type: choice
        options:
        - 'basic'
        - 'comprehensive'

env:
  WEBSITE_URL: 'https://ramusi.cn'
  TIMEOUT: 30

jobs:
  # åŸºæœ¬å¥åº·æ£€æŸ¥
  basic-health-check:
    runs-on: ubuntu-latest
    name: ğŸ” Basic Health Check
    steps:
      - name: ğŸŒ Check website accessibility
        run: |
          echo "ğŸ” æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."
          echo "ç›®æ ‡URL: ${{ env.WEBSITE_URL }}"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time ${{ env.TIMEOUT }} ${{ env.WEBSITE_URL }})
          
          if [ "$response" = "200" ]; then
            echo "âœ… ç½‘ç«™æ­£å¸¸è®¿é—® (HTTP $response)"
          else
            echo "âŒ ç½‘ç«™è®¿é—®å¼‚å¸¸ (HTTP $response)"
            exit 1
          fi

      - name: ğŸ“„ Check page content
        run: |
          echo "ğŸ” æ£€æŸ¥é¡µé¢å†…å®¹..."
          content=$(curl -s --max-time ${{ env.TIMEOUT }} ${{ env.WEBSITE_URL }})
          
          # æ£€æŸ¥å…³é”®å†…å®¹
          if echo "$content" | grep -q "Ramusi"; then
            echo "âœ… ç½‘ç«™æ ‡é¢˜æ­£å¸¸"
          else
            echo "âŒ ç½‘ç«™æ ‡é¢˜ç¼ºå¤±"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯ï¼ˆåŸºæœ¬æ£€æŸ¥ï¼‰
          if echo "$content" | grep -q "<!DOCTYPE html>"; then
            echo "âœ… HTMLç»“æ„æ­£å¸¸"
          else
            echo "âŒ HTMLç»“æ„å¼‚å¸¸"
            exit 1
          fi

      - name: âš¡ Performance check
        run: |
          echo "âš¡ æ£€æŸ¥ç½‘ç«™æ€§èƒ½..."
          
          # æµ‹é‡å“åº”æ—¶é—´
          start_time=$(date +%s%N)
          curl -s --max-time ${{ env.TIMEOUT }} ${{ env.WEBSITE_URL }} > /dev/null
          end_time=$(date +%s%N)
          
          duration=$(( (end_time - start_time) / 1000000 )) # è½¬æ¢ä¸ºæ¯«ç§’
          
          echo "å“åº”æ—¶é—´: ${duration}ms"
          
          if [ $duration -lt 3000 ]; then
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸ (${duration}ms < 3000ms)"
          elif [ $duration -lt 5000 ]; then
            echo "âš ï¸ å“åº”æ—¶é—´è¾ƒæ…¢ (${duration}ms)"
          else
            echo "âŒ å“åº”æ—¶é—´è¿‡æ…¢ (${duration}ms)"
            exit 1
          fi

  # å…¨é¢å¥åº·æ£€æŸ¥ï¼ˆå‘¨æœŸæ€§æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
  comprehensive-health-check:
    runs-on: ubuntu-latest
    name: ğŸ”¬ Comprehensive Health Check
    if: github.event_name == 'schedule' && github.event.schedule == '0 8 * * 1' || github.event.inputs.check_type == 'comprehensive'
    steps:
      - name: ğŸŒ Multi-endpoint check
        run: |
          echo "ğŸ” æ£€æŸ¥å¤šä¸ªç«¯ç‚¹..."
          
          # å®šä¹‰è¦æ£€æŸ¥çš„ç«¯ç‚¹
          endpoints=(
            "${{ env.WEBSITE_URL }}"
            "${{ env.WEBSITE_URL }}/tools"
            "${{ env.WEBSITE_URL }}/products"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "æ£€æŸ¥: $endpoint"
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time ${{ env.TIMEOUT }} "$endpoint")
            
            if [ "$response" = "200" ]; then
              echo "âœ… $endpoint æ­£å¸¸ (HTTP $response)"
            else
              echo "âŒ $endpoint å¼‚å¸¸ (HTTP $response)"
              exit 1
            fi
          done

      - name: ğŸ”’ Security headers check
        run: |
          echo "ğŸ”’ æ£€æŸ¥å®‰å…¨å¤´..."
          
          headers=$(curl -s -I --max-time ${{ env.TIMEOUT }} ${{ env.WEBSITE_URL }})
          
          # æ£€æŸ¥é‡è¦çš„å®‰å…¨å¤´
          if echo "$headers" | grep -qi "x-frame-options\|content-security-policy"; then
            echo "âœ… å‘ç°å®‰å…¨å¤´é…ç½®"
          else
            echo "âš ï¸ æœªå‘ç°æ˜æ˜¾çš„å®‰å…¨å¤´é…ç½®"
          fi
          
          # æ£€æŸ¥HTTPSé‡å®šå‘
          http_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time ${{ env.TIMEOUT }} "http://ramusi.cn" || echo "000")
          if [ "$http_response" = "301" ] || [ "$http_response" = "302" ]; then
            echo "âœ… HTTPé‡å®šå‘åˆ°HTTPSæ­£å¸¸"
          else
            echo "âš ï¸ HTTPé‡å®šå‘çŠ¶æ€: $http_response"
          fi

      - name: ğŸ“± Mobile responsiveness check
        run: |
          echo "ğŸ“± æ£€æŸ¥ç§»åŠ¨ç«¯å“åº”..."
          
          # æ¨¡æ‹Ÿç§»åŠ¨ç«¯User-Agent
          mobile_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time ${{ env.TIMEOUT }} \
            -H "User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15" \
            ${{ env.WEBSITE_URL }})
          
          if [ "$mobile_response" = "200" ]; then
            echo "âœ… ç§»åŠ¨ç«¯è®¿é—®æ­£å¸¸ (HTTP $mobile_response)"
          else
            echo "âŒ ç§»åŠ¨ç«¯è®¿é—®å¼‚å¸¸ (HTTP $mobile_response)"
            exit 1
          fi

  # å¥åº·æ£€æŸ¥æ€»ç»“
  health-summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Health Check Summary
    needs: [basic-health-check]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "ğŸ“Š å¥åº·æ£€æŸ¥æ€»ç»“æŠ¥å‘Š"
          echo "==========================================="
          echo "æ£€æŸ¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo ""
          
          # æ£€æŸ¥åŸºæœ¬å¥åº·æ£€æŸ¥ç»“æœ
          if [ "${{ needs.basic-health-check.result }}" = "success" ]; then
            echo "âœ… åŸºæœ¬å¥åº·æ£€æŸ¥: é€šè¿‡"
            echo "  - âœ… ç½‘ç«™å¯è®¿é—®æ€§: æ­£å¸¸"
            echo "  - âœ… é¡µé¢å†…å®¹: æ­£å¸¸"
            echo "  - âœ… æ€§èƒ½æ£€æŸ¥: æ­£å¸¸"
          else
            echo "âŒ åŸºæœ¬å¥åº·æ£€æŸ¥: å¤±è´¥"
            echo "  è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—"
          fi
          
          echo ""
          echo "ğŸ“ˆ ç›‘æ§å»ºè®®:"
          echo "  - å®šæœŸæ£€æŸ¥ç½‘ç«™å¯ç”¨æ€§"
          echo "  - ç›‘æ§å“åº”æ—¶é—´å˜åŒ–"
          echo "  - å…³æ³¨é”™è¯¯æ—¥å¿—"
          echo "  - å¤‡ä»½é‡è¦æ•°æ®"
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo "  - GitHub: https://github.com/jiayuwee/advanced-tools-navigation"
          echo "  - å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸš¨ Alert on failure
        if: needs.basic-health-check.result == 'failure'
        run: |
          echo "ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥å‘Šè­¦"
          echo "==========================================="
          echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç½‘ç«™: ${{ env.WEBSITE_URL }}"
          echo "çŠ¶æ€: å¼‚å¸¸"
          echo "å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "è¯·ç«‹å³æ£€æŸ¥ç½‘ç«™çŠ¶æ€å¹¶é‡‡å–ç›¸åº”æªæ–½ã€‚"
