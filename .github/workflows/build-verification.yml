name: ğŸ”¨ Build & Quality Verification

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: 'v2'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Code Quality Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          # æ¸…ç†ç¼“å­˜ä»¥é¿å…å¹³å°å…¼å®¹æ€§é—®é¢˜
          npm cache clean --force || true
          
          # å°è¯•æ ‡å‡†å®‰è£…
          if npm ci --prefer-offline --no-audit --ignore-scripts; then
            echo "âœ… æ ‡å‡†å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ æ ‡å‡†å®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ..."
            
            # åˆ é™¤ node_modules å’Œ package-lock.json
            rm -rf node_modules package-lock.json
            
            # é‡æ–°ç”Ÿæˆ package-lock.json å¹¶å®‰è£…
            npm install --prefer-offline --no-audit --ignore-scripts
            echo "âœ… æ›¿ä»£å®‰è£…æ–¹æ¡ˆå®Œæˆ"
          fi
          
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…æ•°é‡: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"

      - name: ğŸ” ESLint Check
        run: |
          echo "ğŸ” è¿è¡Œ ESLint æ£€æŸ¥..."
          npm run lint
          echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

      - name: ğŸ”§ TypeScript Type Check
        run: |
          echo "ğŸ”§ è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
          npm run type-check
          echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"

  # æµ‹è¯•æ‰§è¡Œ
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Run Tests
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          # æ¸…ç†ç¼“å­˜ä»¥é¿å…å¹³å°å…¼å®¹æ€§é—®é¢˜
          npm cache clean --force || true
          
          # å°è¯•æ ‡å‡†å®‰è£…
          if npm ci --prefer-offline --no-audit --ignore-scripts; then
            echo "âœ… æ ‡å‡†å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ æ ‡å‡†å®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ..."
            
            # åˆ é™¤ node_modules å’Œ package-lock.json
            rm -rf node_modules package-lock.json
            
            # é‡æ–°ç”Ÿæˆ package-lock.json å¹¶å®‰è£…
            npm install --prefer-offline --no-audit --ignore-scripts
            echo "âœ… æ›¿ä»£å®‰è£…æ–¹æ¡ˆå®Œæˆ"
          fi
          
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…æ•°é‡: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"

      - name: ğŸ§ª Run unit tests
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          npm run test:run
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

      - name: ğŸ“Š Generate test coverage
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
          npm run test:coverage
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

  # æ„å»ºéªŒè¯
  build-verification:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build Verification
    needs: [code-quality, test]
    strategy:
      matrix:
        node-version: ['20.x']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (Node.js ${{ matrix.node-version }})..."
          # æ¸…ç†ç¼“å­˜ä»¥é¿å…å¹³å°å…¼å®¹æ€§é—®é¢˜
          npm cache clean --force || true
          
          # å°è¯•æ ‡å‡†å®‰è£…
          if npm ci --prefer-offline --no-audit --ignore-scripts; then
            echo "âœ… æ ‡å‡†å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ æ ‡å‡†å®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ..."
            
            # åˆ é™¤ node_modules å’Œ package-lock.json
            rm -rf node_modules package-lock.json
            
            # é‡æ–°ç”Ÿæˆ package-lock.json å¹¶å®‰è£…
            npm install --prefer-offline --no-audit --ignore-scripts
            echo "âœ… æ›¿ä»£å®‰è£…æ–¹æ¡ˆå®Œæˆ"
          fi
          
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…æ•°é‡: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo 'æœªçŸ¥')"

      - name: ğŸ”¨ Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NODE_ENV: production

      - name: ğŸ” Verify build output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºæˆåŠŸéªŒè¯"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          du -sh dist/
          echo "ğŸ“ ä¸»è¦æ–‡ä»¶:"
          find dist -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | xargs ls -lh

      - name: ğŸ“¤ Upload build artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # å®‰å…¨æ€§æ£€æŸ¥
  security-check:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡..."
          npm audit --audit-level moderate
          echo "âœ… å®‰å…¨å®¡è®¡å®Œæˆ"

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    runs-on: ubuntu-latest
    name: ğŸš€ Deployment Notification
    needs: [build-verification, security-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸš€ Deployment notification
        run: |
          echo "ğŸš€ ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ“¦ Netlify å°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤æ¬¡æ„å»º" 
          echo "â±ï¸ éƒ¨ç½²é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿ"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://ramusi.cn"
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç­‰å¾… Netlify éƒ¨ç½²..."
          echo "ğŸ“Š æ„å»ºæ‘˜è¦:"
          echo "  - âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          echo "  - âœ… æµ‹è¯•æ‰§è¡Œé€šè¿‡"
          echo "  - âœ… æ„å»ºéªŒè¯é€šè¿‡"
          echo "  - âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
