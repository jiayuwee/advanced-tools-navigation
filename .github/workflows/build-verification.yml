name: Build Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-verification:
    runs-on: ubuntu-latest
    name: Build Verification
    steps:
      - name: Manual checkout
        run: |
          echo "ğŸ”„ æ‰‹åŠ¨æ£€å‡ºä»£ç ..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"

          # ä½¿ç”¨ curl ä¸‹è½½æºç 
          echo "ä¸‹è½½æºç å‹ç¼©åŒ…..."
          curl -L -o source.zip "https://github.com/jiayuwee/advanced-tools-navigation/archive/${{ github.sha }}.zip"

          # è§£å‹æºç 
          echo "è§£å‹æºç ..."
          unzip -q source.zip

          # ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
          echo "ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç›®å½•..."
          mv advanced-tools-navigation-*/* .
          mv advanced-tools-navigation-*/.[^.]* . 2>/dev/null || true

          # æ¸…ç†
          rm -rf advanced-tools-navigation-* source.zip

          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la

      - name: Setup Node.js
        run: |
          echo "ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ..."
          node --version
          npm --version

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          echo "æ£€æŸ¥ package.json..."
          if [ -f "package.json" ]; then
            echo "package.json å­˜åœ¨ï¼Œå¼€å§‹å®‰è£…ä¾èµ–..."
            echo "æ¸…ç†npmç¼“å­˜..."
            npm cache clean --force
            echo "å®‰è£…ä¾èµ–ï¼ˆè·³è¿‡å¯é€‰ä¾èµ–å’Œå¹³å°ç‰¹å®šä¾èµ–ï¼‰..."
            npm install --prefer-offline --no-audit --no-optional --ignore-platform
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          else
            echo "âŒ package.json ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Build project
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡..."
          echo "VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:0:20}..."
          echo "VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY:+å·²è®¾ç½®}"
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NODE_ENV: production

      - name: Verify build output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          ls -la dist/
          if [ -f "dist/index.html" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ - index.html å­˜åœ¨"
            echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
            du -sh dist/
            echo "ğŸ“ ä¸»è¦æ–‡ä»¶:"
            ls -lh dist/assets/ | head -10
          else
            echo "âŒ æ„å»ºå¤±è´¥ - index.html ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Deployment notification
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸš€ ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ“¦ Netlify å°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤æ¬¡æ„å»º" 
          echo "â±ï¸ éƒ¨ç½²é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿ"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://ramusi.cn"
          echo "âœ… æ„å»ºéªŒè¯é€šè¿‡ï¼Œç­‰å¾… Netlify éƒ¨ç½²..."
