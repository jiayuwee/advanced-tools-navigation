var e=Object.defineProperty,t=(t,a,o)=>((t,a,o)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o)(t,"symbol"!=typeof a?a+"":a,o);import{b as a,d as o,r as s,c as r,o as i,m as l,q as c,t as n,y as u,E as d,u as v,G as m,I as p,B as h,D as g,P as f,F as y,z as _,O as w,v as b,x as T,H as S,A as k}from"./vendor-C7R90qIp.js";import{s as x,T as E,r as O,p as C,u as I,a as A,X as q,_ as z}from"./index-C3iyAWwk.js";import{P as R}from"./plus-DreYiqzn.js";import{R as F}from"./refresh-cw-CTRI4460.js";import{P}from"./pen-square-CV5RR6O3.js";import{T as U}from"./trash-BmCSH32Q.js";import{E as L}from"./eye-C1GTx_f1.js";import{E as $}from"./eye-off-s4-oKaSz.js";class V{constructor(e={}){t(this,"cache",a(new Map)),t(this,"options"),t(this,"defaultOptions",{maxAge:3e5,maxSize:100,version:"1.0.0",serialize:!1,prefix:"app_cache_"}),this.options={...this.defaultOptions,...e},this.options.serialize&&this.loadFromStorage(),this.startCleanupTimer()}set(e,t,a){const o=Date.now(),s={data:t,timestamp:o,expiry:o+(a||this.options.maxAge),version:this.options.version,hits:0,lastAccessed:o};this.cache.size>=this.options.maxSize&&this.evictLeastRecentlyUsed(),this.cache.set(e,s),this.options.serialize&&this.saveToStorage(e,s)}get(e){const t=this.cache.get(e);if(!t)return null;const a=Date.now();return a>t.expiry||t.version!==this.options.version?(this.delete(e),null):(t.hits++,t.lastAccessed=a,t.data)}delete(e){const t=this.cache.delete(e);return t&&this.options.serialize&&this.removeFromStorage(e),t}has(e){return null!==this.get(e)}clear(){this.cache.clear(),this.options.serialize&&this.clearStorage()}getStats(){const e=Date.now();let t=0,a=0,o=0;for(const[,s]of this.cache)t+=s.hits,e>s.expiry?o++:a++;return{totalItems:this.cache.size,validItems:a,expiredItems:o,totalHits:t,hitRate:t>0?t/this.cache.size:0,memoryUsage:this.estimateMemoryUsage()}}refreshVersion(e){this.options.version=e,this.clear()}evictLeastRecentlyUsed(){let e="",t=Date.now();for(const[a,o]of this.cache)o.lastAccessed<t&&(t=o.lastAccessed,e=a);e&&this.delete(e)}cleanup(){const e=Date.now(),t=[];for(const[a,o]of this.cache)(e>o.expiry||o.version!==this.options.version)&&t.push(a);t.forEach(e=>this.delete(e))}startCleanupTimer(){setInterval(()=>{this.cleanup()},6e4)}estimateMemoryUsage(){let e=0;for(const[t,a]of this.cache)e+=2*t.length,e+=2*JSON.stringify(a).length;return e}saveToStorage(e,t){try{const a=this.options.prefix+e;localStorage.setItem(a,JSON.stringify(t))}catch(a){console.warn("保存缓存到 localStorage 失败:",a)}}loadFromStorage(){try{const e=this.options.prefix;for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);if(null==a?void 0:a.startsWith(e)){const t=a.slice(e.length),o=localStorage.getItem(a);if(o){const e=JSON.parse(o);Date.now()<=e.expiry&&e.version===this.options.version?this.cache.set(t,e):localStorage.removeItem(a)}}}}catch(e){console.warn("从 localStorage 加载缓存失败:",e)}}removeFromStorage(e){try{const t=this.options.prefix+e;localStorage.removeItem(t)}catch(t){console.warn("从 localStorage 删除缓存失败:",t)}}clearStorage(){try{const e=this.options.prefix,t=[];for(let a=0;a<localStorage.length;a++){const o=localStorage.key(a);(null==o?void 0:o.startsWith(e))&&t.push(o)}t.forEach(e=>localStorage.removeItem(e))}catch(e){console.warn("清空 localStorage 缓存失败:",e)}}}const j=new V({maxAge:3e5,maxSize:100,serialize:!0,prefix:"advanced_tools_"});new V({maxAge:18e5,maxSize:50,serialize:!1,prefix:"img_cache_"});const D=new V({maxAge:18e4,maxSize:200,serialize:!0,prefix:"api_cache_"});function M(e,t,a=j,o){return async(...s)=>{const r="function"==typeof t?t(...s):t,i=a.get(r);if(null!==i)return i;const l=await e(...s);return a.set(r,l,o),l}}function N(e){var t;return(null==(t=e.category)?void 0:t.id)?e.category.id:e.categoryId?e.categoryId:e.category_id?e.category_id:null}const J="active";class B{static async getTools(e){const t=`tools_${JSON.stringify(e||{})}`;return M(this._getToolsFromAPI.bind(this),()=>t,D,12e4)(e)}static async _getToolsFromAPI(e){try{let t=x.from(E.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",J);(null==e?void 0:e.query)&&(t=t.or(`name.ilike.%${e.query}%,description.ilike.%${e.query}%`)),(null==e?void 0:e.category)&&"all"!==e.category&&(t=t.eq("category_id",e.category));const a=(null==e?void 0:e.sortBy)||"sort_order",o=(null==e?void 0:e.sortOrder)||"asc";t=t.order(a,{ascending:"asc"===o});const s=(null==e?void 0:e.page)||1,r=(null==e?void 0:e.limit)||20,i=(s-1)*r;t=t.range(i,i+r-1);const{data:l,error:c,count:n}=await t;if(c)throw new Error(O(c));return{items:(l||[]).map(this.transformToolRow),total:n||0,page:s,limit:r,hasMore:(n||0)>i+r}}catch(t){const e=C.handleApiError(t);throw C.logError(e,"ToolsService.getTools"),e}}static async getTool(e){const t=`tool_${e}`;return M(this._getToolFromAPI.bind(this),()=>t,D,3e5)(e)}static async _getToolFromAPI(e){try{const{data:t,error:a}=await x.from(E.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("id",e).single();if(a)throw new Error(O(a));return this.transformToolRow(t)}catch(t){const e=C.handleApiError(t);throw C.logError(e,"ToolsService.getTool"),e}}static async createTool(e){try{!function(e,t,a="Entity"){const o=[];for(const s of t)e[s]||o.push(s);if(o.length>0)throw new Error(`${a} validation failed: missing required fields: ${o.join(", ")}`)}(e,["name","description","url"],"Tool");const t=function(e,t="Category"){const a=N(e);if(!a)throw new Error(`${t} is required`);return a}(e),{data:a,error:o}=await x.from(E.TOOLS).insert({name:e.name,description:e.description,url:e.url,category_id:t,icon:e.icon,is_featured:e.is_featured||!1,status:J,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order||0}).select("\n          *,\n          category:categories(*)\n        ").single();if(o)throw new Error(O(o));const s=this.transformToolRow(a);return this.clearRelatedCache(),s}catch(t){const e=C.handleApiError(t);throw C.logError(e,"ToolsService.createTool"),e}}static async updateTool(e,t){try{const a={};t.name&&(a.name=t.name),t.description&&(a.description=t.description),t.url&&(a.url=t.url);const o=N(t);o&&(a.category_id=o),void 0!==t.icon&&(a.icon=t.icon),void 0!==t.is_featured&&(a.is_featured=t.is_featured),t.status&&(a.status=t.status),void 0!==t.meta_title&&(a.meta_title=t.meta_title),void 0!==t.meta_description&&(a.meta_description=t.meta_description),void 0!==t.sort_order&&(a.sort_order=t.sort_order),a.updated_at=(new Date).toISOString();const{data:s,error:r}=await x.from(E.TOOLS).update(a).eq("id",e).select("\n          *,\n          category:categories(*)\n        ").single();if(r)throw new Error(O(r));const i=this.transformToolRow(s);return this.clearRelatedCache(e),i}catch(a){throw console.error("Error updating tool:",a),a}}static async deleteTool(e){try{const{error:t}=await x.from(E.TOOLS).delete().eq("id",e);if(t)throw new Error(O(t));this.clearRelatedCache(e)}catch(t){throw console.error("Error deleting tool:",t),t}}static async incrementClickCount(e){try{const{error:t}=await x.rpc("increment_click_count",{tool_id:e});if(t)throw new Error(O(t));this.clearRelatedCache(e)}catch(t){throw console.error("Error incrementing click count:",t),t}}static async updateFavoriteStatus(e,t){try{const{error:a}=await x.from(E.TOOLS).update({is_favorite:t,updated_at:(new Date).toISOString()}).eq("id",e);if(a)throw new Error(O(a));this.clearRelatedCache(e)}catch(a){throw console.error("Error updating favorite status:",a),a}}static async getPopularTools(e=10){const t=`popular_tools_${e}`;return M(this._getPopularToolsFromAPI.bind(this),()=>t,D,3e5)(e)}static async _getPopularToolsFromAPI(e=10){try{const{data:t,error:a}=await x.from(E.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",J).order("click_count",{ascending:!1}).limit(e);if(a)throw new Error(O(a));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching popular tools:",t),t}}static async getFeaturedTools(e=6){const t=`featured_tools_${e}`;return M(this._getFeaturedToolsFromAPI.bind(this),()=>t,D,6e5)(e)}static async _getFeaturedToolsFromAPI(e=6){try{const{data:t,error:a}=await x.from(E.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",J).eq("is_featured",!0).order("sort_order",{ascending:!0}).limit(e);if(a)throw new Error(O(a));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching featured tools:",t),t}}static async searchTools(e,t=20){try{const{data:a,error:o}=await x.from(E.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",J).or(`name.ilike.%${e}%,description.ilike.%${e}%`).order("click_count",{ascending:!1}).limit(t);if(o)throw new Error(O(o));return(a||[]).map(this.transformToolRow)}catch(a){throw console.error("Error searching tools:",a),a}}static clearRelatedCache(e){D.clear(),e&&D.delete(`tool_${e}`)}static transformToolRow(e){return{id:e.id,name:e.name,description:e.description,url:e.url,icon:e.icon,category_id:e.category_id,tags:[],is_favorite:e.is_favorite,click_count:e.click_count,is_featured:e.is_featured,status:e.status,created_at:e.created_at,updated_at:e.updated_at,created_by:e.created_by,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order}}}const H={class:"admin-tools-view"},W={class:"admin-actions"},G={class:"search-tools"},Y={class:"tools-summary"},Z={class:"stats-grid"},K={class:"stat-card"},Q={class:"stat-number"},X={class:"stat-card"},ee={class:"stat-number"},te={class:"stat-card"},ae={class:"stat-number"},oe={class:"stat-card"},se={class:"stat-number"},re={class:"tools-management"},ie={class:"tools-header"},le={class:"filter-controls"},ce=["value"],ne={class:"tools-table"},ue={class:"col-icon"},de={class:"tool-icon"},ve={class:"col-name"},me={class:"tool-name"},pe={class:"tool-description"},he={class:"col-category"},ge={class:"category-badge"},fe={class:"col-status"},ye={class:"col-clicks"},_e={class:"col-actions"},we=["onClick"],be=["onClick"],Te=["title","onClick"],Se={key:0,class:"pagination"},ke=["disabled"],xe={class:"page-info"},Ee=["disabled"],Oe={class:"modal-header"},Ce={class:"form-grid"},Ie={class:"form-group"},Ae={class:"form-group"},qe={class:"form-group full-width"},ze={class:"form-group"},Re={class:"form-group"},Fe=["value"],Pe={class:"form-group"},Ue={class:"form-group"},Le={class:"form-actions"},$e=["disabled"],Ve=z(o({__name:"AdminToolsView",setup(e){const t=I(),a=A(),o=s(!1),x=s(!1),E=s(""),O=s("success"),C=s(""),z=s(""),V=s(""),j=s(1),D=s(10),M=s(!1),N=s(!1),J=s(null),Ve=s({name:"",description:"",url:"",icon:"🔧",category_id:"",status:"active",is_featured:!1}),je=r(()=>{let e=t.tools;if(C.value){const t=C.value.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))}return z.value&&(e=e.filter(e=>e.category_id===z.value)),V.value&&(e=e.filter(e=>e.status===V.value)),e}),De=r(()=>t.tools.filter(e=>e.is_featured).length),Me=r(()=>t.tools.filter(e=>"active"===e.status).length),Ne=r(()=>Math.ceil(je.value.length/D.value)),Je=r(()=>{const e=(j.value-1)*D.value,t=e+D.value;return je.value.slice(e,t)}),Be=async()=>{try{o.value=!0,await t.initialize(),await a.initialize(),E.value="工具列表已刷新",O.value="success"}catch(e){E.value="刷新失败",O.value="error"}finally{o.value=!1}},He=()=>{M.value=!1,N.value=!1,J.value=null,Ve.value={name:"",description:"",url:"",icon:"🔧",category_id:"",status:"active",is_featured:!1}},We=async()=>{try{x.value=!0,E.value="",N.value&&J.value?(await B.updateTool(J.value.id,{name:Ve.value.name,description:Ve.value.description,url:Ve.value.url,icon:Ve.value.icon,category_id:Ve.value.category_id,status:Ve.value.status,is_featured:Ve.value.is_featured}),E.value="工具更新成功！"):(await B.createTool({name:Ve.value.name,description:Ve.value.description,url:Ve.value.url,icon:Ve.value.icon,category_id:Ve.value.category_id,status:Ve.value.status,is_featured:Ve.value.is_featured,sort_order:0}),E.value="工具创建成功！"),O.value="success",He(),await Be()}catch(e){console.error("保存工具失败:",e),E.value="保存工具失败: "+(e instanceof Error?e.message:"未知错误"),O.value="error"}finally{x.value=!1}};return i(async()=>{await t.initialize(),await a.initialize()}),(e,t)=>(k(),l("div",H,[t[33]||(t[33]=c("div",{class:"admin-header"},[c("h1",null,"工具管理"),c("p",null,"添加、编辑和管理工具数据")],-1)),c("div",W,[c("button",{class:"action-button primary",onClick:t[0]||(t[0]=e=>M.value=!0)},[u(v(R),{class:"icon"}),t[14]||(t[14]=d(" 添加新工具 "))]),c("button",{class:"action-button secondary",onClick:Be},[u(v(F),{class:"icon"}),t[15]||(t[15]=d(" 刷新列表 "))]),c("div",G,[m(c("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>C.value=e),type:"text",placeholder:"搜索工具...",class:"search-input"},null,512),[[p,C.value]])])]),E.value?(k(),l("div",{key:0,class:h(["message",O.value])},g(E.value),3)):n("",!0),c("div",Y,[c("div",Z,[c("div",K,[c("div",Q,g(je.value.length),1),t[16]||(t[16]=c("div",{class:"stat-label"},"总工具数",-1))]),c("div",X,[c("div",ee,g(De.value),1),t[17]||(t[17]=c("div",{class:"stat-label"},"推荐工具",-1))]),c("div",te,[c("div",ae,g(v(a).categories.length),1),t[18]||(t[18]=c("div",{class:"stat-label"},"分类数",-1))]),c("div",oe,[c("div",se,g(Me.value),1),t[19]||(t[19]=c("div",{class:"stat-label"},"活跃工具",-1))])])]),c("div",re,[c("div",ie,[t[22]||(t[22]=c("h2",null,"工具列表",-1)),c("div",le,[m(c("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>z.value=e),class:"category-filter"},[t[20]||(t[20]=c("option",{value:""},"全部分类",-1)),(k(!0),l(y,null,_(v(a).categories,e=>(k(),l("option",{key:e.id,value:e.id},g(e.name),9,ce))),128))],512),[[f,z.value]]),m(c("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>V.value=e),class:"status-filter"},t[21]||(t[21]=[c("option",{value:""},"全部状态",-1),c("option",{value:"active"},"活跃",-1),c("option",{value:"inactive"},"停用",-1)]),512),[[f,V.value]])])]),c("div",ne,[t[23]||(t[23]=w('<div class="table-header" data-v-5aab2f41><div class="col-icon" data-v-5aab2f41>图标</div><div class="col-name" data-v-5aab2f41>名称</div><div class="col-category" data-v-5aab2f41>分类</div><div class="col-status" data-v-5aab2f41>状态</div><div class="col-clicks" data-v-5aab2f41>点击数</div><div class="col-actions" data-v-5aab2f41>操作</div></div>',1)),(k(!0),l(y,null,_(Je.value,t=>(k(),l("div",{key:t.id,class:"table-row"},[c("div",ue,[c("span",de,g(t.icon),1)]),c("div",ve,[c("div",me,g(t.name),1),c("div",pe,g(t.description),1)]),c("div",he,[c("span",ge,g(e.getCategoryName(t.category_id)||"未分类"),1)]),c("div",fe,[c("span",{class:h(["status-badge","active"===t.status?"active":"inactive"])},g("active"===t.status?"活跃":"停用"),3)]),c("div",ye,g(t.click_count||0),1),c("div",_e,[c("button",{class:"action-btn edit",title:"编辑",onClick:e=>(e=>{J.value=e,Ve.value={name:e.name,description:e.description,url:e.url,icon:e.icon,category_id:e.category_id,status:e.status,is_featured:e.is_featured},N.value=!0})(t)},[u(v(P),{class:"icon"})],8,we),c("button",{class:"action-btn delete",title:"删除",onClick:e=>(async e=>{if(confirm(`确定要删除工具 "${e.name}" 吗？此操作不可恢复。`))try{await B.deleteTool(e.id),E.value="工具删除成功！",O.value="success",await Be()}catch(t){console.error("删除工具失败:",t),E.value="删除工具失败: "+(t instanceof Error?t.message:"未知错误"),O.value="error"}})(t)},[u(v(U),{class:"icon"})],8,be),c("button",{class:"action-btn toggle",title:"active"===t.status?"停用":"启用",onClick:e=>(async e=>{try{const t="active"===e.status?"inactive":"active";await B.updateTool(e.id,{status:t}),E.value=`工具已${"active"===t?"启用":"停用"}！`,O.value="success",await Be()}catch(t){console.error("切换工具状态失败:",t),E.value="操作失败",O.value="error"}})(t)},["active"===t.status?(k(),b(v(L),{key:0,class:"icon"})):(k(),b(v($),{key:1,class:"icon"}))],8,Te)])]))),128))]),Ne.value>1?(k(),l("div",Se,[c("button",{disabled:1===j.value,class:"page-btn",onClick:t[4]||(t[4]=e=>j.value--)}," 上一页 ",8,ke),c("span",xe," 第 "+g(j.value)+" 页，共 "+g(Ne.value)+" 页 ",1),c("button",{disabled:j.value===Ne.value,class:"page-btn",onClick:t[5]||(t[5]=e=>j.value++)}," 下一页 ",8,Ee)])):n("",!0)]),M.value||N.value?(k(),l("div",{key:1,class:"modal-overlay",onClick:He},[c("div",{class:"modal-content",onClick:t[13]||(t[13]=T(()=>{},["stop"]))},[c("div",Oe,[c("h3",null,g(M.value?"添加新工具":"编辑工具"),1),c("button",{class:"close-btn",onClick:He},[u(v(q),{class:"icon"})])]),c("form",{class:"tool-form",onSubmit:T(We,["prevent"])},[c("div",Ce,[c("div",Ie,[t[24]||(t[24]=c("label",null,"工具名称 *",-1)),m(c("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>Ve.value.name=e),type:"text",required:"",placeholder:"输入工具名称"},null,512),[[p,Ve.value.name]])]),c("div",Ae,[t[25]||(t[25]=c("label",null,"工具图标",-1)),m(c("input",{"onUpdate:modelValue":t[7]||(t[7]=e=>Ve.value.icon=e),type:"text",placeholder:"🔧"},null,512),[[p,Ve.value.icon]])]),c("div",qe,[t[26]||(t[26]=c("label",null,"工具描述 *",-1)),m(c("textarea",{"onUpdate:modelValue":t[8]||(t[8]=e=>Ve.value.description=e),required:"",placeholder:"描述工具的功能和用途",rows:"3"},null,512),[[p,Ve.value.description]])]),c("div",ze,[t[27]||(t[27]=c("label",null,"工具链接 *",-1)),m(c("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>Ve.value.url=e),type:"url",required:"",placeholder:"https://example.com"},null,512),[[p,Ve.value.url]])]),c("div",Re,[t[29]||(t[29]=c("label",null,"分类 *",-1)),m(c("select",{"onUpdate:modelValue":t[10]||(t[10]=e=>Ve.value.category_id=e),required:""},[t[28]||(t[28]=c("option",{value:""},"选择分类",-1)),(k(!0),l(y,null,_(v(a).categories,e=>(k(),l("option",{key:e.id,value:e.id},g(e.name),9,Fe))),128))],512),[[f,Ve.value.category_id]])]),c("div",Pe,[t[31]||(t[31]=c("label",null,"状态",-1)),m(c("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>Ve.value.status=e)},t[30]||(t[30]=[c("option",{value:"active"},"活跃",-1),c("option",{value:"inactive"},"停用",-1)]),512),[[f,Ve.value.status]])]),c("div",Ue,[c("label",null,[m(c("input",{"onUpdate:modelValue":t[12]||(t[12]=e=>Ve.value.is_featured=e),type:"checkbox"},null,512),[[S,Ve.value.is_featured]]),t[32]||(t[32]=d(" 推荐工具 "))])])]),c("div",Le,[c("button",{type:"button",class:"cancel-btn",onClick:He}," 取消 "),c("button",{type:"submit",disabled:x.value,class:"save-btn"},g(x.value?"保存中...":"保存"),9,$e)])],32)])])):n("",!0)]))}}),[["__scopeId","data-v-5aab2f41"]]);export{Ve as default};
