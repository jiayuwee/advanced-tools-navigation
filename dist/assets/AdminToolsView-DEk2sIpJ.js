var e=Object.defineProperty,__publicField=(t,a,o)=>((t,a,o)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o)(t,"symbol"!=typeof a?a+"":a,o);import{b as t,d as a,r as o,c as s,o as r,m as i,q as l,t as c,y as n,E as u,u as d,G as v,I as h,B as m,D as p,P as g,F as f,z as y,O as _,v as w,x as b,H as T,A as S}from"./vendor-dtMHlISa.js";import{s as C,T as k,r as x,p as E,u as O,a as I,X as q,_ as A}from"./index-DnVHVpUO.js";import{P as z}from"./plus-M8BVbi2o.js";import{R}from"./refresh-cw-sVZGUD43.js";import{P as F}from"./pen-square-C_Jm19ul.js";import{T as P}from"./trash-R4zDBOYf.js";import{E as U}from"./eye-DQ_sdAJN.js";import{E as L}from"./eye-off-iR5vLySf.js";class CacheManager{constructor(e={}){__publicField(this,"cache",t(new Map)),__publicField(this,"options"),__publicField(this,"defaultOptions",{maxAge:3e5,maxSize:100,version:"1.0.0",serialize:!1,prefix:"app_cache_"}),this.options={...this.defaultOptions,...e},this.options.serialize&&this.loadFromStorage(),this.startCleanupTimer()}set(e,t,a){const o=Date.now(),s={data:t,timestamp:o,expiry:o+(a||this.options.maxAge),version:this.options.version,hits:0,lastAccessed:o};this.cache.size>=this.options.maxSize&&this.evictLeastRecentlyUsed(),this.cache.set(e,s),this.options.serialize&&this.saveToStorage(e,s)}get(e){const t=this.cache.get(e);if(!t)return null;const a=Date.now();return a>t.expiry||t.version!==this.options.version?(this.delete(e),null):(t.hits++,t.lastAccessed=a,t.data)}delete(e){const t=this.cache.delete(e);return t&&this.options.serialize&&this.removeFromStorage(e),t}has(e){return null!==this.get(e)}clear(){this.cache.clear(),this.options.serialize&&this.clearStorage()}getStats(){const e=Date.now();let t=0,a=0,o=0;for(const[,s]of this.cache)t+=s.hits,e>s.expiry?o++:a++;return{totalItems:this.cache.size,validItems:a,expiredItems:o,totalHits:t,hitRate:t>0?t/this.cache.size:0,memoryUsage:this.estimateMemoryUsage()}}refreshVersion(e){this.options.version=e,this.clear()}evictLeastRecentlyUsed(){let e="",t=Date.now();for(const[a,o]of this.cache)o.lastAccessed<t&&(t=o.lastAccessed,e=a);e&&this.delete(e)}cleanup(){const e=Date.now(),t=[];for(const[a,o]of this.cache)(e>o.expiry||o.version!==this.options.version)&&t.push(a);t.forEach(e=>this.delete(e))}startCleanupTimer(){setInterval(()=>{this.cleanup()},6e4)}estimateMemoryUsage(){let e=0;for(const[t,a]of this.cache)e+=2*t.length,e+=2*JSON.stringify(a).length;return e}saveToStorage(e,t){try{const a=this.options.prefix+e;localStorage.setItem(a,JSON.stringify(t))}catch(a){console.warn("保存缓存到 localStorage 失败:",a)}}loadFromStorage(){try{const e=this.options.prefix;for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);if(null==a?void 0:a.startsWith(e)){const t=a.slice(e.length),o=localStorage.getItem(a);if(o){const e=JSON.parse(o);Date.now()<=e.expiry&&e.version===this.options.version?this.cache.set(t,e):localStorage.removeItem(a)}}}}catch(e){console.warn("从 localStorage 加载缓存失败:",e)}}removeFromStorage(e){try{const t=this.options.prefix+e;localStorage.removeItem(t)}catch(t){console.warn("从 localStorage 删除缓存失败:",t)}}clearStorage(){try{const e=this.options.prefix,t=[];for(let a=0;a<localStorage.length;a++){const o=localStorage.key(a);(null==o?void 0:o.startsWith(e))&&t.push(o)}t.forEach(e=>localStorage.removeItem(e))}catch(e){console.warn("清空 localStorage 缓存失败:",e)}}}const $=new CacheManager({maxAge:3e5,maxSize:100,serialize:!0,prefix:"advanced_tools_"});new CacheManager({maxAge:18e5,maxSize:50,serialize:!1,prefix:"img_cache_"});const V=new CacheManager({maxAge:18e4,maxSize:200,serialize:!0,prefix:"api_cache_"});function withCache(e,t,a=$,o){return async(...s)=>{const r="function"==typeof t?t(...s):t,i=a.get(r);if(null!==i)return i;const l=await e(...s);return a.set(r,l,o),l}}function extractCategoryId(e){var t;return(null==(t=e.category)?void 0:t.id)?e.category.id:e.categoryId?e.categoryId:e.category_id?e.category_id:null}const j="active";class ToolsService{static async getTools(e){const t=`tools_${JSON.stringify(e||{})}`;return withCache(this._getToolsFromAPI.bind(this),()=>t,V,12e4)(e)}static async _getToolsFromAPI(e){try{let t=C.from(k.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",j);(null==e?void 0:e.query)&&(t=t.or(`name.ilike.%${e.query}%,description.ilike.%${e.query}%`)),(null==e?void 0:e.category)&&"all"!==e.category&&(t=t.eq("category_id",e.category));const a=(null==e?void 0:e.sortBy)||"sort_order",o=(null==e?void 0:e.sortOrder)||"asc";t=t.order(a,{ascending:"asc"===o});const s=(null==e?void 0:e.page)||1,r=(null==e?void 0:e.limit)||20,i=(s-1)*r;t=t.range(i,i+r-1);const{data:l,error:c,count:n}=await t;if(c)throw new Error(x(c));return{items:(l||[]).map(this.transformToolRow),total:n||0,page:s,limit:r,hasMore:(n||0)>i+r}}catch(t){const e=E.handleApiError(t);throw E.logError(e,"ToolsService.getTools"),e}}static async getTool(e){const t=`tool_${e}`;return withCache(this._getToolFromAPI.bind(this),()=>t,V,3e5)(e)}static async _getToolFromAPI(e){try{const{data:t,error:a}=await C.from(k.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("id",e).single();if(a)throw new Error(x(a));return this.transformToolRow(t)}catch(t){const e=E.handleApiError(t);throw E.logError(e,"ToolsService.getTool"),e}}static async createTool(e){try{!function validateRequiredFields(e,t,a="Entity"){const o=[];for(const s of t)e[s]||o.push(s);if(o.length>0)throw new Error(`${a} validation failed: missing required fields: ${o.join(", ")}`)}(e,["name","description","url"],"Tool");const t=function requireCategoryId(e,t="Category"){const a=extractCategoryId(e);if(!a)throw new Error(`${t} is required`);return a}(e),{data:a,error:o}=await C.from(k.TOOLS).insert({name:e.name,description:e.description,url:e.url,category_id:t,icon:e.icon,is_featured:e.is_featured||!1,status:j,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order||0}).select("\n          *,\n          category:categories(*)\n        ").single();if(o)throw new Error(x(o));const s=this.transformToolRow(a);return this.clearRelatedCache(),s}catch(t){const e=E.handleApiError(t);throw E.logError(e,"ToolsService.createTool"),e}}static async updateTool(e,t){try{const a={};t.name&&(a.name=t.name),t.description&&(a.description=t.description),t.url&&(a.url=t.url);const o=extractCategoryId(t);o&&(a.category_id=o),void 0!==t.icon&&(a.icon=t.icon),void 0!==t.is_featured&&(a.is_featured=t.is_featured),t.status&&(a.status=t.status),void 0!==t.meta_title&&(a.meta_title=t.meta_title),void 0!==t.meta_description&&(a.meta_description=t.meta_description),void 0!==t.sort_order&&(a.sort_order=t.sort_order),a.updated_at=(new Date).toISOString();const{data:s,error:r}=await C.from(k.TOOLS).update(a).eq("id",e).select("\n          *,\n          category:categories(*)\n        ").single();if(r)throw new Error(x(r));const i=this.transformToolRow(s);return this.clearRelatedCache(e),i}catch(a){throw console.error("Error updating tool:",a),a}}static async deleteTool(e){try{const{error:t}=await C.from(k.TOOLS).delete().eq("id",e);if(t)throw new Error(x(t));this.clearRelatedCache(e)}catch(t){throw console.error("Error deleting tool:",t),t}}static async incrementClickCount(e){try{const{error:t}=await C.rpc("increment_click_count",{tool_id:e});if(t)throw new Error(x(t));this.clearRelatedCache(e)}catch(t){throw console.error("Error incrementing click count:",t),t}}static async updateFavoriteStatus(e,t){try{const{error:a}=await C.from(k.TOOLS).update({is_favorite:t,updated_at:(new Date).toISOString()}).eq("id",e);if(a)throw new Error(x(a));this.clearRelatedCache(e)}catch(a){throw console.error("Error updating favorite status:",a),a}}static async getPopularTools(e=10){const t=`popular_tools_${e}`;return withCache(this._getPopularToolsFromAPI.bind(this),()=>t,V,3e5)(e)}static async _getPopularToolsFromAPI(e=10){try{const{data:t,error:a}=await C.from(k.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",j).order("click_count",{ascending:!1}).limit(e);if(a)throw new Error(x(a));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching popular tools:",t),t}}static async getFeaturedTools(e=6){const t=`featured_tools_${e}`;return withCache(this._getFeaturedToolsFromAPI.bind(this),()=>t,V,6e5)(e)}static async _getFeaturedToolsFromAPI(e=6){try{const{data:t,error:a}=await C.from(k.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",j).eq("is_featured",!0).order("sort_order",{ascending:!0}).limit(e);if(a)throw new Error(x(a));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching featured tools:",t),t}}static async searchTools(e,t=20){try{const{data:a,error:o}=await C.from(k.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",j).or(`name.ilike.%${e}%,description.ilike.%${e}%`).order("click_count",{ascending:!1}).limit(t);if(o)throw new Error(x(o));return(a||[]).map(this.transformToolRow)}catch(a){throw console.error("Error searching tools:",a),a}}static clearRelatedCache(e){V.clear(),e&&V.delete(`tool_${e}`)}static transformToolRow(e){return{id:e.id,name:e.name,description:e.description,url:e.url,icon:e.icon,category_id:e.category_id,tags:[],is_favorite:e.is_favorite,click_count:e.click_count,is_featured:e.is_featured,status:e.status,created_at:e.created_at,updated_at:e.updated_at,created_by:e.created_by,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order}}}const M={class:"admin-tools-view"},D={class:"admin-actions"},N={class:"search-tools"},J={class:"tools-summary"},B={class:"stats-grid"},H={class:"stat-card"},W={class:"stat-number"},G={class:"stat-card"},Y={class:"stat-number"},Z={class:"stat-card"},K={class:"stat-number"},Q={class:"stat-card"},X={class:"stat-number"},ee={class:"tools-management"},te={class:"tools-header"},ae={class:"filter-controls"},oe=["value"],se={class:"tools-table"},re={class:"col-icon"},ie={class:"tool-icon"},le={class:"col-name"},ce={class:"tool-name"},ne={class:"tool-description"},ue={class:"col-category"},de={class:"category-badge"},ve={class:"col-status"},he={class:"col-clicks"},me={class:"col-actions"},pe=["onClick"],ge=["onClick"],fe=["title","onClick"],ye={key:0,class:"pagination"},_e=["disabled"],we={class:"page-info"},be=["disabled"],Te={class:"modal-header"},Se={class:"form-grid"},Ce={class:"form-group"},ke={class:"form-group"},xe={class:"form-group full-width"},Ee={class:"form-group"},Oe={class:"form-group"},Ie=["value"],qe={class:"form-group"},Ae={class:"form-group"},ze={class:"form-actions"},Re=["disabled"],Fe=A(a({__name:"AdminToolsView",setup(e){const t=O(),a=I(),C=o(!1),k=o(!1),x=o(""),E=o("success"),A=o(""),$=o(""),V=o(""),j=o(1),Fe=o(10),Pe=o(!1),Ue=o(!1),Le=o(null),$e=o({name:"",description:"",url:"",icon:"🔧",category_id:"",status:"active",is_featured:!1}),Ve=s(()=>{let e=t.tools;if(A.value){const t=A.value.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))}return $.value&&(e=e.filter(e=>e.category_id===$.value)),V.value&&(e=e.filter(e=>e.status===V.value)),e}),je=s(()=>t.tools.filter(e=>e.is_featured).length),Me=s(()=>t.tools.filter(e=>"active"===e.status).length),De=s(()=>Math.ceil(Ve.value.length/Fe.value)),Ne=s(()=>{const e=(j.value-1)*Fe.value,t=e+Fe.value;return Ve.value.slice(e,t)}),refreshTools=async()=>{try{C.value=!0,await t.initialize(),await a.initialize(),x.value="工具列表已刷新",E.value="success"}catch(e){x.value="刷新失败",E.value="error"}finally{C.value=!1}},closeModals=()=>{Pe.value=!1,Ue.value=!1,Le.value=null,$e.value={name:"",description:"",url:"",icon:"🔧",category_id:"",status:"active",is_featured:!1}},saveTool=async()=>{try{k.value=!0,x.value="",Ue.value&&Le.value?(await ToolsService.updateTool(Le.value.id,{name:$e.value.name,description:$e.value.description,url:$e.value.url,icon:$e.value.icon,category_id:$e.value.category_id,status:$e.value.status,is_featured:$e.value.is_featured}),x.value="工具更新成功！"):(await ToolsService.createTool({name:$e.value.name,description:$e.value.description,url:$e.value.url,icon:$e.value.icon,category_id:$e.value.category_id,status:$e.value.status,is_featured:$e.value.is_featured,sort_order:0}),x.value="工具创建成功！"),E.value="success",closeModals(),await refreshTools()}catch(e){console.error("保存工具失败:",e),x.value="保存工具失败: "+(e instanceof Error?e.message:"未知错误"),E.value="error"}finally{k.value=!1}};return r(async()=>{await t.initialize(),await a.initialize()}),(e,t)=>(S(),i("div",M,[t[33]||(t[33]=l("div",{class:"admin-header"},[l("h1",null,"工具管理"),l("p",null,"添加、编辑和管理工具数据")],-1)),l("div",D,[l("button",{class:"action-button primary",onClick:t[0]||(t[0]=e=>Pe.value=!0)},[n(d(z),{class:"icon"}),t[14]||(t[14]=u(" 添加新工具 "))]),l("button",{class:"action-button secondary",onClick:refreshTools},[n(d(R),{class:"icon"}),t[15]||(t[15]=u(" 刷新列表 "))]),l("div",N,[v(l("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>A.value=e),type:"text",placeholder:"搜索工具...",class:"search-input"},null,512),[[h,A.value]])])]),x.value?(S(),i("div",{key:0,class:m(["message",E.value])},p(x.value),3)):c("",!0),l("div",J,[l("div",B,[l("div",H,[l("div",W,p(Ve.value.length),1),t[16]||(t[16]=l("div",{class:"stat-label"},"总工具数",-1))]),l("div",G,[l("div",Y,p(je.value),1),t[17]||(t[17]=l("div",{class:"stat-label"},"推荐工具",-1))]),l("div",Z,[l("div",K,p(d(a).categories.length),1),t[18]||(t[18]=l("div",{class:"stat-label"},"分类数",-1))]),l("div",Q,[l("div",X,p(Me.value),1),t[19]||(t[19]=l("div",{class:"stat-label"},"活跃工具",-1))])])]),l("div",ee,[l("div",te,[t[22]||(t[22]=l("h2",null,"工具列表",-1)),l("div",ae,[v(l("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>$.value=e),class:"category-filter"},[t[20]||(t[20]=l("option",{value:""},"全部分类",-1)),(S(!0),i(f,null,y(d(a).categories,e=>(S(),i("option",{key:e.id,value:e.id},p(e.name),9,oe))),128))],512),[[g,$.value]]),v(l("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>V.value=e),class:"status-filter"},t[21]||(t[21]=[l("option",{value:""},"全部状态",-1),l("option",{value:"active"},"活跃",-1),l("option",{value:"inactive"},"停用",-1)]),512),[[g,V.value]])])]),l("div",se,[t[23]||(t[23]=_('<div class="table-header" data-v-5aab2f41><div class="col-icon" data-v-5aab2f41>图标</div><div class="col-name" data-v-5aab2f41>名称</div><div class="col-category" data-v-5aab2f41>分类</div><div class="col-status" data-v-5aab2f41>状态</div><div class="col-clicks" data-v-5aab2f41>点击数</div><div class="col-actions" data-v-5aab2f41>操作</div></div>',1)),(S(!0),i(f,null,y(Ne.value,t=>(S(),i("div",{key:t.id,class:"table-row"},[l("div",re,[l("span",ie,p(t.icon),1)]),l("div",le,[l("div",ce,p(t.name),1),l("div",ne,p(t.description),1)]),l("div",ue,[l("span",de,p(e.getCategoryName(t.category_id)||"未分类"),1)]),l("div",ve,[l("span",{class:m(["status-badge","active"===t.status?"active":"inactive"])},p("active"===t.status?"活跃":"停用"),3)]),l("div",he,p(t.click_count||0),1),l("div",me,[l("button",{class:"action-btn edit",title:"编辑",onClick:e=>(e=>{Le.value=e,$e.value={name:e.name,description:e.description,url:e.url,icon:e.icon,category_id:e.category_id,status:e.status,is_featured:e.is_featured},Ue.value=!0})(t)},[n(d(F),{class:"icon"})],8,pe),l("button",{class:"action-btn delete",title:"删除",onClick:e=>(async e=>{if(confirm(`确定要删除工具 "${e.name}" 吗？此操作不可恢复。`))try{await ToolsService.deleteTool(e.id),x.value="工具删除成功！",E.value="success",await refreshTools()}catch(t){console.error("删除工具失败:",t),x.value="删除工具失败: "+(t instanceof Error?t.message:"未知错误"),E.value="error"}})(t)},[n(d(P),{class:"icon"})],8,ge),l("button",{class:"action-btn toggle",title:"active"===t.status?"停用":"启用",onClick:e=>(async e=>{try{const t="active"===e.status?"inactive":"active";await ToolsService.updateTool(e.id,{status:t}),x.value=`工具已${"active"===t?"启用":"停用"}！`,E.value="success",await refreshTools()}catch(t){console.error("切换工具状态失败:",t),x.value="操作失败",E.value="error"}})(t)},["active"===t.status?(S(),w(d(U),{key:0,class:"icon"})):(S(),w(d(L),{key:1,class:"icon"}))],8,fe)])]))),128))]),De.value>1?(S(),i("div",ye,[l("button",{disabled:1===j.value,class:"page-btn",onClick:t[4]||(t[4]=e=>j.value--)}," 上一页 ",8,_e),l("span",we," 第 "+p(j.value)+" 页，共 "+p(De.value)+" 页 ",1),l("button",{disabled:j.value===De.value,class:"page-btn",onClick:t[5]||(t[5]=e=>j.value++)}," 下一页 ",8,be)])):c("",!0)]),Pe.value||Ue.value?(S(),i("div",{key:1,class:"modal-overlay",onClick:closeModals},[l("div",{class:"modal-content",onClick:t[13]||(t[13]=b(()=>{},["stop"]))},[l("div",Te,[l("h3",null,p(Pe.value?"添加新工具":"编辑工具"),1),l("button",{class:"close-btn",onClick:closeModals},[n(d(q),{class:"icon"})])]),l("form",{class:"tool-form",onSubmit:b(saveTool,["prevent"])},[l("div",Se,[l("div",Ce,[t[24]||(t[24]=l("label",null,"工具名称 *",-1)),v(l("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>$e.value.name=e),type:"text",required:"",placeholder:"输入工具名称"},null,512),[[h,$e.value.name]])]),l("div",ke,[t[25]||(t[25]=l("label",null,"工具图标",-1)),v(l("input",{"onUpdate:modelValue":t[7]||(t[7]=e=>$e.value.icon=e),type:"text",placeholder:"🔧"},null,512),[[h,$e.value.icon]])]),l("div",xe,[t[26]||(t[26]=l("label",null,"工具描述 *",-1)),v(l("textarea",{"onUpdate:modelValue":t[8]||(t[8]=e=>$e.value.description=e),required:"",placeholder:"描述工具的功能和用途",rows:"3"},null,512),[[h,$e.value.description]])]),l("div",Ee,[t[27]||(t[27]=l("label",null,"工具链接 *",-1)),v(l("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>$e.value.url=e),type:"url",required:"",placeholder:"https://example.com"},null,512),[[h,$e.value.url]])]),l("div",Oe,[t[29]||(t[29]=l("label",null,"分类 *",-1)),v(l("select",{"onUpdate:modelValue":t[10]||(t[10]=e=>$e.value.category_id=e),required:""},[t[28]||(t[28]=l("option",{value:""},"选择分类",-1)),(S(!0),i(f,null,y(d(a).categories,e=>(S(),i("option",{key:e.id,value:e.id},p(e.name),9,Ie))),128))],512),[[g,$e.value.category_id]])]),l("div",qe,[t[31]||(t[31]=l("label",null,"状态",-1)),v(l("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>$e.value.status=e)},t[30]||(t[30]=[l("option",{value:"active"},"活跃",-1),l("option",{value:"inactive"},"停用",-1)]),512),[[g,$e.value.status]])]),l("div",Ae,[l("label",null,[v(l("input",{"onUpdate:modelValue":t[12]||(t[12]=e=>$e.value.is_featured=e),type:"checkbox"},null,512),[[T,$e.value.is_featured]]),t[32]||(t[32]=u(" 推荐工具 "))])])]),l("div",ze,[l("button",{type:"button",class:"cancel-btn",onClick:closeModals}," 取消 "),l("button",{type:"submit",disabled:k.value,class:"save-btn"},p(k.value?"保存中...":"保存"),9,Re)])],32)])])):c("",!0)]))}}),[["__scopeId","data-v-5aab2f41"]]);export{Fe as default};
//# sourceMappingURL=AdminToolsView-DEk2sIpJ.js.map
