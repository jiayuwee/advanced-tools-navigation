import{s as t}from"./index-BbQlNKpj.js";import"./vendor-dtMHlISa.js";class OrderService{static async createOrder(e,r){try{const{data:d,error:i}=await t.from("products").select("id, name, price, is_digital").eq("id",e.product_id).eq("status","active").single();if(i||!d)throw new Error("产品不存在或已下架");const o=d.price*e.quantity,s={user_id:r,total_amount:o,currency:"CNY",status:"pending",billing_address:(a=e.billing_address,{street:a.address||"",city:a.city||"",state:a.state||"",postal_code:a.postal_code||"",country:a.country||""})},{data:n,error:c}=await t.from("orders").insert([s]).select().single();if(c)throw c;if(!n)throw new Error("创建订单失败");const l={order_id:n.id,product_id:e.product_id,quantity:e.quantity,unit_price:d.price,total_price:o},{data:u,error:_}=await t.from("order_items").insert([l]).select().single();if(_)throw _;if(!u)throw new Error("创建订单项失败");return{id:n.id,user_id:n.user_id,items:[{id:u.id,order_id:n.id,product_id:e.product_id,quantity:e.quantity,unit_price:d.price,total_price:o,created_at:u.created_at,product:{id:d.id,name:d.name,description:"",short_description:"",price:d.price,currency:"CNY",category_id:"",images:[],features:[],is_featured:!1,is_digital:d.is_digital||!1,status:"active",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}}],total_amount:o,currency:n.currency,status:n.status,payment_method:n.payment_method||void 0,payment_id:n.payment_id||void 0,billing_address:e.billing_address,created_at:n.created_at,updated_at:n.updated_at,completed_at:n.completed_at||void 0}}catch(d){throw console.error("创建订单失败:",d),new Error("创建订单失败")}var a}static async processPayment(e){try{const r={status:"paid",payment_method:e.payment_method,payment_id:e.payment_id,completed_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{error:a}=await t.from("orders").update(r).eq("id",e.order_id).eq("status","pending");if(a)throw a;const d={order_id:e.order_id,amount:e.amount,currency:"CNY",payment_method:e.payment_method,provider_payment_id:e.payment_id,status:"completed",completed_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{error:i}=await t.from("payments").insert([d]);if(i)throw i}catch(r){throw console.error("处理支付失败:",r),new Error("处理支付失败")}}static async verifyDownloadPermission(e,r){try{const{data:a,error:d}=await t.from("order_items").select("\n          id,\n          orders!inner(\n            id,\n            user_id,\n            status\n          )\n        ").eq("product_id",e).eq("orders.user_id",r).eq("orders.status","paid");if(d)throw d;return a&&a.length>0}catch(a){return console.error("验证下载权限失败:",a),!1}}static async getUserOrders(e){try{const{data:r,error:a}=await t.from("orders").select("\n          *,\n          order_items(\n            *,\n            products(id, name, images, short_description)\n          )\n        ").eq("user_id",e).order("created_at",{ascending:!1});if(a)throw a;return(r||[]).map(t=>{var e;return{id:t.id,user_id:t.user_id,items:(null==(e=t.order_items)?void 0:e.map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price,total_price:t.total_price,created_at:t.created_at,product:t.products?{id:t.products.id,name:t.products.name,description:"",short_description:t.products.short_description||"",price:0,currency:"CNY",category_id:"",images:t.products.images||[],features:[],is_featured:!1,is_digital:!1,status:"active",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:void 0})))||[],total_amount:t.total_amount,currency:t.currency,status:t.status,payment_method:t.payment_method||void 0,payment_id:t.payment_id||void 0,billing_address:t.billing_address?{full_name:"",email:"",phone:"",country:t.billing_address.country,state:t.billing_address.state,city:t.billing_address.city,address:t.billing_address.street,postal_code:t.billing_address.postal_code}:void 0,created_at:t.created_at,updated_at:t.updated_at,completed_at:t.completed_at||void 0}})}catch(r){throw console.error("获取用户订单失败:",r),new Error("获取用户订单失败")}}static async cancelOrder(e,r){try{const a={status:"cancelled",updated_at:(new Date).toISOString()},{error:d}=await t.from("orders").update(a).eq("id",e).eq("user_id",r).eq("status","pending");if(d)throw d}catch(a){throw console.error("取消订单失败:",a),new Error("取消订单失败")}}static async getOrderById(e,r){var a;try{const{data:d,error:i}=await t.from("orders").select("\n          *,\n          order_items(\n            *,\n            products(id, name, images, short_description, download_url)\n          )\n        ").eq("id",e).eq("user_id",r).single();if(i)throw i;return d?{id:d.id,user_id:d.user_id,items:(null==(a=d.order_items)?void 0:a.map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price,total_price:t.total_price,created_at:t.created_at,product:t.products?{id:t.products.id,name:t.products.name,description:"",short_description:t.products.short_description||"",price:0,currency:"CNY",category_id:"",images:t.products.images||[],features:[],is_featured:!1,is_digital:!1,status:"active",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),download_url:t.products.download_url}:void 0})))||[],total_amount:d.total_amount,currency:d.currency,status:d.status,payment_method:d.payment_method||void 0,payment_id:d.payment_id||void 0,billing_address:d.billing_address?{full_name:"",email:"",phone:"",country:d.billing_address.country,state:d.billing_address.state,city:d.billing_address.city,address:d.billing_address.street,postal_code:d.billing_address.postal_code}:void 0,created_at:d.created_at,updated_at:d.updated_at,completed_at:d.completed_at||void 0}:null}catch(d){return console.error("获取订单详情失败:",d),null}}static async getAllOrders(e){try{const r=(null==e?void 0:e.page)||1,a=(null==e?void 0:e.limit)||10,d=(r-1)*a;let i=t.from("orders").select("\n          *,\n          user_profiles!inner(id, email, full_name, avatar_url),\n          order_items(\n            *,\n            products(id, name, images, short_description)\n          )\n        ",{count:"exact"});if((null==e?void 0:e.status)&&(i=i.eq("status",e.status)),(null==e?void 0:e.paymentMethod)&&(i=i.eq("payment_method",e.paymentMethod)),null==e?void 0:e.search){const t=e.search.toLowerCase();i=i.or(`id.ilike.%${t}%,user_profiles.email.ilike.%${t}%,user_profiles.full_name.ilike.%${t}%`)}if((null==e?void 0:e.startDate)&&(i=i.gte("created_at",e.startDate)),null==e?void 0:e.endDate){const t=new Date(e.endDate);t.setHours(23,59,59,999),i=i.lte("created_at",t.toISOString())}i=i.order("created_at",{ascending:!1}).range(d,d+a-1);const{data:o,error:s,count:n}=await i;if(s)throw s;return{orders:(o||[]).map(t=>{var e;return{id:t.id,user_id:t.user_id,user:t.user_profiles?{id:t.user_profiles.id,email:t.user_profiles.email,full_name:t.user_profiles.full_name,avatar_url:t.user_profiles.avatar_url}:void 0,items:(null==(e=t.order_items)?void 0:e.map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price,total_price:t.total_price,created_at:t.created_at,product:t.products?{id:t.products.id,name:t.products.name,description:"",short_description:t.products.short_description||"",price:0,currency:"CNY",category_id:"",images:t.products.images||[],features:[],is_featured:!1,is_digital:!1,status:"active",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:void 0})))||[],total_amount:t.total_amount,currency:t.currency,status:t.status,payment_method:t.payment_method||void 0,payment_id:t.payment_id||void 0,billing_address:t.billing_address?{full_name:"",email:"",phone:"",country:t.billing_address.country,state:t.billing_address.state,city:t.billing_address.city,address:t.billing_address.street,postal_code:t.billing_address.postal_code}:void 0,created_at:t.created_at,updated_at:t.updated_at,completed_at:t.completed_at||void 0}}),total:n||0,page:r,limit:a}}catch(r){throw console.error("获取所有订单失败:",r),new Error("获取所有订单失败")}}static async updateOrderStatus(e,r,a){try{const d={status:r,updated_at:(new Date).toISOString()};"paid"===r&&(d.completed_at=(new Date).toISOString());const{error:i}=await t.from("orders").update(d).eq("id",e);if(i)throw i;console.log(`管理员 ${a} 将订单 ${e} 状态更新为 ${r}`)}catch(d){throw console.error("更新订单状态失败:",d),new Error("更新订单状态失败")}}static async getOrderStats(){try{const{data:e,error:r}=await t.from("orders").select("status, total_amount, created_at");if(r)throw r;const a=new Date;a.setHours(0,0,0,0);const d=a.toISOString(),{data:i,error:o}=await t.from("orders").select("status, total_amount").gte("created_at",d);if(o)throw o;const s=(null==e?void 0:e.length)||0,n=(null==e?void 0:e.filter(t=>"pending"===t.status).length)||0,c=(null==e?void 0:e.filter(t=>"paid"===t.status).length)||0,l=(null==e?void 0:e.filter(t=>"cancelled"===t.status).length)||0,u=(null==e?void 0:e.filter(t=>"paid"===t.status).reduce((t,e)=>t+e.total_amount,0))||0,_=(null==i?void 0:i.length)||0;return{totalOrders:s,pendingOrders:n,paidOrders:c,cancelledOrders:l,totalRevenue:u,todayOrders:_,todayRevenue:(null==i?void 0:i.filter(t=>"paid"===t.status).reduce((t,e)=>t+e.total_amount,0))||0}}catch(e){throw console.error("获取订单统计失败:",e),new Error("获取订单统计失败")}}static async exportOrders(e){try{let r=t.from("orders").select("\n          *,\n          user_profiles!inner(email, full_name),\n          order_items(\n            *,\n            products(name)\n          )\n        ");if((null==e?void 0:e.status)&&(r=r.eq("status",e.status)),(null==e?void 0:e.startDate)&&(r=r.gte("created_at",e.startDate)),null==e?void 0:e.endDate){const t=new Date(e.endDate);t.setHours(23,59,59,999),r=r.lte("created_at",t.toISOString())}r=r.order("created_at",{ascending:!1});const{data:a,error:d}=await r;if(d)throw d;let i=["订单ID","用户邮箱","用户姓名","商品名称","数量","单价","总金额","货币","状态","支付方式","支付ID","创建时间","完成时间"].join(",")+"\n";return null==a||a.forEach(t=>{var e;null==(e=t.order_items)||e.forEach(e=>{var r,a,d;const o=[t.id,(null==(r=t.user_profiles)?void 0:r.email)||"",(null==(a=t.user_profiles)?void 0:a.full_name)||"",(null==(d=e.products)?void 0:d.name)||"",e.quantity,e.unit_price,t.total_amount,t.currency,t.status,t.payment_method||"",t.payment_id||"",new Date(t.created_at).toLocaleString("zh-CN"),t.completed_at?new Date(t.completed_at).toLocaleString("zh-CN"):""];i+=o.map(t=>`"${t}"`).join(",")+"\n"})}),i}catch(r){throw console.error("导出订单数据失败:",r),new Error("导出订单数据失败")}}}export{OrderService};
//# sourceMappingURL=orderService-XOeuFSLT.js.map
