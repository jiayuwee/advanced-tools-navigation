var e=Object.defineProperty,__publicField=(a,t,s)=>((a,t,s)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s)(a,"symbol"!=typeof t?t+"":t,s);import{d as a,r as t,c as s,o as l,n as o,w as r,m as n,B as c,q as i,t as u,y as d,G as v,u as p,I as g,P as h,F as m,z as y,v as f,C as k,D as w,O as b,E as _,Q as S,A as T}from"./vendor-dtMHlISa.js";import{e as x,s as C,T as q,a as M,S as $,X as O,C as E,c as H,f as R,P as A,_ as P}from"./index-DFN97R6u.js";import{F as D,a as I}from"./folder-C-XNkvAJ.js";import{T as B}from"./trending-up-BibEG1v8.js";
/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=x("TagIcon",[["path",{d:"M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z",key:"14b2ls"}],["path",{d:"M7 7h.01",key:"7u93v4"}]]);const F=new class SearchService{constructor(){__publicField(this,"searchHistory",[]),__publicField(this,"popularQueries",new Map)}async search(e){const a=Date.now(),{query:t,type:s="all",limit:l=20,offset:o=0}=e;try{let l=[],o=0,r={categories:[],tags:[],priceRanges:[]};switch(this.addToHistory(t,s),s){case"tools":const a=await this.searchTools(e);l=a.items,o=a.total,r=a.facets;break;case"products":const t=await this.searchProducts(e);l=t.items,o=t.total,r=t.facets;break;case"categories":const s=await this.searchCategories(e);l=s.items,o=s.total;break;default:const n=await this.searchAll(e);l=n.items,o=n.total,r=n.facets}const n=await this.generateSuggestions(t,s);return{items:l,total:o,query:t,suggestions:n,facets:r,searchTime:Date.now()-a}}catch(r){throw console.error("搜索失败:",r),r}}async searchTools(e){const{query:a,category:t,tags:s,sortBy:l="relevance",sortOrder:o="desc",limit:r=20,offset:n=0}=e;let c=C.from(q.TOOLS).select("\n        *,\n        categories!inner(name, icon, color),\n        tool_tags!inner(tags!inner(name, color))\n      ",{count:"exact"});a&&(c=c.or(`\n        name.ilike.%${a}%,\n        description.ilike.%${a}%,\n        meta_title.ilike.%${a}%,\n        meta_description.ilike.%${a}%\n      `)),t&&(c=c.eq("category_id",t)),s&&s.length>0&&(c=c.in("tool_tags.tag_id",s)),c=c.eq("status","active"),"relevance"===l&&a?(c=c.order("is_featured",{ascending:!1}),c=c.order("click_count",{ascending:!1})):c=c.order(l,{ascending:"asc"===o}),c=c.range(n,n+r-1);const{data:i,error:u,count:d}=await c;if(u)throw u;return{items:i||[],total:d||0,facets:await this.generateToolsFacets(a,t,s)}}async searchProducts(e){const{query:a,category:t,priceRange:s,sortBy:l="relevance",sortOrder:o="desc",limit:r=20,offset:n=0}=e;let c=C.from(q.PRODUCTS).select("\n        *,\n        product_categories!inner(name, icon, color)\n      ",{count:"exact"});a&&(c=c.or(`\n        name.ilike.%${a}%,\n        description.ilike.%${a}%,\n        short_description.ilike.%${a}%,\n        meta_title.ilike.%${a}%,\n        meta_description.ilike.%${a}%\n      `)),t&&(c=c.eq("category_id",t)),s&&(c=c.gte("price",s[0]).lte("price",s[1])),c=c.eq("status","active"),c="relevance"===l&&a?c.order("is_featured",{ascending:!1}):c.order(l,{ascending:"asc"===o}),c=c.range(n,n+r-1);const{data:i,error:u,count:d}=await c;if(u)throw u;return{items:i||[],total:d||0,facets:await this.generateProductsFacets(a,t,s)}}async searchCategories(e){const{query:a,limit:t=20,offset:s=0}=e;let l=C.from(q.CATEGORIES).select("*",{count:"exact"});a&&(l=l.or(`\n        name.ilike.%${a}%,\n        description.ilike.%${a}%\n      `)),l=l.eq("is_active",!0).order("sort_order",{ascending:!0}).range(s,s+t-1);const{data:o,error:r,count:n}=await l;if(r)throw r;return{items:o||[],total:n||0}}async searchAll(e){const{limit:a=20}=e,[t,s,l]=await Promise.all([this.searchTools({...e,limit:Math.ceil(a/3)}),this.searchProducts({...e,limit:Math.ceil(a/3)}),this.searchCategories({...e,limit:Math.ceil(a/3)})]);return{items:[...t.items.map(e=>({...e,_type:"tool"})),...s.items.map(e=>({...e,_type:"product"})),...l.items.map(e=>({...e,_type:"category"}))],total:t.total+s.total+l.total,facets:{categories:[...t.facets.categories,...s.facets.categories],tags:t.facets.tags,priceRanges:s.facets.priceRanges}}}async generateToolsFacets(e,a,t){const s=C.from(q.CATEGORIES).select("\n        id, name,\n        tools!inner(id)\n      ",{count:"exact"}).eq("is_active",!0);e&&s.or(`\n        tools.name.ilike.%${e}%,\n        tools.description.ilike.%${e}%\n      `);const{data:l}=await s,o=(l||[]).map(e=>{var a;return{name:e.name,count:(null==(a=e.tools)?void 0:a.length)||0}}),r=C.from(q.TAGS).select("\n        id, name,\n        tool_tags!inner(tools!inner(id))\n      ",{count:"exact"});e&&r.or(`\n        tool_tags.tools.name.ilike.%${e}%,\n        tool_tags.tools.description.ilike.%${e}%\n      `);const{data:n}=await r;return{categories:o,tags:(n||[]).map(e=>{var a;return{name:e.name,count:(null==(a=e.tool_tags)?void 0:a.length)||0}}),priceRanges:[]}}async generateProductsFacets(e,a,t){const s=C.from(q.PRODUCT_CATEGORIES).select("\n        id, name,\n        products!inner(id)\n      ",{count:"exact"});e&&s.or(`\n        products.name.ilike.%${e}%,\n        products.description.ilike.%${e}%\n      `);const{data:l}=await s;return{categories:(l||[]).map(e=>{var a;return{name:e.name,count:(null==(a=e.products)?void 0:a.length)||0}}),tags:[],priceRanges:[{range:"0-50",count:0},{range:"50-100",count:0},{range:"100-500",count:0},{range:"500+",count:0}]}}async generateSuggestions(e,a){if(!e||e.length<2)return[];const t=[];try{const{data:a}=await C.from(q.TOOLS).select("name").ilike("name",`%${e}%`).eq("status","active").limit(5);null==a||a.forEach(e=>{t.includes(e.name)||t.push(e.name)});const{data:s}=await C.from(q.PRODUCTS).select("name").ilike("name",`%${e}%`).eq("status","active").limit(5);null==s||s.forEach(e=>{t.includes(e.name)||t.push(e.name)});const{data:l}=await C.from(q.CATEGORIES).select("name").ilike("name",`%${e}%`).eq("is_active",!0).limit(3);null==l||l.forEach(e=>{t.includes(e.name)||t.push(e.name)})}catch(s){console.error("生成搜索建议失败:",s)}return t.slice(0,8)}async getPopularSearches(e=10){return Array.from(this.popularQueries.entries()).sort((e,a)=>a[1]-e[1]).slice(0,e).map(([e])=>e)}getSearchHistory(e=10){return this.searchHistory.sort((e,a)=>a.timestamp.getTime()-e.timestamp.getTime()).slice(0,e)}clearSearchHistory(){this.searchHistory=[],localStorage.removeItem("search_history")}saveHistoryToStorage(){try{localStorage.setItem("search_history",JSON.stringify(this.searchHistory))}catch(e){console.error("保存搜索历史失败:",e)}}loadHistoryFromStorage(){try{const e=localStorage.getItem("search_history");if(e){const a=JSON.parse(e);this.searchHistory=a.map(e=>({...e,timestamp:new Date(e.timestamp)}))}}catch(e){console.error("加载搜索历史失败:",e),this.searchHistory=[]}}addToHistory(e,a){const t={id:Date.now().toString(),query:e,type:a,timestamp:new Date,results_count:0};this.searchHistory=this.searchHistory.filter(t=>t.query!==e||t.type!==a),this.searchHistory.unshift(t),this.searchHistory.length>50&&(this.searchHistory=this.searchHistory.slice(0,50));const s=this.popularQueries.get(e)||0;this.popularQueries.set(e,s+1)}async getSmartSuggestions(e){const a=[];if(!e||e.length<2){return(await this.getPopularSearches(5)).map(e=>({text:e,type:"query"}))}try{(await this.generateSuggestions(e,"all")).forEach(e=>{a.push({text:e,type:"query"})});const{data:t}=await C.from(q.CATEGORIES).select("name").ilike("name",`%${e}%`).eq("is_active",!0).limit(3);null==t||t.forEach(e=>{a.push({text:e.name,type:"category"})});const{data:s}=await C.from(q.TAGS).select("name").ilike("name",`%${e}%`).limit(3);null==s||s.forEach(e=>{a.push({text:e.name,type:"tag"})})}catch(t){console.error("获取智能建议失败:",t)}return a.slice(0,10)}},G={class:"search-input-container"},V={class:"search-input-wrapper"},j=["placeholder"],Q={class:"search-actions"},L={key:0,class:"suggestions-dropdown"},z={key:0,class:"suggestions-section"},J=["onClick","onMouseenter"],N={class:"suggestion-text"},K={class:"suggestion-type"},Z={key:1,class:"suggestions-section"},W=["onClick","onMouseenter"],X={class:"suggestion-text"},Y={class:"suggestion-meta"},ee={key:2,class:"suggestions-section"},ae={class:"popular-searches"},te=["onClick"],se={key:0,class:"advanced-search-panel"},le={class:"advanced-search-content"},oe={class:"advanced-row"},re={class:"advanced-group"},ne=["value"],ce={class:"advanced-group"},ie={class:"advanced-group"},ue={key:0,class:"advanced-row"},de={class:"advanced-group"},ve={class:"price-range"},pe={class:"advanced-row"},ge={class:"advanced-group full-width"},he={class:"tags-input"},me={class:"selected-tags"},ye=["onClick"],fe={key:0,class:"tags-dropdown"},ke=["onClick"],we={key:1,class:"search-status"},be={key:2,class:"search-stats"},_e=P(a({__name:"EnhancedSearchBox",props:{placeholder:{default:"搜索工具、产品、分类..."},autoFocus:{type:Boolean,default:!1},showAdvanced:{type:Boolean,default:!1},defaultType:{default:"all"}},emits:["search","clear","focus","blur"],setup(e,{expose:a,emit:x}){const C=e,q=x,P=H(),_e=M(),Se=t(),Te=t(""),xe=t(C.defaultType),Ce=t(!1),qe=t(!1),Me=t(!1),$e=t(C.showAdvanced),Oe=t(!1),Ee=t(-1),He=t([]),Re=t([]),Ae=t([]),Pe=t({category:"",sortBy:"relevance",sortOrder:"desc",priceMin:null,priceMax:null}),De=t([]),Ie=t(""),Be=t([]),Ue=t(null),Fe=s(()=>_e.categories),Ge=s(()=>[...He.value,...Re.value.map(e=>({text:e.query,type:"query"}))]),handleFocus=()=>{Ce.value=!0,qe.value=!0,Me.value=!0,q("focus"),loadSuggestions()},handleBlur=()=>{setTimeout(()=>{Ce.value=!1,Me.value=!1,Ee.value=-1},200),q("blur")},handleInput=()=>{Ee.value=-1,Ve()},handleKeydown=e=>{var a;switch(e.key){case"ArrowDown":e.preventDefault(),Ee.value=Math.min(Ee.value+1,Ge.value.length-1);break;case"ArrowUp":e.preventDefault(),Ee.value=Math.max(Ee.value-1,-1);break;case"Enter":e.preventDefault(),Ee.value>=0?selectSuggestion(Ge.value[Ee.value].text):performSearch();break;case"Escape":null==(a=Se.value)||a.blur()}},loadSuggestions=async()=>{try{Te.value?He.value=await F.getSmartSuggestions(Te.value):(He.value=[],Re.value=F.getSearchHistory(5),Ae.value=await F.getPopularSearches(8))}catch(e){console.error("加载搜索建议失败:",e)}},Ve=R(loadSuggestions,300),selectSuggestion=e=>{Te.value=e,Me.value=!1,performSearch()},performSearch=async()=>{if(Te.value.trim())try{Oe.value=!0;const e={query:Te.value.trim(),type:xe.value,category:Pe.value.category||void 0,tags:De.value.map(e=>e.id),priceRange:Pe.value.priceMin&&Pe.value.priceMax?[Pe.value.priceMin,Pe.value.priceMax]:void 0,sortBy:Pe.value.sortBy,sortOrder:Pe.value.sortOrder,limit:20},a=await F.search(e);Ue.value=a,q("search",a),P.push({name:"SearchResults",query:{q:Te.value,type:xe.value,...Pe.value}})}catch(e){console.error("搜索失败:",e)}finally{Oe.value=!1}},clearSearch=()=>{var e;Te.value="",Ue.value=null,q("clear"),null==(e=Se.value)||e.focus()},clearHistory=()=>{F.clearSearchHistory(),Re.value=[]},toggleAdvanced=()=>{$e.value=!$e.value,qe.value=$e.value},resetFilters=()=>{Pe.value={category:"",sortBy:"relevance",sortOrder:"desc",priceMin:null,priceMax:null},De.value=[]},applyFilters=()=>{Te.value&&performSearch()},searchTags=async()=>{Ie.value||(Be.value=[])},getSuggestionIcon=e=>{switch(e){case"category":return I;case"tag":return U;case"tool":case"product":return A;default:return B}},getSuggestionTypeText=e=>{switch(e){case"category":return"分类";case"tag":return"标签";case"tool":return"工具";case"product":return"产品";default:return"搜索"}},formatTime=e=>{const a=(new Date).getTime()-e.getTime(),t=Math.floor(a/6e4),s=Math.floor(a/36e5),l=Math.floor(a/864e5);return t<1?"刚刚":t<60?`${t}分钟前`:s<24?`${s}小时前`:`${l}天前`};return l(async()=>{var e;C.autoFocus&&(await o(),null==(e=Se.value)||e.focus()),0===_e.categories.length&&await _e.initialize()}),r(Te,()=>{Te.value||(Ue.value=null)}),a({focus:()=>{var e;return null==(e=Se.value)?void 0:e.focus()},clear:clearSearch,search:performSearch}),(e,a)=>(T(),n("div",{class:c(["enhanced-search-box",{"is-focused":Ce.value,"is-expanded":qe.value}])},[i("div",G,[i("div",V,[d(p($),{class:"search-icon"}),v(i("input",{ref_key:"searchInput",ref:Se,"onUpdate:modelValue":a[0]||(a[0]=e=>Te.value=e),type:"text",class:"search-input",placeholder:e.placeholder,onFocus:handleFocus,onBlur:handleBlur,onKeydown:handleKeydown,onInput:handleInput},null,40,j),[[g,Te.value]]),i("div",Q,[v(i("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>xe.value=e),class:"search-type-select"},a[8]||(a[8]=[i("option",{value:"all"},"全部",-1),i("option",{value:"tools"},"工具",-1),i("option",{value:"products"},"产品",-1),i("option",{value:"categories"},"分类",-1)]),512),[[h,xe.value]]),Te.value?(T(),n("button",{key:0,class:"clear-button",type:"button",onClick:clearSearch},[d(p(O),{class:"icon"})])):u("",!0),i("button",{class:c(["advanced-button",{active:$e.value}]),type:"button",onClick:toggleAdvanced},[d(p(D),{class:"icon"})],2)])]),Me.value&&(He.value.length>0||Re.value.length>0)?(T(),n("div",L,[He.value.length>0?(T(),n("div",z,[a[9]||(a[9]=i("div",{class:"suggestions-header"},"搜索建议",-1)),(T(!0),n(m,null,y(He.value,(e,a)=>(T(),n("div",{key:`suggestion-${a}`,class:c(["suggestion-item",{active:Ee.value===a}]),onClick:a=>selectSuggestion(e.text),onMouseenter:e=>Ee.value=a},[(T(),f(k(getSuggestionIcon(e.type)),{class:"suggestion-icon"})),i("span",N,w(e.text),1),i("span",K,w(getSuggestionTypeText(e.type)),1)],42,J))),128))])):u("",!0),Re.value.length>0&&!Te.value?(T(),n("div",Z,[i("div",{class:"suggestions-header"},[a[10]||(a[10]=i("span",null,"最近搜索",-1)),i("button",{class:"clear-history-button",onClick:clearHistory}," 清除 ")]),(T(!0),n(m,null,y(Re.value,(e,a)=>(T(),n("div",{key:`history-${e.id}`,class:c(["suggestion-item history-item",{active:Ee.value===He.value.length+a}]),onClick:a=>selectSuggestion(e.query),onMouseenter:e=>Ee.value=He.value.length+a},[d(p(E),{class:"suggestion-icon"}),i("span",X,w(e.query),1),i("span",Y,w(formatTime(e.timestamp)),1)],42,W))),128))])):u("",!0),Ae.value.length>0&&!Te.value?(T(),n("div",ee,[a[11]||(a[11]=i("div",{class:"suggestions-header"},"热门搜索",-1)),i("div",ae,[(T(!0),n(m,null,y(Ae.value,e=>(T(),n("button",{key:e,class:"popular-search-tag",onClick:a=>selectSuggestion(e)},w(e),9,te))),128))])])):u("",!0)])):u("",!0)]),$e.value?(T(),n("div",se,[i("div",le,[i("div",oe,[i("div",re,[a[13]||(a[13]=i("label",{class:"advanced-label"},"分类",-1)),v(i("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>Pe.value.category=e),class:"advanced-select"},[a[12]||(a[12]=i("option",{value:""},"所有分类",-1)),(T(!0),n(m,null,y(Fe.value,e=>(T(),n("option",{key:e.id,value:e.id},w(e.name),9,ne))),128))],512),[[h,Pe.value.category]])]),i("div",ce,[a[15]||(a[15]=i("label",{class:"advanced-label"},"排序",-1)),v(i("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>Pe.value.sortBy=e),class:"advanced-select"},a[14]||(a[14]=[b('<option value="relevance" data-v-0cd19e63>相关性</option><option value="name" data-v-0cd19e63>名称</option><option value="created_at" data-v-0cd19e63>创建时间</option><option value="click_count" data-v-0cd19e63>热度</option><option value="price" data-v-0cd19e63>价格</option>',5)]),512),[[h,Pe.value.sortBy]])]),i("div",ie,[a[17]||(a[17]=i("label",{class:"advanced-label"},"顺序",-1)),v(i("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>Pe.value.sortOrder=e),class:"advanced-select"},a[16]||(a[16]=[i("option",{value:"desc"},"降序",-1),i("option",{value:"asc"},"升序",-1)]),512),[[h,Pe.value.sortOrder]])])]),"products"===xe.value?(T(),n("div",ue,[i("div",de,[a[19]||(a[19]=i("label",{class:"advanced-label"},"价格范围",-1)),i("div",ve,[v(i("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>Pe.value.priceMin=e),type:"number",placeholder:"最低价",class:"price-input",min:"0"},null,512),[[g,Pe.value.priceMin,void 0,{number:!0}]]),a[18]||(a[18]=i("span",{class:"price-separator"},"-",-1)),v(i("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Pe.value.priceMax=e),type:"number",placeholder:"最高价",class:"price-input",min:"0"},null,512),[[g,Pe.value.priceMax,void 0,{number:!0}]])])])])):u("",!0),i("div",pe,[i("div",ge,[a[20]||(a[20]=i("label",{class:"advanced-label"},"标签",-1)),i("div",he,[i("div",me,[(T(!0),n(m,null,y(De.value,e=>(T(),n("span",{key:e.id,class:"selected-tag"},[_(w(e.name)+" ",1),i("button",{class:"remove-tag",onClick:a=>(e=>{De.value=De.value.filter(a=>a.id!==e.id)})(e)},[d(p(O),{class:"icon"})],8,ye)]))),128))]),v(i("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>Ie.value=e),type:"text",placeholder:"输入标签名称...",class:"tag-input",onInput:searchTags},null,544),[[g,Ie.value]]),Be.value.length>0?(T(),n("div",fe,[(T(!0),n(m,null,y(Be.value,e=>(T(),n("div",{key:e.id,class:"tag-option",onClick:a=>(e=>{De.value.find(a=>a.id===e.id)||De.value.push(e),Ie.value="",Be.value=[]})(e)},[i("span",{class:"tag-color",style:S({backgroundColor:e.color})},null,4),_(" "+w(e.name),1)],8,ke))),128))])):u("",!0)])])]),i("div",{class:"advanced-actions"},[i("button",{class:"reset-button",onClick:resetFilters},"重置"),i("button",{class:"apply-button",onClick:applyFilters},"应用筛选")])])])):u("",!0),Oe.value?(T(),n("div",we,a[21]||(a[21]=[i("div",{class:"search-loading"},[i("div",{class:"loading-spinner"}),i("span",null,"搜索中...")],-1)]))):u("",!0),Ue.value?(T(),n("div",be," 找到 "+w(Ue.value.total)+" 个结果，用时 "+w(Ue.value.searchTime)+"ms ",1)):u("",!0)],2))}}),[["__scopeId","data-v-0cd19e63"]]);export{_e as E,F as s};
