import{e,r as t,c as r}from"./vendor-DVQ19h0E.js";import{s as o,T as a,h as c}from"./index-BqZfy5yB.js";const n={TOOLS:"local_tools",CATEGORIES:"local_categories",USER_PREFERENCES:"user_preferences",THEME_CONFIG:"theme_config",OFFLINE_QUEUE:"offline_queue",LAST_SYNC:"last_sync_time",APP_CONFIG:"app_config"};class s{static getLocalTools(){try{const e=localStorage.getItem(n.TOOLS);return e?JSON.parse(e):[]}catch(e){return console.error("获取本地工具数据失败:",e),[]}}static saveLocalTools(e){try{localStorage.setItem(n.TOOLS,JSON.stringify(e))}catch(t){console.error("保存本地工具数据失败:",t)}}static addLocalTool(e){const t={...e,localId:`local_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,isLocal:!0,lastModified:(new Date).toISOString(),syncStatus:"pending"},r=this.getLocalTools();return r.push(t),this.saveLocalTools(r),this.addOfflineAction({type:"create",entity:"tool",data:t}),t}static updateLocalTool(e,t){try{const r=this.getLocalTools(),o=r.findIndex(t=>t.id===e||t.localId===e);return-1!==o&&(r[o]={...r[o],...t,lastModified:(new Date).toISOString(),syncStatus:"pending"},this.saveLocalTools(r),this.addOfflineAction({type:"update",entity:"tool",data:{id:e,updates:t}}),!0)}catch(r){return console.error("更新本地工具失败:",r),!1}}static deleteLocalTool(e){try{const t=this.getLocalTools(),r=t.findIndex(t=>t.id===e||t.localId===e);if(-1===r)return!1;const o=t[r];return t.splice(r,1),this.saveLocalTools(t),this.addOfflineAction({type:"delete",entity:"tool",data:{id:o.id||o.localId}}),!0}catch(t){return console.error("删除本地工具失败:",t),!1}}static getLocalCategories(){try{const e=localStorage.getItem(n.CATEGORIES);return e?JSON.parse(e):[]}catch(e){return console.error("获取本地分类数据失败:",e),[]}}static saveLocalCategories(e){try{localStorage.setItem(n.CATEGORIES,JSON.stringify(e))}catch(t){console.error("保存本地分类数据失败:",t)}}static getUserPreferences(){try{const e=localStorage.getItem(n.USER_PREFERENCES),t={theme:"auto",language:"zh-CN",sidebarCollapsed:!1,defaultView:"grid",autoSync:!0,offlineMode:!1};return e?{...t,...JSON.parse(e)}:t}catch(e){return console.error("获取用户偏好设置失败:",e),{theme:"auto",language:"zh-CN",sidebarCollapsed:!1,defaultView:"grid",autoSync:!0,offlineMode:!1}}}static saveUserPreferences(e){try{const t={...this.getUserPreferences(),...e};localStorage.setItem(n.USER_PREFERENCES,JSON.stringify(t))}catch(t){console.error("保存用户偏好设置失败:",t)}}static getOfflineQueue(){try{const e=localStorage.getItem(n.OFFLINE_QUEUE);return e?JSON.parse(e):[]}catch(e){return console.error("获取离线队列失败:",e),[]}}static addOfflineAction(e){try{const t=this.getOfflineQueue(),r={...e,id:`action_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:(new Date).toISOString()};t.push(r),localStorage.setItem(n.OFFLINE_QUEUE,JSON.stringify(t))}catch(t){console.error("添加离线操作失败:",t)}}static clearOfflineQueue(){try{localStorage.removeItem(n.OFFLINE_QUEUE)}catch(e){console.error("清空离线队列失败:",e)}}static getLastSyncTime(){return localStorage.getItem(n.LAST_SYNC)}static setLastSyncTime(e=(new Date).toISOString()){localStorage.setItem(n.LAST_SYNC,e)}static clearAllLocalData(){try{Object.values(n).forEach(e=>{localStorage.removeItem(e)})}catch(e){console.error("清空本地数据失败:",e)}}static getStorageInfo(){try{let e=0;for(const r in localStorage)localStorage.hasOwnProperty(r)&&(e+=localStorage[r].length);const t=5242880;return{used:e,total:t,percentage:e/t*100}}catch(e){return console.error("获取存储信息失败:",e),{used:0,total:0,percentage:0}}}}function i(e){var t;return(null==(t=e.category)?void 0:t.id)?e.category.id:e.categoryId?e.categoryId:e.category_id?e.category_id:null}const l="active";class d{static async getTools(e){try{let t=o.from(a.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",l);(null==e?void 0:e.query)&&(t=t.or(`name.ilike.%${e.query}%,description.ilike.%${e.query}%`)),(null==e?void 0:e.category)&&"all"!==e.category&&(t=t.eq("category_id",e.category));const r=(null==e?void 0:e.sortBy)||"sort_order",n=(null==e?void 0:e.sortOrder)||"asc";t=t.order(r,{ascending:"asc"===n});const s=(null==e?void 0:e.page)||1,i=(null==e?void 0:e.limit)||20,d=(s-1)*i;t=t.range(d,d+i-1);const{data:u,error:g,count:f}=await t;if(g)throw new Error(c(g));return{items:(u||[]).map(this.transformToolRow),total:f||0,page:s,limit:i,hasMore:(f||0)>d+i}}catch(t){throw console.error("Error fetching tools:",t),t}}static async getTool(e){try{const{data:t,error:r}=await o.from(a.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("id",e).single();if(r)throw new Error(c(r));return this.transformToolRow(t)}catch(t){throw console.error("Error fetching tool:",t),t}}static async createTool(e){try{!function(e,t,r="Entity"){const o=[];for(const a of t)e[a]||o.push(a);if(o.length>0)throw new Error(`${r} validation failed: missing required fields: ${o.join(", ")}`)}(e,["name","description","url"],"Tool");const t=function(e,t="Category"){const r=i(e);if(!r)throw new Error(`${t} is required`);return r}(e),{data:r,error:n}=await o.from(a.TOOLS).insert({name:e.name,description:e.description,url:e.url,category_id:t,icon:e.icon,is_featured:e.is_featured||!1,status:l,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order||0}).select("\n          *,\n          category:categories(*)\n        ").single();if(n)throw new Error(c(n));return this.transformToolRow(r)}catch(t){throw console.error("Error creating tool:",t),t}}static async updateTool(e,t){try{const r={};t.name&&(r.name=t.name),t.description&&(r.description=t.description),t.url&&(r.url=t.url);const n=i(t);n&&(r.category_id=n),void 0!==t.icon&&(r.icon=t.icon),void 0!==t.is_featured&&(r.is_featured=t.is_featured),t.status&&(r.status=t.status),void 0!==t.meta_title&&(r.meta_title=t.meta_title),void 0!==t.meta_description&&(r.meta_description=t.meta_description),void 0!==t.sort_order&&(r.sort_order=t.sort_order),r.updated_at=(new Date).toISOString();const{data:s,error:l}=await o.from(a.TOOLS).update(r).eq("id",e).select("\n          *,\n          category:categories(*)\n        ").single();if(l)throw new Error(c(l));return this.transformToolRow(s)}catch(r){throw console.error("Error updating tool:",r),r}}static async deleteTool(e){try{const{error:t}=await o.from(a.TOOLS).delete().eq("id",e);if(t)throw new Error(c(t))}catch(t){throw console.error("Error deleting tool:",t),t}}static async incrementClickCount(e){try{const{error:t}=await o.rpc("increment_click_count",{tool_id:e});if(t)throw new Error(c(t))}catch(t){throw console.error("Error incrementing click count:",t),t}}static async updateFavoriteStatus(e,t){try{const{error:r}=await o.from(a.TOOLS).update({is_favorite:t,updated_at:(new Date).toISOString()}).eq("id",e);if(r)throw new Error(c(r))}catch(r){throw console.error("Error updating favorite status:",r),r}}static async getPopularTools(e=10){try{const{data:t,error:r}=await o.from(a.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",l).order("click_count",{ascending:!1}).limit(e);if(r)throw new Error(c(r));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching popular tools:",t),t}}static async getFeaturedTools(e=6){try{const{data:t,error:r}=await o.from(a.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",l).eq("is_featured",!0).order("sort_order",{ascending:!0}).limit(e);if(r)throw new Error(c(r));return(t||[]).map(this.transformToolRow)}catch(t){throw console.error("Error fetching featured tools:",t),t}}static async searchTools(e,t=20){try{const{data:r,error:n}=await o.from(a.TOOLS).select("\n          *,\n          category:categories(*)\n        ").eq("status",l).or(`name.ilike.%${e}%,description.ilike.%${e}%`).order("click_count",{ascending:!1}).limit(t);if(n)throw new Error(c(n));return(r||[]).map(this.transformToolRow)}catch(r){throw console.error("Error searching tools:",r),r}}static transformToolRow(e){return{id:e.id,name:e.name,description:e.description,url:e.url,icon:e.icon,category_id:e.category_id,tags:[],is_favorite:e.is_favorite,click_count:e.click_count,is_featured:e.is_featured,status:e.status,created_at:e.created_at,updated_at:e.updated_at,created_by:e.created_by,meta_title:e.meta_title,meta_description:e.meta_description,sort_order:e.sort_order}}}class u{static async getCategories(){try{const{data:e,error:t}=await o.from(a.CATEGORIES).select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(t)throw new Error(c(t));const r=(e||[]).map(this.transformCategoryRow);return this.buildCategoryTree(r)}catch(e){throw console.error("Error fetching categories:",e),e}}static async getCategory(e){try{const{data:t,error:r}=await o.from(a.CATEGORIES).select("*").eq("id",e).single();if(r)throw new Error(c(r));return this.transformCategoryRow(t)}catch(t){throw console.error("Error fetching category:",t),t}}static async createCategory(e){try{const{data:t,error:r}=await o.from(a.CATEGORIES).insert({name:e.name,description:e.description,icon:e.icon,color:e.color,parent_id:e.parent_id,sort_order:e.sort_order||0,is_active:!0}).select().single();if(r)throw new Error(c(r));return this.transformCategoryRow(t)}catch(t){throw console.error("Error creating category:",t),t}}static async updateCategory(e,t){try{const r={};t.name&&(r.name=t.name),void 0!==t.description&&(r.description=t.description),t.icon&&(r.icon=t.icon),t.color&&(r.color=t.color),void 0!==t.parent_id&&(r.parent_id=t.parent_id),void 0!==t.sort_order&&(r.sort_order=t.sort_order),void 0!==t.is_active&&(r.is_active=t.is_active),r.updated_at=(new Date).toISOString();const{data:n,error:s}=await o.from(a.CATEGORIES).update(r).eq("id",e).select().single();if(s)throw new Error(c(s));return this.transformCategoryRow(n)}catch(r){throw console.error("Error updating category:",r),r}}static async deleteCategory(e){try{const{data:t,error:r}=await o.from(a.CATEGORIES).select("id").eq("parent_id",e);if(r)throw new Error(c(r));if(t&&t.length>0)throw new Error("无法删除包含子分类的分类，请先删除或移动子分类");const{data:n,error:s}=await o.from(a.TOOLS).select("id").eq("category_id",e);if(s)throw new Error(c(s));if(n&&n.length>0)throw new Error("无法删除包含工具的分类，请先删除或移动工具");const{error:i}=await o.from(a.CATEGORIES).delete().eq("id",e);if(i)throw new Error(c(i))}catch(t){throw console.error("Error deleting category:",t),t}}static async getCategoryStats(){try{const{data:e,error:t}=await o.from(a.TOOLS).select("category_id").eq("status","active");if(t)throw new Error(c(t));const r=new Map;return null==e||e.forEach(e=>{const t=r.get(e.category_id)||0;r.set(e.category_id,t+1)}),Array.from(r.entries()).map(([e,t])=>({categoryId:e,count:t}))}catch(e){throw console.error("Error fetching category stats:",e),e}}static async getCategoriesWithStats(){try{const[e,t]=await Promise.all([this.getCategories(),this.getCategoryStats()]),r=new Map(t.map(e=>[e.categoryId,e.count])),o=e=>{var t;const a=r.get(e.id)||0,c=(null==(t=e.children)?void 0:t.map(o))||[],n=c.reduce((e,t)=>e+t.count,0);return{...e,count:a+n,children:c}};return e.map(o)}catch(e){throw console.error("Error fetching categories with stats:",e),e}}static buildCategoryTree(e){const t=new Map,r=[];return e.forEach(e=>{t.set(e.id,{...e,children:[]})}),e.forEach(e=>{const o=t.get(e.id);if(e.parent_id){const a=t.get(e.parent_id);a?(a.children=a.children||[],a.children.push(o)):r.push(o)}else r.push(o)}),r}static transformCategoryRow(e){return{id:e.id,name:e.name,description:e.description,icon:e.icon,color:e.color,parentId:e.parent_id,count:0,sortOrder:e.sort_order,isActive:e.is_active,createdAt:e.created_at,updatedAt:e.updated_at}}}const g=e("localManagement",()=>{const e=t(!1),o=t(!1),a=t(null),c=t(null),n=t(s.getUserPreferences()),i=t([]),l=t([]),g=t([]),f=r(()=>g.value.length),h=r(()=>i.value.some(e=>"pending"===e.syncStatus)||l.value.some(e=>"pending"===e.syncStatus)),y=r(()=>s.getStorageInfo()),w=r(()=>navigator.onLine&&!e.value),p=async()=>{e.value=!1,n.value.autoSync&&f.value>0&&await S()},m=()=>{e.value=!0},_=e=>{try{s.saveUserPreferences(e),n.value=s.getUserPreferences()}catch(t){throw console.error("更新用户偏好失败:",t),t}},S=async()=>{if(!o.value&&w.value)try{o.value=!0,a.value=null;const e=s.getOfflineQueue();for(const r of e)await v(r);s.clearOfflineQueue(),g.value=[];const t=(new Date).toISOString();s.setLastSyncTime(t),c.value=t,T()}catch(e){throw console.error("数据同步失败:",e),a.value=e instanceof Error?e.message:"同步失败",e}finally{o.value=!1}},v=async e=>{try{switch(e.entity){case"tool":await E(e);break;case"category":await O(e);break;default:console.warn("未知的离线操作类型:",e)}}catch(t){throw console.error("处理离线操作失败:",e,t),t}},E=async e=>{switch(e.type){case"create":await d.createTool(e.data);break;case"update":await d.updateTool(e.data.id,e.data.updates);break;case"delete":await d.deleteTool(e.data.id)}},O=async e=>{switch(e.type){case"create":await u.createCategory(e.data);break;case"update":await u.updateCategory(e.data.id,e.data.updates);break;case"delete":await u.deleteCategory(e.data.id)}},T=()=>{i.value=i.value.map(e=>({...e,syncStatus:"synced"})),s.saveLocalTools(i.value),l.value=l.value.map(e=>({...e,syncStatus:"synced"})),s.saveLocalCategories(l.value)};return{isOfflineMode:e,isSyncing:o,syncError:a,lastSyncTime:c,userPreferences:n,localTools:i,localCategories:l,offlineQueue:g,pendingSyncCount:f,hasLocalChanges:h,storageInfo:y,isOnline:w,initialize:async()=>{try{i.value=s.getLocalTools(),l.value=s.getLocalCategories(),g.value=s.getOfflineQueue(),c.value=s.getLastSyncTime(),window.addEventListener("online",p),window.addEventListener("offline",m),w.value&&n.value.autoSync&&f.value>0&&await S()}catch(e){console.error("初始化本地管理失败:",e)}},addLocalTool:e=>{try{const t=s.addLocalTool(e);return i.value.push(t),g.value=s.getOfflineQueue(),t}catch(t){throw console.error("添加本地工具失败:",t),t}},updateLocalTool:(e,t)=>{try{const r=s.updateLocalTool(e,t);return r&&(i.value=s.getLocalTools(),g.value=s.getOfflineQueue()),r}catch(r){throw console.error("更新本地工具失败:",r),r}},deleteLocalTool:e=>{try{const t=s.deleteLocalTool(e);return t&&(i.value=s.getLocalTools(),g.value=s.getOfflineQueue()),t}catch(t){throw console.error("删除本地工具失败:",t),t}},updateUserPreferences:_,syncData:S,forceSyncData:async()=>{if(!w.value)throw new Error("网络不可用，无法同步数据");await S()},toggleOfflineMode:()=>{e.value=!e.value,_({offlineMode:e.value})},clearLocalData:()=>{try{s.clearAllLocalData(),i.value=[],l.value=[],g.value=[],c.value=null,n.value=s.getUserPreferences()}catch(e){throw console.error("清空本地数据失败:",e),e}},exportLocalData:()=>{try{const e={tools:i.value,categories:l.value,preferences:n.value,exportTime:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),r=URL.createObjectURL(t),o=document.createElement("a");o.href=r,o.download=`local-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}catch(e){throw console.error("导出本地数据失败:",e),e}},importLocalData:async e=>{try{const t=await e.text(),r=JSON.parse(t);r.tools&&(i.value=r.tools,s.saveLocalTools(r.tools)),r.categories&&(l.value=r.categories,s.saveLocalCategories(r.categories)),r.preferences&&_(r.preferences)}catch(t){throw console.error("导入本地数据失败:",t),t}}}});export{s as L,g as u};
