import{e as r,s as t,W as a,U as e,p as s,L as o,c as i,_ as n}from"./index-C5n2Pyp_.js";import{S as c}from"./shopping-bag-DTstFTsd.js";import{F as l}from"./file-text-C3be1PCc.js";import{H as u}from"./hard-drive-B-zRsjOx.js";import{H as d}from"./home-3i_VtAZY.js";import{d as h,o as w,m,q as f,y as v,M as _,E as p,u as g,L as y,A as E}from"./vendor-B_bmgS9f.js";
/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=r("BarChart3Icon",[["path",{d:"M3 3v18h18",key:"1s2lah"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);class b{static async getCurrentUser(){try{const{data:{user:r}}=await t.auth.getUser();if(!r)return null;const{data:a,error:e}=await t.from("user_profiles").select("*").eq("id",r.id).single();if(e){if("PGRST116"===e.code)return this.createUserProfile(r.id,r.email);throw e}return this.transformUser(a)}catch(r){return console.error("获取用户信息失败:",r),null}}static async getUserProfile(r){try{const{data:a,error:e}=await t.from("user_profiles").select("*").eq("id",r).single();if(e)throw e;return a?this.transformUser(a):null}catch(a){return console.error("获取用户资料失败:",a),null}}static async updateProfile(r,a){try{const e={full_name:a.full_name,username:a.username,bio:a.bio,website:a.website,location:a.location,updated_at:(new Date).toISOString()};if(a.avatar){const t=await this.uploadAvatar(r,a.avatar);e.avatar_url=t}const{data:s,error:o}=await t.from("user_profiles").update(e).eq("id",r).select("*").single();if(o)throw o;if(!s)throw new Error("更新用户资料失败");return this.transformUser(s)}catch(e){throw console.error("更新用户资料失败:",e),new Error("更新用户资料失败")}}static async createUserProfile(r,a){try{const e={id:r,email:a,role:"user",is_active:!0,email_verified:!1},{data:s,error:o}=await t.from("user_profiles").insert(e).select("*").single();if(o)throw o;if(!s)throw new Error("创建用户资料失败");return this.transformUser(s)}catch(e){throw console.error("创建用户资料失败:",e),new Error("创建用户资料失败")}}static async uploadAvatar(r,a){try{const e=a.name.split(".").pop(),s=`avatars/${`${r}-${Date.now()}.${e}`}`,{data:o}=await t.storage.from("avatars").list("",{search:r});if(o&&o.length>0){const r=o.map(r=>r.name);await t.storage.from("avatars").remove(r)}const{error:i}=await t.storage.from("avatars").upload(s,a);if(i)throw i;const{data:n}=t.storage.from("avatars").getPublicUrl(s);return n.publicUrl}catch(e){throw console.error("上传头像失败:",e),new Error("上传头像失败")}}static async updateLastLogin(r){try{const{error:a}=await t.from("user_profiles").update({last_login_at:(new Date).toISOString()}).eq("id",r);if(a)throw a}catch(a){console.error("更新最后登录时间失败:",a)}}static async checkUsernameAvailability(r,a){try{let e=t.from("user_profiles").select("id").eq("username",r);a&&(e=e.neq("id",a));const{data:s,error:o}=await e;if(o)throw o;return!s||0===s.length}catch(e){return console.error("检查用户名可用性失败:",e),!1}}static async getUserStats(r){try{const[a,e]=await Promise.all([t.from("favorites").select("tool_id, product_id").eq("user_id",r),t.from("orders").select("total_amount, status").eq("user_id",r)]),s=a.data||[],o=e.data||[],i=s.filter(r=>r.tool_id).length,n=s.filter(r=>r.product_id).length,c=o.length;return{favoriteToolsCount:i,favoriteProductsCount:n,ordersCount:c,totalSpent:o.filter(r=>"paid"===r.status).reduce((r,t)=>r+t.total_amount,0)}}catch(a){return console.error("获取用户统计信息失败:",a),{favoriteToolsCount:0,favoriteProductsCount:0,ordersCount:0,totalSpent:0}}}static async deleteAccount(r){try{await Promise.all([t.from("favorites").delete().eq("user_id",r),t.from("orders").delete().eq("user_id",r),t.from("user_profiles").delete().eq("id",r)]);const{error:a}=await t.auth.admin.deleteUser(r);if(a)throw a}catch(a){throw console.error("删除用户账户失败:",a),new Error("删除用户账户失败")}}static transformUser(r){return{id:r.id,email:r.email,username:r.username,full_name:r.full_name,avatar_url:r.avatar_url,bio:r.bio,website:r.website,location:r.location,role:r.role,is_active:r.is_active,email_verified:r.email_verified,created_at:r.created_at,updated_at:r.updated_at,last_login_at:r.last_login_at}}}class P{static async login(r){try{const{data:a,error:e}=await t.auth.signInWithPassword({email:r.email,password:r.password});if(e)throw e;if(!a.user)throw new Error("登录失败");await b.updateLastLogin(a.user.id);const s=await b.getCurrentUser();if(!s)throw new Error("获取用户信息失败");return{user:s,session:a.session}}catch(a){throw console.error("登录失败:",a),new Error(a instanceof Error?a.message:"登录失败")}}static async register(r){try{if(r.username){if(!(await b.checkUsernameAvailability(r.username)))throw new Error("用户名已被使用")}const{data:a,error:e}=await t.auth.signUp({email:r.email,password:r.password,options:{data:{full_name:r.fullName,username:r.username}}});if(e)throw e;if(!a.user)throw new Error("注册失败");const s=await b.createUserProfile(a.user.id,r.email);if(r.fullName||r.username){return{user:await b.updateProfile(a.user.id,{fullName:r.fullName,username:r.username}),session:a.session}}return{user:s,session:a.session}}catch(a){throw console.error("注册失败:",a),new Error(a instanceof Error?a.message:"注册失败")}}static async logout(){try{const{error:r}=await t.auth.signOut();if(r)throw r}catch(r){throw console.error("登出失败:",r),new Error("登出失败")}}static async forgotPassword(r){try{const{error:a}=await t.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/auth/reset-password`});if(a)throw a}catch(a){throw console.error("发送重置密码邮件失败:",a),new Error("发送重置密码邮件失败")}}static async resetPassword(r){try{const{error:a}=await t.auth.updateUser({password:r});if(a)throw a}catch(a){throw console.error("重置密码失败:",a),new Error("重置密码失败")}}static async changePassword(r){try{const{error:a}=await t.auth.updateUser({password:r});if(a)throw a}catch(a){throw console.error("更改密码失败:",a),new Error("更改密码失败")}}static async updateEmail(r){try{const{error:a}=await t.auth.updateUser({email:r});if(a)throw a}catch(a){throw console.error("更新邮箱失败:",a),new Error("更新邮箱失败")}}static async verifyEmail(r,a){try{const{error:e}=await t.auth.verifyOtp({token_hash:r,type:a});if(e)throw e}catch(e){throw console.error("验证邮箱失败:",e),new Error("验证邮箱失败")}}static async resendVerificationEmail(){try{const{data:{user:r}}=await t.auth.getUser();if(!r)throw new Error("用户未登录");const{error:a}=await t.auth.resend({type:"signup",email:r.email});if(a)throw a}catch(r){throw console.error("重新发送验证邮件失败:",r),new Error("重新发送验证邮件失败")}}static async getSession(){try{const{data:{session:r}}=await t.auth.getSession();return r}catch(r){return console.error("获取会话失败:",r),null}}static async refreshSession(){try{const{data:r,error:a}=await t.auth.refreshSession();if(a)throw a;return r.session}catch(r){throw console.error("刷新会话失败:",r),new Error("刷新会话失败")}}static async isAuthenticated(){try{const{data:{user:r}}=await t.auth.getUser();return!!r}catch(r){return!1}}static onAuthStateChange(r){return t.auth.onAuthStateChange(r)}static async signInWithGoogle(){try{const{error:r}=await t.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`}});if(r)throw r}catch(r){throw console.error("Google 登录失败:",r),new Error("Google 登录失败")}}static async signInWithGitHub(){try{const{error:r}=await t.auth.signInWithOAuth({provider:"github",options:{redirectTo:`${window.location.origin}/auth/callback`}});if(r)throw r}catch(r){throw console.error("GitHub 登录失败:",r),new Error("GitHub 登录失败")}}static async deleteAccount(){try{const{data:{user:r}}=await t.auth.getUser();if(!r)throw new Error("用户未登录");await b.deleteAccount(r.id)}catch(r){throw console.error("删除账户失败:",r),new Error("删除账户失败")}}}const S={class:"admin-view"},A={class:"admin-content"},C={class:"container"},k={class:"admin-layout"},q={class:"admin-nav"},I={class:"admin-main"},G=n(h({__name:"AdminView",setup(r){const t=i(),n=async()=>{try{await P.logout(),t.push("/")}catch(r){console.error("退出登录失败:",r)}};return w(()=>{(async()=>{try{const r=await b.getCurrentUser();if(!r||"admin"!==r.role&&"super_admin"!==r.role)return console.warn("管理员权限检查失败，重定向到首页"),void t.push("/")}catch(r){console.error("检查管理员权限失败:",r),t.push("/auth/login")}})()}),(r,t)=>{const i=y("router-link"),h=y("router-view");return E(),m("div",S,[t[10]||(t[10]=f("div",{class:"admin-header"},[f("div",{class:"container"},[f("h1",null,"管理后台"),f("p",null,"系统管理和数据统计")])],-1)),f("div",A,[f("div",C,[f("div",k,[f("nav",q,[v(i,{to:"/admin/dashboard",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(U),{class:"nav-icon"}),t[0]||(t[0]=p(" 仪表盘 "))]),_:1,__:[0]}),v(i,{to:"/admin/tools",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(a),{class:"nav-icon"}),t[1]||(t[1]=p(" 工具管理 "))]),_:1,__:[1]}),v(i,{to:"/admin/products",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(c),{class:"nav-icon"}),t[2]||(t[2]=p(" 产品管理 "))]),_:1,__:[2]}),v(i,{to:"/admin/users",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(e),{class:"nav-icon"}),t[3]||(t[3]=p(" 用户管理 "))]),_:1,__:[3]}),v(i,{to:"/admin/orders",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(l),{class:"nav-icon"}),t[4]||(t[4]=p(" 订单管理 "))]),_:1,__:[4]}),v(i,{to:"/admin/local",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(u),{class:"nav-icon"}),t[5]||(t[5]=p(" 本地管理 "))]),_:1,__:[5]}),v(i,{to:"/admin/settings",class:"nav-item","active-class":"active"},{default:_(()=>[v(g(s),{class:"nav-icon"}),t[6]||(t[6]=p(" 系统设置 "))]),_:1,__:[6]}),t[9]||(t[9]=f("div",{class:"nav-divider"},null,-1)),v(i,{to:"/",class:"nav-item"},{default:_(()=>[v(g(d),{class:"nav-icon"}),t[7]||(t[7]=p(" 返回首页 "))]),_:1,__:[7]}),f("button",{class:"nav-item logout-btn",onClick:n},[v(g(o),{class:"nav-icon"}),t[8]||(t[8]=p(" 退出登录 "))])]),f("main",I,[v(h)])])])])])}}}),[["__scopeId","data-v-64a02da0"]]);export{G as default};
