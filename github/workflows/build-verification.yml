name: Build and Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'
          cache: 'npm'
        timeout-minutes: 2

      - name: Install dependencies (npm ci)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (npm ci)..."
          npm ci
        timeout-minutes: 5

      - name: Type check
        run: npm run type-check
        timeout-minutes: 3

      - name: Run tests
        run: npm test
        timeout-minutes: 5

      - name: Build
        run: npm run build
        timeout-minutes: 5

      - name: Deploy
        run: npm run deploy
        timeout-minutes: 5

  verification:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'
          cache: 'npm'
        timeout-minutes: 2

      - name: Install dependencies (npm ci)
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (npm ci)..."
          npm ci
        timeout-minutes: 5

      - name: Type check
        run: npm run type-check
        timeout-minutes: 3

      - name: Run tests
        run: npm test
        timeout-minutes: 5

      - name: Health Check - Accessibility
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        run: |
          echo "â±ï¸ ç«™ç‚¹å¯è®¿é—®æ€§æ£€æŸ¥å¼€å§‹: $(date)"
          URL="https://ramusi.cn"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$code" = "200" ]; then
            echo "âœ… å¯è®¿é—® (HTTP $code)"
          else
            echo "âŒ è®¿é—®å¤±è´¥ (HTTP $code)"
            exit 1
          fi
          echo "â±ï¸ å®Œæˆ: $(date)"

      - name: Health Check - Basic Content
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        run: |
          echo "â±ï¸ å†…å®¹æ£€æŸ¥å¼€å§‹: $(date)"
          content=$(curl -s https://ramusi.cn)
          if echo "$content" | grep -qi "Ramusi"; then
            echo "âœ… å…³é”®å†…å®¹å­˜åœ¨"
          else
            echo "âŒ æœªæ‰¾åˆ°å…³é”®å†…å®¹: Ramusi"
            exit 1
          fi
          echo "â±ï¸ å®Œæˆ: $(date)"

      - name: Health Check Summary
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        run: |
          echo "ğŸ“Š å¥åº·æ£€æŸ¥å®Œæˆ (å¯è®¿é—®æ€§ + å†…å®¹)"