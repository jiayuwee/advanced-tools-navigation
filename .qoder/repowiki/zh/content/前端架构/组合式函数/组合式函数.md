# 组合式函数

<cite>
**本文档引用的文件**   
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [AdvancedSearchPanel.vue](file://src/components/search/AdvancedSearchPanel.vue)
- [SimpleThemeSelector.vue](file://src/components/theme/SimpleThemeSelector.vue)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue)
- [notificationService.ts](file://src/services/notificationService.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细阐述了组合式函数（Composables）在逻辑复用与关注点分离中的核心作用。重点分析了`useRealtime.ts`如何利用Supabase Realtime API建立WebSocket连接并监听数据库变更，实现通知与数据同步；`useAdvancedSearch.ts`如何封装搜索参数构建、过滤逻辑与结果缓存机制；以及`useSimpleTheme.ts`如何管理主题切换状态并与CSS变量联动。文档还展示了这些composables在组件中如何通过ref响应式引用，并提供错误边界处理、资源清理和测试模拟的指导方案。

## 项目结构
本项目采用标准的Vue 3 + TypeScript架构，组合式函数集中存放在`src/composables`目录下，服务逻辑位于`src/services`目录，UI组件按功能模块组织在`src/components`目录中。这种结构清晰地分离了不同关注点，便于维护和扩展。

```mermaid
graph TB
subgraph "组合式函数"
A[useRealtime.ts]
B[useAdvancedSearch.ts]
C[useSimpleTheme.ts]
end
subgraph "服务层"
D[databaseService.ts]
E[notificationService.ts]
end
subgraph "UI组件"
F[AdvancedSearchPanel.vue]
G[SimpleThemeSelector.vue]
G[NotificationCenter.vue]
end
A --> D
B --> F
C --> G
D --> E
```

**图示来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [notificationService.ts](file://src/services/notificationService.ts)
- [AdvancedSearchPanel.vue](file://src/components/search/AdvancedSearchPanel.vue)
- [SimpleThemeSelector.vue](file://src/components/theme/SimpleThemeSelector.vue)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue)

**章节来源**
- [src/composables](file://src/composables)
- [src/services](file://src/services)
- [src/components](file://src/components)

## 核心组件
本文档的核心组件包括三个关键的组合式函数：`useRealtime`用于实现实时数据同步，`useAdvancedSearch`提供高级搜索功能，`useSimpleTheme`管理主题切换逻辑。这些组件通过响应式引用在Vue组件中使用，实现了逻辑的高效复用。

**章节来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)

## 架构概述
系统架构采用分层设计，组合式函数作为中间层，连接UI组件与底层服务。`useRealtime`依赖`databaseService`提供的Supabase连接，`useAdvancedSearch`直接操作工具商店的数据，`useSimpleTheme`则利用VueUse库的系统偏好检测功能。这种架构确保了各层之间的松耦合。

```mermaid
graph TD
A[UI组件] --> B[组合式函数]
B --> C[服务层]
C --> D[Supabase后端]
B -.->|实时更新| D
C -.->|数据库操作| D
subgraph "组合式函数"
B1[useRealtime]
B2[useAdvancedSearch]
B3[useSimpleTheme]
end
subgraph "服务层"
C1[databaseService]
C2[notificationService]
end
```

**图示来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [notificationService.ts](file://src/services/notificationService.ts)

## 详细组件分析
本节深入分析每个组合式函数的实现细节、使用方法和最佳实践。

### useRealtime 实时数据同步
`useRealtime`组合式函数封装了Supabase Realtime API的复杂性，提供简洁的接口用于监听数据库变更。它支持多种使用模式，包括通用实时监听、列表同步、单记录同步和统计同步。

#### 实时同步架构
```mermaid
classDiagram
class useRealtime {
+isConnected : Ref<boolean>
+error : Ref<string | null>
+lastEvent : Ref<any>
+subscribe() : void
+unsubscribe() : void
+resubscribe() : void
}
class useRealtimeList~T~ {
+data : Ref<T[]>
+addItem(item : T) : void
+updateItem(item : T) : void
+removeItem(id : string) : void
}
class useRealtimeRecord~T~ {
+data : Ref<T | null>
+loadData() : Promise<void>
+updateData(newData : Partial<T>) : void
}
class useRealtimeStats {
+stats : Ref<Record<string, any>>
+loadStats() : Promise<void>
+updateTableStats(table : string) : Promise<void>
}
class useRealtimeConnection {
+isOnline : Ref<boolean>
+connectionQuality : Ref<"good"|"poor"|"offline">
+checkConnection() : Promise<void>
}
useRealtimeList --> useRealtime : "继承功能"
useRealtimeRecord --> useRealtime : "继承功能"
useRealtimeStats --> useRealtime : "继承功能"
useRealtimeConnection --> useRealtime : "继承功能"
```

**图示来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)

#### 实时数据流
```mermaid
sequenceDiagram
participant Client as "客户端组件"
participant Composable as "useRealtime"
participant Service as "databaseService"
participant Supabase as "Supabase后端"
Client->>Composable : 调用subscribe()
Composable->>Service : subscribeToTable()
Service->>Supabase : 建立WebSocket连接
Supabase-->>Service : 发送实时变更
Service-->>Composable : 触发回调
Composable-->>Client : 更新响应式状态
Note over Client,Supabase : 实现毫秒级数据同步
Supabase->>Service : INSERT/UPDATE/DELETE事件
Service->>Composable : 传递payload
Composable->>Client : 触发onInsert/onUpdate/onDelete
```

**图示来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [databaseService.ts](file://src/services/databaseService.ts)

**章节来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [databaseService.ts](file://src/services/databaseService.ts)

### useAdvancedSearch 高级搜索
`useAdvancedSearch`组合式函数提供了一套完整的搜索解决方案，包括智能搜索算法、多维度过滤、结果排序和搜索历史管理。它与`AdvancedSearchPanel.vue`组件紧密配合，为用户提供丰富的搜索体验。

#### 搜索功能架构
```mermaid
classDiagram
class useAdvancedSearch {
+searchQuery : Ref<string>
+filters : Ref<SearchFilters>
+searchResults : ComputedRef<SearchResult[]>
+searchSuggestions : ComputedRef<string[]>
+popularSearches : ComputedRef<string[]>
+search(query : string) : void
+clearSearch() : void
+resetFilters() : void
}
class SearchFilters {
+category : string
+tags : string[]
+rating : number
+isFeatured : boolean
+hasUrl : boolean
+sortBy : "name"|"rating"|"clicks"|"created_at"
+sortOrder : "asc"|"desc"
}
class SearchResult {
+item : any
+score : number
+matches : string[]
}
useAdvancedSearch --> SearchFilters
useAdvancedSearch --> SearchResult
```

**图示来源**
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)

#### 搜索处理流程
```mermaid
flowchart TD
Start([开始搜索]) --> ValidateInput["验证输入参数"]
ValidateInput --> InputValid{"输入有效?"}
InputValid --> |否| ReturnEmpty["返回空结果"]
InputValid --> |是| TokenizeQuery["分词查询字符串"]
TokenizeQuery --> PerformSearch["执行智能搜索"]
PerformSearch --> ApplyFilters["应用筛选器"]
ApplyFilters --> SortResults["排序结果"]
SortResults --> CacheResults["缓存结果"]
CacheResults --> ReturnResults["返回最终结果"]
subgraph "智能搜索算法"
PerformSearch --> WeightedScoring["加权评分"]
WeightedScoring --> FieldSearch["字段搜索"]
FieldSearch --> FuzzyMatch["模糊匹配"]
FuzzyMatch --> BonusPoints["加分机制"]
end
subgraph "筛选逻辑"
ApplyFilters --> CategoryFilter["分类筛选"]
CategoryFilter --> TagsFilter["标签筛选"]
TagsFilter --> RatingFilter["评分筛选"]
RatingFilter --> FeatureFilter["特色筛选"]
FeatureFilter --> UrlFilter["URL可用性筛选"]
end
subgraph "排序策略"
SortResults --> SortBy["按字段排序"]
SortBy --> Order["升序/降序"]
end
```

**图示来源**
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)

**章节来源**
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [AdvancedSearchPanel.vue](file://src/components/search/AdvancedSearchPanel.vue)

### useSimpleTheme 主题管理
`useSimpleTheme`组合式函数提供了简洁的主题管理解决方案，支持浅色、深色和跟随系统三种模式。它与CSS变量联动，确保主题切换的平滑性和一致性。

#### 主题管理架构
```mermaid
classDiagram
class useSimpleTheme {
+themeConfig : Ref<SimpleThemeConfig>
+activeColorScheme : ComputedRef<"light"|"dark">
+isDark : ComputedRef<boolean>
+setThemeMode(mode : SimpleThemeMode) : void
+toggleDark() : void
+getThemeTitle() : string
+applyTheme() : void
}
class SimpleThemeConfig {
+mode : SimpleThemeMode
}
useSimpleTheme --> SimpleThemeConfig
```

**图示来源**
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)

#### 主题切换流程
```mermaid
sequenceDiagram
participant User as "用户"
participant Component as "SimpleThemeSelector"
participant Composable as "useSimpleTheme"
participant DOM as "文档对象模型"
User->>Component : 点击主题切换按钮
Component->>Composable : 调用setThemeMode()
Composable->>Composable : 更新themeConfig
Composable->>Composable : 计算activeColorScheme
Composable->>DOM : 调用applyTheme()
DOM->>DOM : 更新CSS类和属性
DOM-->>User : 显示新主题
Note over User,DOM : 实现即时主题切换
Composable->>Composable : 监听系统偏好变化
System->>Composable : 系统偏好改变
Composable->>DOM : 自动应用新主题
```

**图示来源**
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [SimpleThemeSelector.vue](file://src/components/theme/SimpleThemeSelector.vue)

**章节来源**
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [SimpleThemeSelector.vue](file://src/components/theme/SimpleThemeSelector.vue)

## 依赖分析
组合式函数与其他系统组件存在明确的依赖关系，这些依赖确保了功能的完整性和数据的一致性。

```mermaid
graph TD
A[useRealtime] --> B[databaseService]
B --> C[supabaseClient]
C --> D[Supabase后端]
E[useAdvancedSearch] --> F[toolsStore]
F --> G[tools数据]
H[useSimpleTheme] --> I[usePreferredColorScheme]
H --> J[useStorage]
I --> K[系统偏好]
J --> L[本地存储]
M[NotificationCenter] --> N[notificationService]
N --> O[Supabase实时]
A --> M
```

**图示来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [notificationService.ts](file://src/services/notificationService.ts)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue)

**章节来源**
- [src/composables](file://src/composables)
- [src/services](file://src/services)
- [src/lib](file://src/lib)
- [src/components](file://src/components)

## 性能考虑
组合式函数在设计时充分考虑了性能优化，通过多种机制确保应用的响应速度和资源效率。

- **useRealtime**：自动管理WebSocket连接的生命周期，在组件卸载时自动取消订阅，避免内存泄漏。
- **useAdvancedSearch**：采用智能缓存策略，对搜索结果进行加权评分，提高搜索效率。
- **useSimpleTheme**：利用计算属性和响应式系统，最小化DOM操作，实现流畅的主题切换。
- 所有组合式函数都遵循单一职责原则，确保每个函数只关注一个特定功能领域。

## 故障排除指南
当使用组合式函数遇到问题时，可以参考以下常见问题的解决方案：

**章节来源**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [useAdvancedSearch.ts](file://src/composables/useAdvancedSearch.ts)
- [useSimpleTheme.ts](file://src/composables/useSimpleTheme.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [notificationService.ts](file://src/services/notificationService.ts)

### 实时连接问题
- **症状**：`isConnected`始终为false
- **解决方案**：检查Supabase连接配置，确保环境变量正确设置

### 搜索无结果
- **症状**：搜索返回空数组
- **解决方案**：验证工具商店数据是否已加载，检查搜索条件是否过于严格

### 主题不切换
- **症状**：主题切换按钮无反应
- **解决方案**：检查浏览器存储权限，确认CSS类名是否正确应用

### 内存泄漏
- **症状**：页面长时间运行后变慢
- **解决方案**：确保所有实时订阅在组件卸载时正确清理

## 结论
组合式函数是Vue 3应用中实现逻辑复用和关注点分离的关键技术。`useRealtime`、`useAdvancedSearch`和`useSimpleTheme`三个组合式函数展示了如何将复杂逻辑封装成可复用的单元，提高代码的可维护性和开发效率。通过合理的架构设计和依赖管理，这些组合式函数为应用提供了稳定、高效的功能支持。