# å·¥å…·è¯¦æƒ…é¡µæ•°æ®åŠ è½½æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue)
- [toolsService.ts](file://src/services/toolsService.ts)
- [tools.ts](file://src/stores/tools.ts)
- [index.ts](file://src/router/index.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [cacheManager.ts](file://src/utils/cacheManager.ts)
- [errorHandler.ts](file://src/utils/errorHandler.ts)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
3. [è·¯ç”±å‚æ•°æå–](#è·¯ç”±å‚æ•°æå–)
4. [ç”Ÿå‘½å‘¨æœŸé’©å­ä¸æ•°æ®åŠ è½½](#ç”Ÿå‘½å‘¨æœŸé’©å­ä¸æ•°æ®åŠ è½½)
5. [æœåŠ¡å±‚å°è£…](#æœåŠ¡å±‚å°è£…)
6. [ç¼“å­˜æœºåˆ¶](#ç¼“å­˜æœºåˆ¶)
7. [é”™è¯¯å¤„ç†ç­–ç•¥](#é”™è¯¯å¤„ç†ç­–ç•¥)
8. [å“åº”å¼æ•°æ®ç»‘å®š](#å“åº”å¼æ•°æ®ç»‘å®š)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## æ¦‚è¿°

å·¥å…·è¯¦æƒ…é¡µï¼ˆToolDetailView.vueï¼‰é‡‡ç”¨ç°ä»£Vue 3 Composition APIæ¨¡å¼ï¼Œé€šè¿‡`onMounted`ç”Ÿå‘½å‘¨æœŸé’©å­è§¦å‘æ•°æ®åŠ è½½æµç¨‹ã€‚è¯¥ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„æ•°æ®æµç®¡é“ï¼Œä»è·¯ç”±å‚æ•°æå–åˆ°æœ€ç»ˆçš„UIæ¸²æŸ“ï¼Œæ¶µç›–äº†çŠ¶æ€ç®¡ç†ã€ç¼“å­˜ä¼˜åŒ–ã€é”™è¯¯å¤„ç†ç­‰å¤šä¸ªå±‚é¢çš„æŠ€æœ¯å®ç°ã€‚

## æ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
subgraph "å‰ç«¯å±‚"
A[ToolDetailView.vue]
B[Vue Router]
C[Pinia Store]
end
subgraph "æœåŠ¡å±‚"
D[ToolsService]
E[Supabase Client]
end
subgraph "ç¼“å­˜å±‚"
F[Cache Manager]
G[Local Storage]
end
subgraph "é”™è¯¯å¤„ç†"
H[Error Handler]
I[Retry Mechanism]
end
B --> A
A --> C
A --> D
D --> E
D --> F
F --> G
D --> H
H --> I
```

**å›¾è¡¨æ¥æº**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue#L146-L203)
- [toolsService.ts](file://src/services/toolsService.ts#L1-L50)
- [tools.ts](file://src/stores/tools.ts#L118-L159)

## è·¯ç”±å‚æ•°æå–

### vue-routeré›†æˆ

å·¥å…·è¯¦æƒ…é¡µé€šè¿‡Vue Routerçš„`useRoute()`ç»„åˆå¼APIè·å–è·¯ç”±å‚æ•°ï¼š

```typescript
const route = useRoute();
const router = useRouter();

onMounted(async () => {
  await loadToolDetail();
});

const loadToolDetail = async () => {
  try {
    loading.value = true;
    const toolId = route.params.id as string;
    // ç»§ç»­å¤„ç†...
  } catch (error) {
    console.error("åŠ è½½å·¥å…·è¯¦æƒ…å¤±è´¥:", error);
  } finally {
    loading.value = false;
  }
};
```

### å‚æ•°éªŒè¯é€»è¾‘

è·¯ç”±é…ç½®ç¡®ä¿äº†æ­£ç¡®çš„å‚æ•°æ ¼å¼ï¼š
```typescript
{
  path: "/tools/:id",
  name: "ToolDetail",
  component: () => import("../views/ToolDetailView.vue"),
  meta: {
    title: "å·¥å…·è¯¦æƒ…",
    description: "æŸ¥çœ‹å·¥å…·è¯¦ç»†ä¿¡æ¯å’Œä½¿ç”¨æ•™ç¨‹",
  },
}
```

**ç« èŠ‚æ¥æº**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue#L146-L203)
- [index.ts](file://src/router/index.ts#L100-L110)

## ç”Ÿå‘½å‘¨æœŸé’©å­ä¸æ•°æ®åŠ è½½

### onMountedç”Ÿå‘½å‘¨æœŸé’©å­

å·¥å…·è¯¦æƒ…é¡µåœ¨ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨è§¦å‘æ•°æ®åŠ è½½ï¼š

```mermaid
sequenceDiagram
participant Component as ToolDetailView
participant Store as ToolsStore
participant Service as ToolsService
participant API as Supabase API
Component->>Component : onMountedè§¦å‘
Component->>Component : loadToolDetail()
Component->>Store : initialize()
Store->>Store : åŠ è½½æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®
Component->>Store : tools.find(id)
Store-->>Component : è¿”å›å·¥å…·å¯¹è±¡
Component->>Store : ç›¸å…³å·¥å…·è¿‡æ»¤
Store-->>Component : ç›¸å…³å·¥å…·åˆ—è¡¨
Component->>Service : incrementClickCount()
Service->>API : RPCè°ƒç”¨
API-->>Service : æ›´æ–°æˆåŠŸ
Service-->>Component : ç‚¹å‡»è®¡æ•°å¢åŠ 
```

**å›¾è¡¨æ¥æº**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue#L158-L180)
- [tools.ts](file://src/stores/tools.ts#L199-L243)

### æ•°æ®åŠ è½½æµç¨‹

1. **åˆå§‹åŒ–æ£€æŸ¥**ï¼šæ£€æŸ¥storeæ˜¯å¦å·²åˆå§‹åŒ–
2. **å·¥å…·æŸ¥æ‰¾**ï¼šåœ¨æœ¬åœ°å·¥å…·åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”IDçš„å·¥å…·
3. **ç›¸å…³å·¥å…·åŠ è½½**ï¼šæ ¹æ®åˆ†ç±»IDç­›é€‰ç›¸å…³å·¥å…·
4. **ç‚¹å‡»è®¡æ•°æ›´æ–°**ï¼šå¼‚æ­¥æ›´æ–°å·¥å…·ç‚¹å‡»æ¬¡æ•°

**ç« èŠ‚æ¥æº**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue#L158-L180)

## æœåŠ¡å±‚å°è£…

### ToolsServiceæ ¸å¿ƒåŠŸèƒ½

ToolsServiceæä¾›äº†å®Œæ•´çš„å·¥å…·æ•°æ®æ“ä½œæ¥å£ï¼š

```mermaid
classDiagram
class ToolsService {
+getTools(filters) Promise~SearchResult~
+getTool(id) Promise~Tool~
+createTool(toolData) Promise~Tool~
+updateTool(id, toolData) Promise~Tool~
+deleteTool(id) Promise~void~
+incrementClickCount(id) Promise~void~
+updateFavoriteStatus(id, isFavorite) Promise~void~
+getPopularTools(limit) Promise~Tool[]~
+getFeaturedTools(limit) Promise~Tool[]~
+searchTools(query, limit) Promise~Tool[]~
-transformToolRow(row) Tool
-getMockTools(filters) SearchResult~Tool~
}
class SupabaseClient {
+from(table) QueryBuilder
+rpc(functionName, params) QueryBuilder
+storage() StorageClient
}
class CacheManager {
+set(key, data, maxAge) void
+get(key) T
+delete(key) boolean
+clear() void
}
ToolsService --> SupabaseClient : uses
ToolsService --> CacheManager : uses
```

**å›¾è¡¨æ¥æº**
- [toolsService.ts](file://src/services/toolsService.ts#L30-L80)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L10-L30)

### Supabaseå®¢æˆ·ç«¯å°è£…

æœåŠ¡å±‚é€šè¿‡å°è£…çš„Supabaseå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®åº“æ“ä½œï¼š

```typescript
// è·å–å•ä¸ªå·¥å…·ï¼ˆå¸¦ç¼“å­˜ï¼‰
static async getTool(id: string): Promise<Tool> {
  const cacheKey = `tool_${id}`;
  
  return withCache(
    this._getToolFromAPI.bind(this),
    () => cacheKey,
    apiCache,
    5 * 60 * 1000, // 5åˆ†é’Ÿç¼“å­˜
  )(id);
}

private static async _getToolFromAPI(id: string): Promise<Tool> {
  try {
    const { data, error } = await supabase
      .from(TABLES.TOOLS)
      .select(`
        *,
        categories(*)
      `)
      .eq("id", id)
      .single();

    if (error) {
      throw new Error(handleSupabaseError(error));
    }

    return this.transformToolRow(data);
  } catch (error) {
    const appError = ErrorHandler.handleApiError(error);
    ErrorHandler.logError(appError, "ToolsService.getTool");
    throw appError;
  }
}
```

**ç« èŠ‚æ¥æº**
- [toolsService.ts](file://src/services/toolsService.ts#L80-L120)

## ç¼“å­˜æœºåˆ¶

### å¤šå±‚çº§ç¼“å­˜ç­–ç•¥

ç³»ç»Ÿå®ç°äº†ä¸‰çº§ç¼“å­˜æœºåˆ¶ï¼š

```mermaid
flowchart TD
A[è¯·æ±‚ç¼“å­˜] --> B{ç¼“å­˜å‘½ä¸­?}
B --> |æ˜¯| C[è¿”å›ç¼“å­˜æ•°æ®]
B --> |å¦| D[è°ƒç”¨API]
D --> E[APIå“åº”]
E --> F[æ›´æ–°ç¼“å­˜]
F --> G[è¿”å›æ•°æ®]
H[ç¼“å­˜ç®¡ç†å™¨] --> I[å†…å­˜ç¼“å­˜]
H --> J[localStorageç¼“å­˜]
K[ç¼“å­˜ç­–ç•¥] --> L[é»˜è®¤ç¼“å­˜: 5åˆ†é’Ÿ]
K --> M[APIç¼“å­˜: 3åˆ†é’Ÿ]
K --> N[å›¾ç‰‡ç¼“å­˜: 30åˆ†é’Ÿ]
```

**å›¾è¡¨æ¥æº**
- [cacheManager.ts](file://src/utils/cacheManager.ts#L1-L50)

### ç¼“å­˜è£…é¥°å™¨å®ç°

```typescript
export function withCache<T extends (...args: any[]) => Promise<any>>(
  fn: T,
  cacheKey: ((...args: Parameters<T>) => string) | string,
  cacheInstance: CacheManager = defaultCache,
  maxAge?: number,
): T {
  return (async (...args: Parameters<T>) => {
    const key = typeof cacheKey === "function" ? cacheKey(...args) : cacheKey;

    // å°è¯•ä»ç¼“å­˜è·å–
    const cachedResult = cacheInstance.get(key);
    if (cachedResult !== null) {
      return cachedResult;
    }

    // æ‰§è¡ŒåŸå‡½æ•°
    const result = await fn(...args);

    // ç¼“å­˜ç»“æœ
    cacheInstance.set(key, result, maxAge);

    return result;
  }) as T;
}
```

**ç« èŠ‚æ¥æº**
- [cacheManager.ts](file://src/utils/cacheManager.ts#L350-L380)

## é”™è¯¯å¤„ç†ç­–ç•¥

### å¤šå±‚æ¬¡é”™è¯¯å¤„ç†

```mermaid
flowchart TD
A[APIè°ƒç”¨] --> B{é”™è¯¯ç±»å‹}
B --> |ç½‘ç»œé”™è¯¯| C[RetryHandler]
B --> |æ•°æ®åº“é”™è¯¯| D[DatabaseError]
B --> |HTTPé”™è¯¯| E[HttpError]
B --> |æœªçŸ¥é”™è¯¯| F[UnknownError]
C --> G[æŒ‡æ•°é€€é¿é‡è¯•]
D --> H[é”™è¯¯æ—¥å¿—è®°å½•]
E --> I[é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–]
F --> J[é€šç”¨é”™è¯¯å¤„ç†]
G --> K[æœ€ç»ˆç»“æœ]
H --> K
I --> K
J --> K
```

**å›¾è¡¨æ¥æº**
- [errorHandler.ts](file://src/utils/errorHandler.ts#L1-L50)

### é”™è¯¯æ¢å¤æœºåˆ¶

```typescript
export class RetryHandler {
  static async withExponentialBackoff<T>(
    operation: () => Promise<T>,
    maxRetries: number = 3,
    baseDelay: number = 1000,
    maxDelay: number = 10000,
  ): Promise<T> {
    let lastError: unknown;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        lastError = error;

        if (attempt === maxRetries) {
          throw error;
        }

        // æŒ‡æ•°é€€é¿å»¶è¿Ÿï¼Œå¸¦æŠ–åŠ¨
        const exponentialDelay = baseDelay * Math.pow(2, attempt - 1);
        const jitter = Math.random() * 0.1 * exponentialDelay;
        const delay = Math.min(exponentialDelay + jitter, maxDelay);

        await new Promise((resolve) => setTimeout(resolve, delay));
      }
    }

    throw lastError;
  }
}
```

**ç« èŠ‚æ¥æº**
- [errorHandler.ts](file://src/utils/errorHandler.ts#L300-L330)

## å“åº”å¼æ•°æ®ç»‘å®š

### PiniaçŠ¶æ€ç®¡ç†

```mermaid
stateDiagram-v2
[*] --> Uninitialized
Uninitialized --> Loading : initialize()
Loading --> Loaded : æˆåŠŸ
Loading --> Error : å¤±è´¥
Loaded --> Loading : åˆ·æ–°
Error --> Loading : é‡è¯•
Loaded --> [*] : ç»„ä»¶å¸è½½
Error --> [*] : ç»„ä»¶å¸è½½
```

**å›¾è¡¨æ¥æº**
- [tools.ts](file://src/stores/tools.ts#L118-L159)

### å“åº”å¼çŠ¶æ€ç®¡ç†

```typescript
export const useToolsStore = defineStore('tools', () => {
  const tools = ref<Tool[]>([])
  const isLoading = ref(false)
  const error = ref<string | null>(null)
  const initialized = ref(false)
  
  // è®¡ç®—å±æ€§
  const activeTools = computed(() => tools.value.filter(t => t.status === 'active'))
  const filteredTools = computed(() => {
    let result = activeTools.value
    
    if (searchQuery.value.trim()) {
      const query = searchQuery.value.toLowerCase()
      result = result.filter(tool => 
        tool.name.toLowerCase().includes(query) ||
        tool.description.toLowerCase().includes(query)
      )
    }
    
    if (selectedCategory.value) {
      result = result.filter(tool => tool.category_id === selectedCategory.value)
    }
    
    return result
  })

  // æ–¹æ³•
  async function initialize() {
    if (initialized.value) return true
    
    try {
      isLoading.value = true
      error.value = null
      
      // æ¨¡æ‹Ÿå·¥å…·æ•°æ®
      const mockTools: Tool[] = [
        {
          id: '1',
          name: 'GitHub',
          description: 'ä¸–ç•Œä¸Šæœ€å¤§çš„ä»£ç æ‰˜ç®¡å¹³å°',
          url: 'https://github.com',
          icon: 'ğŸ™',
          category_id: 'dev-tools',
          is_featured: true,
          click_count: 1250,
          status: 'active',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
      ]
      
      await new Promise(resolve => setTimeout(resolve, 500))
      setTools(mockTools)
      initialized.value = true
      return true
    } catch (err) {
      error.value = 'åŠ è½½å·¥å…·æ•°æ®å¤±è´¥'
      console.error('ToolsStore initialization error:', err)
      return false
    } finally {
      isLoading.value = false
    }
  }

  return {
    tools,
    activeTools,
    isLoading,
    error,
    initialized,
    filteredTools,
    initialize
  }
})
```

**ç« èŠ‚æ¥æº**
- [tools.ts](file://src/stores/tools.ts#L118-L243)

## æ€§èƒ½ä¼˜åŒ–

### åŠ è½½çŠ¶æ€ç®¡ç†

å·¥å…·è¯¦æƒ…é¡µå®ç°äº†å®Œå–„çš„åŠ è½½çŠ¶æ€ç®¡ç†ï¼š

```typescript
// åŠ è½½çŠ¶æ€ç»„ä»¶
<div v-else-if="loading" class="loading-state">
  <div class="spinner"></div>
  <p>æ­£åœ¨åŠ è½½å·¥å…·è¯¦æƒ…...</p>
</div>

// é”™è¯¯çŠ¶æ€ç»„ä»¶
<div v-else class="error-state">
  <p>å·¥å…·ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥</p>
  <button class="secondary-button" @click="goBack">è¿”å›</button>
</div>
```

### ç‚¹å‡»è®¡æ•°ä¼˜åŒ–

```typescript
const openTool = async () => {
  if (!tool.value?.url) {
    alert("è¯¥å·¥å…·æš‚æ— å¯ç”¨é“¾æ¥");
    return;
  }

  try {
    let url = tool.value.url.trim();
    if (!url.startsWith("http://") && !url.startsWith("https://")) {
      url = "https://" + url;
    }

    // å¼‚æ­¥æ›´æ–°ç‚¹å‡»è®¡æ•°
    await toolsStore.incrementClickCount(tool.value.id);
    window.open(url, "_blank", "noopener,noreferrer");
  } catch (error) {
    console.error("æ‰“å¼€é“¾æ¥å¤±è´¥:", error);
    alert("æ— æ³•æ‰“å¼€è¯¥é“¾æ¥");
  }
};
```

**ç« èŠ‚æ¥æº**
- [ToolDetailView.vue](file://src/views/ToolDetailView.vue#L480-L508)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **è·¯ç”±å‚æ•°æ— æ•ˆ**
   - æ£€æŸ¥è·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®
   - éªŒè¯å·¥å…·IDæ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚

2. **æ•°æ®åŠ è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
   - æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„APIå“åº”
   - éªŒè¯Supabaseè¿æ¥é…ç½®

3. **ç¼“å­˜é—®é¢˜**
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   - æ£€æŸ¥localStorageå­˜å‚¨ç©ºé—´
   - éªŒè¯ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘

4. **é”™è¯¯å¤„ç†**
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—
   - æ£€æŸ¥ErrorHandlerçš„é”™è¯¯æŠ¥å‘Š
   - éªŒè¯é‡è¯•æœºåˆ¶é…ç½®

### è°ƒè¯•å·¥å…·

```typescript
// ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
const cacheStats = apiCache.getStats();
console.log('ç¼“å­˜ç»Ÿè®¡:', cacheStats);

// é”™è¯¯æ—¥å¿—
ErrorHandler.logError(error, "ToolDetailView.loadToolDetail");
```

**ç« èŠ‚æ¥æº**
- [cacheManager.ts](file://src/utils/cacheManager.ts#L100-L130)
- [errorHandler.ts](file://src/utils/errorHandler.ts#L200-L230)

## ç»“è®º

å·¥å…·è¯¦æƒ…é¡µçš„æ•°æ®åŠ è½½æœºåˆ¶å±•ç°äº†ç°ä»£Vue 3åº”ç”¨çš„æœ€ä½³å®è·µï¼Œé€šè¿‡åˆç†çš„æ¶æ„åˆ†å±‚ã€å®Œå–„çš„é”™è¯¯å¤„ç†ã€æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥å’Œå“åº”å¼çš„çŠ¶æ€ç®¡ç†ï¼Œå®ç°äº†é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç”¨æˆ·ä½“éªŒã€‚è¯¥ç³»ç»Ÿä¸ä»…å…·å¤‡è‰¯å¥½çš„å¯ç»´æŠ¤æ€§ï¼Œè¿˜ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚