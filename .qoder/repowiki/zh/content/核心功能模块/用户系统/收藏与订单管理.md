# 收藏与订单管理

<cite>
**本文档引用的文件**
- [FavoritesView.vue](file://src/views/user/FavoritesView.vue)
- [favoritesService.ts](file://src/services/favoritesService.ts)
- [OrdersView.vue](file://src/views/user/OrdersView.vue)
- [orderService.ts](file://src/services/orderService.ts)
- [localManagement.ts](file://src/stores/localManagement.ts)
- [localStorageService.ts](file://src/services/localStorageService.ts)
- [index.ts](file://src/types/index.ts)
</cite>

## 目录
1. [收藏功能模块](#收藏功能模块)
2. [订单功能模块](#订单功能模块)
3. [本地数据管理](#本地数据管理)
4. [用户旅程示例](#用户旅程示例)
5. [调试与性能优化](#调试与性能优化)

## 收藏功能模块

`FavoritesView.vue` 组件负责展示用户的收藏列表，通过 `favoritesService.ts` 服务与后端数据库交互，获取用户收藏的工具和产品数据。该组件采用选项卡式布局，分为“工具”和“产品”两个标签页，分别展示不同类型的收藏内容。

组件在挂载后通过 `loadFavorites` 方法初始化数据加载。此方法首先检查用户登录状态，然后调用 `FavoritesService.getFavoriteTools` 和 `FavoritesService.getFavoriteProducts` 方法并行获取收藏数据。服务层使用 Supabase 客户端执行数据库查询，通过 `select` 语句关联 `tools` 和 `products` 表，获取完整的工具和产品信息。查询结果按收藏创建时间倒序排列，确保最新收藏的项目排在前面。

收藏状态的切换通过 `removeFavorite` 方法实现。当用户点击移除按钮时，该方法根据收藏类型（工具或产品）调用相应的服务方法 `removeToolFromFavorites` 或 `removeProductFromFavorites`，向后端发送删除请求。请求成功后，前端状态 `favoriteTools` 或 `favoriteProducts` 会被更新，从而实时反映在 UI 上。

为了提升用户体验，系统实现了本地缓存策略。`localManagement` store 通过 `localStorageService` 管理用户偏好和本地数据。当用户进行收藏操作时，相关操作会被记录在离线队列中，即使在离线状态下也能保证操作的完整性，待网络恢复后自动同步。

**Section sources**
- [FavoritesView.vue](file://src/views/user/FavoritesView.vue#L1-L617)
- [favoritesService.ts](file://src/services/favoritesService.ts#L1-L342)

## 订单功能模块

`OrdersView.vue` 组件用于渲染用户的订单历史列表。其核心功能是通过 `OrderService.getUserOrders` 方法从后端获取订单数据，并根据订单状态进行筛选和展示。

订单列表的渲染逻辑基于 `filteredOrders` 计算属性。该属性根据当前激活的过滤器（如“全部订单”、“待支付”、“已支付”等）对 `orders` 数组进行过滤。每个订单项都包含订单号、下单时间、订单总额和订单状态等关键信息。订单状态以徽章形式展示，不同状态（待支付、已支付、已取消、已退款）对应不同的颜色和文本，便于用户快速识别。

组件提供了丰富的订单操作功能。对于“待支付”订单，用户可以点击“立即支付”按钮跳转到支付页面；对于未支付的订单，可以点击“取消订单”按钮进行取消。对于“已支付”订单，用户可以点击“下载产品”按钮下载已购买的数字商品。这些操作通过 `payOrder`、`cancelOrder` 和 `downloadOrder` 等方法实现，它们会调用相应的服务方法与后端交互。

订单详情的展示通过 `viewOrderDetail` 方法触发，虽然当前实现为日志输出，但为未来实现订单详情页预留了接口。订单数据的加载同样在组件挂载时通过 `loadOrders` 方法完成，该方法会优先尝试从 API 获取真实数据，若失败则使用模拟数据作为后备，保证了界面的可用性。

**Section sources**
- [OrdersView.vue](file://src/views/user/OrdersView.vue#L1-L743)
- [orderService.ts](file://src/services/orderService.ts#L1-L591)

## 本地数据管理

`localManagement` store 是一个集中式管理用户本地行为数据的模块，它利用 Pinia 状态管理库和浏览器的 `localStorage` API 实现数据的持久化存储和离线功能。

该 store 的核心功能包括：
- **用户偏好管理**：通过 `userPreferences` 状态和 `updateUserPreferences` 方法，用户可以设置主题、语言、视图模式等偏好，这些设置会被持久化到 `localStorage` 中。
- **离线操作队列**：通过 `offlineQueue` 状态和 `addOfflineAction` 方法，用户的创建、更新、删除等操作会被记录在离线队列中。当网络恢复时，`syncData` 方法会自动处理队列中的所有操作，确保数据最终一致性。
- **数据同步**：`syncData` 方法负责将本地的离线操作同步到远程服务器。它会遍历离线队列，根据操作类型（create, update, delete）和实体类型（tool, category）调用相应的服务方法。同步成功后，队列会被清空，并更新最后同步时间。
- **本地数据管理**：提供 `addLocalTool`、`updateLocalTool`、`deleteLocalTool` 等方法，允许用户在离线状态下管理本地工具和分类。这些数据同样存储在 `localStorage` 中，并在同步时上传到服务器。

`localStorageService` 服务类封装了所有与 `localStorage` 交互的底层逻辑，定义了统一的键名常量和数据类型，确保了数据存储的规范性和安全性。它提供了 `getLocalTools`、`saveLocalTools`、`getUserPreferences` 等一系列静态方法，供 `localManagement` store 和其他模块调用。

**Section sources**
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)
- [localStorageService.ts](file://src/services/localStorageService.ts#L1-L339)

## 用户旅程示例

以下是一个完整的用户旅程示例，展示了从添加收藏到查看订单的全过程：

1.  **添加收藏**：用户在浏览工具或产品时，点击“收藏”按钮。前端调用 `FavoritesService.addToolToFavorites` 或 `addProductToFavorites` 方法，向后端发送添加收藏的请求。同时，该操作会被记录在 `localManagement` store 的离线队列中。
2.  **查看收藏**：用户导航至“我的收藏”页面。`FavoritesView.vue` 组件加载并展示用户收藏的工具和产品列表。用户可以在此页面管理自己的收藏，如移除不再需要的项目。
3.  **下单购买**：用户在“我的收藏”或产品列表中选择一个产品，点击“立即购买”按钮。系统会调用 `OrderService.createOrder` 方法创建一个新订单，订单状态初始为“待支付”。用户随后被引导至支付页面完成支付流程。支付成功后，`OrderService.processPayment` 方法会被调用，将订单状态更新为“已支付”。
4.  **查看订单**：用户导航至“我的订单”页面。`OrdersView.vue` 组件加载并展示用户的订单历史。用户可以根据状态筛选订单，查看“待支付”订单并完成支付，或查看“已支付”订单并下载已购买的产品。

**Section sources**
- [FavoritesView.vue](file://src/views/user/FavoritesView.vue#L1-L617)
- [favoritesService.ts](file://src/services/favoritesService.ts#L1-L342)
- [OrdersView.vue](file://src/views/user/OrdersView.vue#L1-L743)
- [orderService.ts](file://src/services/orderService.ts#L1-L591)

## 调试与性能优化

### 数据加载失败
当数据加载失败时，应首先检查网络连接和用户登录状态。在 `OrdersView.vue` 中，`loadOrders` 方法已实现错误处理和后备机制，优先尝试加载真实数据，失败后使用模拟数据。开发者应检查控制台日志，确认错误来源是前端、网络还是后端服务。对于 `favoritesService` 和 `orderService` 中的数据库查询，应确保 Supabase 客户端配置正确，且 RLS（行级安全）策略允许当前用户访问相关数据。

### 订单状态不同步
订单状态不同步问题可能由网络延迟或支付回调失败引起。在 `downloadOrder` 方法中，系统会先调用 `getOrderById` 获取订单的最新状态，确保用户只有在订单确实为“已支付”状态时才能下载产品，这有效防止了因前端状态未更新而导致的越权下载。

### 性能优化建议
- **分页加载**：对于收藏和订单列表，当数据量较大时，应在服务层实现分页查询。`OrderService.getAllOrders` 方法已支持分页参数（`page` 和 `limit`），前端应利用此功能，避免一次性加载过多数据。
- **数据缓存**：对于不经常变动的数据（如工具列表、产品分类），应实现客户端缓存。`toolsService.ts` 中的 `getTools` 和 `getPopularTools` 方法已使用 `withCache` 装饰器实现了内存缓存，减少了对数据库的重复查询。
- **懒加载**：对于图片等大资源，应使用 `LazyImage` 组件实现懒加载，仅在图片进入视口时才进行加载，提升页面初始加载速度。
- **代码分割**：对于管理后台等大型功能模块，应使用动态导入（`import()`）进行代码分割，实现按需加载，减少主包体积。

**Section sources**
- [OrdersView.vue](file://src/views/user/OrdersView.vue#L1-L743)
- [orderService.ts](file://src/services/orderService.ts#L1-L591)
- [toolsService.ts](file://src/services/toolsService.ts#L1-L470)
- [utils/cacheManager.ts](file://src/utils/cacheManager.ts)