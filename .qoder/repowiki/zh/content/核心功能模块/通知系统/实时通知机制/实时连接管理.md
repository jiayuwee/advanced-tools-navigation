# 实时连接管理

<cite>
**本文档中引用的文件**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [notificationService.ts](file://src/services/notificationService.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)
6. [性能考虑](#性能考虑)
7. [故障排除指南](#故障排除指南)
8. [结论](#结论)

## 项目结构

```mermaid
graph TD
A[src] --> B[composables]
A --> C[lib]
A --> D[services]
B --> E[useRealtime.ts]
C --> F[supabaseClient.ts]
D --> G[databaseService.ts]
D --> H[notificationService.ts]
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [databaseService.ts](file://src/services/databaseService.ts)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)

## 核心组件

`useRealtime.ts` 文件提供了WebSocket连接生命周期管理的核心功能，包括连接初始化、频道订阅、事件监听和状态监控。该文件通过组合式API模式封装了Supabase实时功能，提供了`useRealtime`、`useRealtimeList`、`useRealtimeRecord`和`useRealtimeStats`等可复用的组合函数。

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)

## 架构概述

```mermaid
graph TD
A[Supabase客户端] --> B[databaseService]
B --> C[useRealtime]
C --> D[useRealtimeList]
C --> E[useRealtimeRecord]
C --> F[useRealtimeStats]
C --> G[useRealtimeConnection]
H[Vue组件] --> C
H --> D
H --> E
H --> F
H --> G
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)

## 详细组件分析

### useRealtime 分析

`useRealtime` 函数是WebSocket连接管理的基础，负责处理连接配置、认证集成和自动重连机制。

```mermaid
sequenceDiagram
participant 组件 as Vue组件
participant useRealtime as useRealtime
participant databaseService as databaseService
participant Supabase as Supabase
组件->>useRealtime : 调用useRealtime(options)
useRealtime->>useRealtime : 初始化响应式状态
useRealtime->>useRealtime : 自动订阅(autoSubscribe)
useRealtime->>databaseService : subscribeToTable()
databaseService->>Supabase : 创建实时频道
Supabase-->>databaseService : 返回RealtimeChannel
databaseService-->>useRealtime : 返回频道引用
useRealtime->>useRealtime : 设置事件监听器
useRealtime-->>组件 : 返回连接管理API
组件->>useRealtime : 组件卸载
useRealtime->>useRealtime : 调用unsubscribe
useRealtime->>databaseService : 取消订阅
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L46-L107)
- [databaseService.ts](file://src/services/databaseService.ts#L250-L309)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L107)

### 频道创建与订阅逻辑

系统实现了基于用户ID的私有频道订阅模式，通过`filter`参数实现数据访问控制。

```mermaid
flowchart TD
Start([开始订阅]) --> ValidateInput["验证输入参数"]
ValidateInput --> CreateChannel["创建实时频道"]
CreateChannel --> ApplyFilter{"是否需要过滤器?"}
ApplyFilter --> |是| AddFilter["添加过滤条件"]
ApplyFilter --> |否| Subscribe["订阅频道"]
AddFilter --> Subscribe
Subscribe --> StoreChannel["存储频道引用"]
StoreChannel --> SetConnected["设置连接状态"]
SetConnected --> End([订阅完成])
style Start fill:#f9f,stroke:#333
style End fill:#bbf,stroke:#333
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L46-L107)
- [databaseService.ts](file://src/services/databaseService.ts#L250-L309)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L46-L107)

### 事件监听器管理

系统实现了完整的事件监听器注册与销毁流程，防止内存泄漏。

```mermaid
classDiagram
class RealtimeManager {
+isConnected : Ref<boolean>
+error : Ref<string | null>
+lastEvent : Ref<any>
+channel : Ref<RealtimeChannel | null>
+subscribe() : void
+unsubscribe() : void
+resubscribe() : void
}
class EventListener {
+onInsert : (payload : any) => void
+onUpdate : (payload : any) => void
+onDelete : (payload : any) => void
+onChange : (payload : any) => void
}
class Lifecycle {
+onUnmounted : () => void
}
RealtimeManager --> EventListener : "包含"
RealtimeManager --> Lifecycle : "集成"
RealtimeManager --> RealtimeChannel : "管理"
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L98-L107)

### 连接状态监控

系统实现了全面的连接状态监控和心跳检测机制。

```mermaid
stateDiagram-v2
[*] --> 初始状态
初始状态 --> 在线 : checkConnection()
初始状态 --> 离线 : 检查失败
在线 --> 网络良好 : latency < 200ms
在线 --> 网络较差 : 200ms ≤ latency < 1000ms
在线 --> 离线 : 检查失败
网络良好 --> 网络较差 : latency ≥ 200ms
网络良好 --> 离线 : 检查失败
网络较差 --> 网络良好 : latency < 200ms
网络较差 --> 离线 : 检查失败
离线 --> 在线 : online事件
离线 --> 网络良好 : 恢复连接
离线 --> 网络较差 : 恢复连接
note right of 在线
每30秒执行checkConnection()
end note
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L315-L373)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L315-L401)

## 依赖分析

```mermaid
erDiagram
useRealtime ||--o{ databaseService : "依赖"
useRealtime ||--o{ Supabase : "通过databaseService"
useRealtime ||--o{ Vue : "使用ref, onUnmounted, watch"
databaseService ||--o{ Supabase : "直接使用"
notificationService ||--o{ Supabase : "直接使用"
useRealtime {
string table PK
string filter
boolean autoSubscribe
function onInsert
function onUpdate
function onDelete
function onChange
}
databaseService {
string channelName PK
RealtimeChannel channel
Map realtimeChannels
}
Supabase {
string supabaseUrl PK
string supabaseAnonKey
function createClient
function channel
}
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L1-L266)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)

## 性能考虑

系统在实时连接管理方面实现了多项性能优化：

1. **自动重连机制**：通过`resubscribe`函数实现异常断线后的自动恢复
2. **心跳检测**：每30秒执行一次连接质量检查
3. **内存泄漏防护**：在组件卸载时自动清理事件监听器
4. **延迟更新**：在`useRealtimeStats`中使用`setTimeout`避免频繁查询

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L315-L401)

## 故障排除指南

常见连接问题及解决方案：

1. **连接失败**：检查环境变量`VITE_SUPABASE_URL`和`VITE_SUPABASE_ANON_KEY`配置
2. **订阅超时**：检查网络连接质量，确保WebSocket端口未被防火墙阻止
3. **数据不同步**：验证过滤器条件是否正确，检查RLS（行级安全）策略
4. **内存泄漏**：确保在组件卸载时正确调用`unsubscribe`

```mermaid
flowchart LR
A[连接问题] --> B{在线状态}
B --> |离线| C[检查网络连接]
B --> |在线| D{连接质量}
D --> |差| E[检查网络延迟]
D --> |好| F{订阅状态}
F --> |未订阅| G[检查filter参数]
F --> |已订阅| H{数据更新}
H --> |无更新| I[检查RLS策略]
H --> |有更新| J[正常]
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L315-L401)
- [databaseService.ts](file://src/services/databaseService.ts#L374-L404)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L46-L107)
- [databaseService.ts](file://src/services/databaseService.ts#L374-L404)

## 结论

`useRealtime.ts` 文件提供了一套完整的WebSocket连接生命周期管理解决方案，通过组合式API模式封装了复杂的实时功能。系统实现了连接初始化、频道订阅、事件监听、状态监控和自动恢复等核心功能，同时注重内存泄漏防护和性能优化。基于用户ID的私有频道订阅模式确保了数据安全，而全面的错误处理机制提高了系统的健壮性。