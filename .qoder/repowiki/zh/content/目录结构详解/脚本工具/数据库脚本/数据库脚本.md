# 数据库脚本

<cite>
**本文档中引用的文件**  
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql)
- [supabase_complete_deploy.sql](file://scripts/database/supabase_complete_deploy.sql)
- [create-rls-policies-final.sql](file://scripts/database/create-rls-policies-final.sql)
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql)
- [create-rls-policies-optimized.sql](file://scripts/database/create-rls-policies-optimized.sql)
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js)
- [create-storage-buckets-only.js](file://scripts/database/create-storage-buckets-only.js)
- [insert-initial-data.sql](file://scripts/database/insert-initial-data.sql)
- [supabase_seed_data.sql](file://scripts/database/supabase_seed_data.sql)
- [update-database.js](file://scripts/database/update-database.js)
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js)
- [run-sql-script.js](file://scripts/database/run-sql-script.js)
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql)
- [20241224000003_storage_setup.sql](file://supabase/migrations/20241224000003_storage_setup.sql)
- [20241224000004_seed_data.sql](file://supabase/migrations/20241224000004_seed_data.sql)
</cite>

## 目录
1. [数据库模式初始化脚本](#数据库模式初始化脚本)
2. [行级安全（RLS）策略脚本对比分析](#行级安全rls策略脚本对比分析)
3. [Supabase存储桶配置机制](#supabase存储桶配置机制)
4. [数据填充逻辑分析](#数据填充逻辑分析)
5. [数据库迁移安全执行机制](#数据库迁移安全执行机制)
6. [连接验证流程](#连接验证流程)
7. [通用SQL执行封装](#通用sql执行封装)
8. [与正式迁移流程的关系](#与正式迁移流程的关系)
9. [环境使用最佳实践与风险规避](#环境使用最佳实践与风险规避)

## 数据库模式初始化脚本

`safe-create-tables.sql` 和 `supabase_complete_deploy.sql` 是用于数据库模式初始化的核心SQL脚本，分别适用于不同场景。

`safe-create-tables.sql` 采用分步创建方式，确保表结构的逐步构建与验证。该脚本首先创建一系列业务表，包括用户反馈、FAQ分类、产品提交、网站内容等，并在创建后启用行级安全（RLS），最后创建必要的索引以提升查询性能。其设计特点是使用 `IF NOT EXISTS` 语法避免重复创建错误，适合在已有部分数据的环境中安全执行。

`supabase_complete_deploy.sql` 则是一个完整的部署脚本，不仅包含表结构定义，还涵盖了枚举类型创建、触发器函数、更新时间戳自动更新机制以及完整的RLS策略。该脚本适用于全新环境的一次性部署，能够快速构建完整的数据库架构。

两者在功能上互补：`safe-create-tables.sql` 强调安全性与幂等性，适合开发和测试环境；而 `supabase_complete_deploy.sql` 提供全面的初始化能力，适合生产环境的首次部署。

**节来源**
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql#L1-L195)
- [supabase_complete_deploy.sql](file://scripts/database/supabase_complete_deploy.sql#L1-L371)

## 行级安全（RLS）策略脚本对比分析

项目中存在多个RLS策略脚本：`create-rls-policies-final.sql`、`create-rls-policies-fixed.sql` 和 `create-rls-policies-optimized.sql`，它们在实现方式和应用场景上各有侧重。

`create-rls-policies-final.sql` 针对特定功能模块（如用户反馈、FAQ、产品提交等）定义了细粒度的访问控制策略。它通过 `auth.uid()` 函数判断当前用户身份，结合角色检查实现权限控制。该脚本适用于功能扩展后的增量策略更新。

`create-rls-policies-fixed.sql` 在前者基础上进行了优化，引入了私有模式（private schema）和安全定义函数（如 `private.is_admin()`），避免了RLS策略中的递归检查问题，提升了性能。此外，该脚本显式声明了策略的执行角色（`TO authenticated, anon`），增强了安全性。

`create-rls-policies-optimized.sql` 是性能导向的版本，结构更简洁，去除了冗余的策略名称和注释，专注于核心权限逻辑。它与 `create-rls-policies-fixed.sql` 功能基本一致，但更适合自动化部署流程。

三者的关系体现了从功能实现到性能优化的演进路径：`final` 版本确保功能正确性，`fixed` 版本解决潜在性能问题，`optimized` 版本则用于高效部署。

**节来源**
- [create-rls-policies-final.sql](file://scripts/database/create-rls-policies-final.sql#L1-L236)
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql#L1-L692)
- [create-rls-policies-optimized.sql](file://scripts/database/create-rls-policies-optimized.sql#L1-L514)

## Supabase存储桶配置机制

`setup-storage-buckets.js` 和 `create-storage-buckets-only.js` 是两个用于配置Supabase存储桶的JavaScript脚本，均基于Supabase SDK实现。

`setup-storage-buckets.js` 是完整配置脚本，执行三个主要操作：创建存储桶、设置访问策略、验证配置结果。它定义了四个存储桶：avatars（头像）、product-images（产品图片）、tool-icons（工具图标）和uploads（用户上传文件），每个桶都有明确的大小限制和MIME类型白名单。策略部分通过RPC调用 `exec_sql` 创建RLS策略，实现基于用户ID和角色的访问控制。

`create-storage-buckets-only.js` 仅执行存储桶创建，不涉及策略设置。其设计目的是在策略配置可能失败的环境中，先确保存储桶存在，后续再通过其他方式（如手动或独立脚本）配置策略。这种分离设计提高了部署的灵活性和容错能力。

两个脚本均使用环境变量（`VITE_SUPABASE_URL` 和 `SUPABASE_SERVICE_ROLE_KEY`）进行身份认证，确保操作的安全性。

**节来源**
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js#L1-L293)
- [create-storage-buckets-only.js](file://scripts/database/create-storage-buckets-only.js#L1-L181)

## 数据填充逻辑分析

`insert-initial-data.sql` 和 `supabase_seed_data.sql` 负责数据库的初始数据填充，确保系统具备基本运行所需的数据。

`insert-initial-data.sql` 使用PL/pgSQL的 `DO $$` 块结构，先检查目标表是否已有数据，若无则插入预设内容。其填充内容包括：FAQ分类与问题、联系信息、网站内容等静态数据。通过 `RAISE NOTICE` 输出执行状态，便于调试。该脚本强调幂等性，避免重复插入。

`supabase_seed_data.sql`（内容未提供）从文件名推断应为更全面的数据种子脚本，可能包含用户角色、默认分类、示例产品等更丰富的初始数据，用于构建完整的演示环境。

两者的区别在于范围：`insert-initial-data.sql` 聚焦于前端展示所需的基础内容，而 `supabase_seed_data.sql` 可能涵盖整个系统所需的完整种子数据。

**节来源**
- [insert-initial-data.sql](file://scripts/database/insert-initial-data.sql#L1-L140)
- [supabase_seed_data.sql](file://scripts/database/supabase_seed_data.sql)

## 数据库迁移安全执行机制

`update-database.js` 是一个Node.js脚本，用于安全执行数据库迁移。其核心机制包括：

1. **环境验证**：检查必要的环境变量（Supabase URL和服务密钥）是否存在。
2. **连接管理**：使用 `@supabase/supabase-js` 创建客户端实例，确保与数据库的安全连接。
3. **事务控制**：虽然未显式使用事务，但通过顺序执行和错误捕获保证操作的原子性。
4. **错误处理**：对每个操作进行 `try-catch` 包装，输出详细错误信息并退出进程，防止部分更新导致状态不一致。
5. **幂等性设计**：在创建存储桶前检查是否已存在，避免重复创建错误。

该脚本通常与 `run-sql-script.js` 配合使用，形成完整的迁移执行链。

**节来源**
- [update-database.js](file://scripts/database/update-database.js)

## 连接验证流程

`test-supabase-connection.js` 实现了Supabase连接的验证流程，主要步骤如下：

1. **环境加载**：通过 `dotenv` 加载 `.env.local` 中的配置。
2. **客户端初始化**：使用 `createClient` 创建Supabase客户端。
3. **连接测试**：执行一个简单的数据库查询（如 `SELECT NOW()`）或调用 `auth.getUser()` 验证身份认证。
4. **结果输出**：根据响应成功与否输出连接状态（✅ 成功或 ❌ 失败）。
5. **错误处理**：捕获网络错误、认证失败等异常，提供清晰的错误提示。

该脚本作为部署前的健康检查工具，确保数据库服务可访问。

**节来源**
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js)

## 通用SQL执行封装

`run-sql-script.js` 提供了一个通用的SQL脚本执行封装，其设计特点包括：

- **参数化执行**：接受SQL文件路径作为参数，支持动态加载不同脚本。
- **批处理支持**：能够读取并执行包含多个语句的SQL文件。
- **错误隔离**：每条语句独立执行，单条失败不影响后续语句（可配置）。
- **日志记录**：输出每条语句的执行状态，便于追踪。
- **集成能力**：可被其他脚本（如 `update-database.js`）调用，作为底层执行引擎。

该脚本是自动化数据库操作的基础组件，提升了SQL执行的一致性和可靠性。

**节来源**
- [run-sql-script.js](file://scripts/database/run-sql-script.js)

## 与正式迁移流程的关系

这些脚本与 `supabase/migrations` 目录中的正式迁移文件存在明确的对应关系：

- `20241224000001_initial_schema.sql` 对应 `safe-create-tables.sql` 或 `supabase_complete_deploy.sql` 的表结构部分。
- `20241224000002_rls_policies.sql` 对应 `create-rls-policies-optimized.sql` 的策略定义。
- `20241224000003_storage_setup.sql` 对应 `setup-storage-buckets.js` 的存储桶配置。
- `20241224000004_seed_data.sql` 对应 `insert-initial-data.sql` 和 `supabase_seed_data.sql` 的数据填充。

区别在于：脚本适用于灵活的手动或CI/CD执行，而迁移文件由Supabase CLI管理，确保版本控制和回滚能力。开发过程中可先用脚本验证逻辑，再固化为正式迁移。

**节来源**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql)
- [20241224000003_storage_setup.sql](file://supabase/migrations/20241224000003_storage_setup.sql)
- [20241224000004_seed_data.sql](file://supabase/migrations/20241224000004_seed_data.sql)

## 环境使用最佳实践与风险规避

### 开发环境
- 使用 `safe-create-tables.sql` 和 `insert-initial-data.sql` 快速搭建本地数据库。
- 运行 `test-supabase-connection.js` 验证连接。
- 避免使用生产密钥。

### 测试环境
- 使用 `supabase_complete_deploy.sql` 进行完整部署。
- 通过 `run-sql-script.js` 自动化执行迁移。
- 定期清理数据以保持测试纯净。

### 生产环境
- **严禁直接运行脚本**，必须通过Supabase CLI应用正式迁移。
- 所有变更需经过代码审查和预发布验证。
- 使用 `create-storage-buckets-only.js` 分阶段配置存储，降低风险。
- 备份数据库后再执行任何数据变更。

### 风险规避
- **幂等性**：确保脚本可重复执行而不产生副作用。
- **权限最小化**：使用专用服务角色密钥，限制操作范围。
- **监控与日志**：记录所有数据库操作，便于审计和故障排查。
- **回滚计划**：为每个变更准备回滚脚本或迁移版本。

遵循上述实践可确保数据库操作的安全性、一致性和可维护性。

**节来源**
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql)
- [supabase_complete_deploy.sql](file://scripts/database/supabase_complete_deploy.sql)
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js)
- [update-database.js](file://scripts/database/update-database.js)
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js)
- [supabase/migrations](file://supabase/migrations)