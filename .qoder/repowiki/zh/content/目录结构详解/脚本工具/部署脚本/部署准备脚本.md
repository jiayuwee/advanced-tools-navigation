# 部署准备脚本

<cite>
**本文档中引用的文件**
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js)
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)
- [setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js)
- [update-github-secrets.js](file://scripts/deployment/update-github-secrets.js)
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh)
- [setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1)
- [netlify.toml](file://netlify.toml)
- [github/workflows/build-verification.yml](file://github/workflows/build-verification.yml)
- [github/workflows/health-check.yml](file://github/workflows/health-check.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本项目包含一系列部署前准备脚本，用于确保应用在部署到Netlify和Supabase平台前的配置完整性。这些脚本涵盖了GitHub Secrets验证、环境依赖检查、配置一致性比对、自动化配置设置以及CI/CD流水线集成等多个方面，形成了一套完整的部署前验证与准备机制。

## 项目结构
项目结构清晰地划分了源代码、配置文件、公共资源和脚本目录。核心部署准备脚本位于`scripts/deployment`目录下，与`netlify.toml`和GitHub Actions工作流文件共同构成了自动化部署的基础。

```mermaid
graph TD
A[项目根目录] --> B[scripts/deployment]
A --> C[netlify.toml]
A --> D[.github/workflows]
B --> E[check-github-secrets.js]
B --> F[pre-deploy-check.mjs]
B --> G[verify-config-match.js]
B --> H[setup-github-secrets.js]
B --> I[update-github-secrets.js]
B --> J[setup-supabase.sh]
B --> K[setup-supabase.ps1]
D --> L[build-verification.yml]
D --> M[health-check.yml]
```

**图示来源**
- [scripts/deployment](file://scripts/deployment)
- [.github/workflows](file://github/workflows)

**本节来源**
- [scripts/deployment](file://scripts/deployment)
- [.github/workflows](file://github/workflows)

## 核心组件
部署准备脚本体系由多个核心组件构成，每个组件负责特定的验证或配置任务。这些组件协同工作，确保部署过程的可靠性和一致性。

**本节来源**
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js)
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)

## 架构概述
部署准备脚本架构采用分层设计，从基础环境检查到高级配置验证，形成了一套完整的质量保障体系。脚本通过命令行接口与外部服务（GitHub、Supabase、Netlify）交互，实现自动化配置和验证。

```mermaid
graph TB
subgraph "本地开发环境"
A[pre-deploy-check.mjs]
B[verify-config-match.js]
C[setup-supabase.sh/.ps1]
end
subgraph "远程服务"
D[GitHub Secrets]
E[Supabase]
F[Netlify]
end
subgraph "CI/CD流水线"
G[build-verification.yml]
H[health-check.yml]
end
A --> D
B --> D
B --> E
B --> F
C --> E
G --> A
G --> B
H --> A
H --> B
```

**图示来源**
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh)
- [github/workflows/build-verification.yml](file://github/workflows/build-verification.yml)
- [github/workflows/health-check.yml](file://github/workflows/health-check.yml)

## 详细组件分析

### GitHub Secrets 验证机制
`check-github-secrets.js`脚本负责验证GitHub Secrets的完整性与正确性。该脚本首先定义了必需的Secrets列表，包括Supabase访问令牌、项目引用ID、API URL和匿名密钥，并提供详细的获取方式说明。

```mermaid
sequenceDiagram
participant Script as check-github-secrets.js
participant Local as 本地环境
participant Supabase as Supabase API
Script->>Local : 加载.env.local环境变量
Script->>Local : 检查VITE_SUPABASE_URL和VITE_SUPABASE_ANON_KEY
alt 环境变量存在
Script->>Supabase : 测试数据库连接
Supabase-->>Script : 返回连接结果
Script->>Script : 显示连接状态
else 环境变量不存在
Script->>Script : 提示配置.env.local文件
end
Script->>Script : 显示必需Secrets列表
Script->>Script : 提供配置步骤指南
Script->>Script : 显示工作流信息
Script->>Script : 提供故障排除建议
```

**图示来源**
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js#L0-L170)

**本节来源**
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js#L0-L170)

### 部署前综合检查流程
`pre-deploy-check.mjs`脚本在部署前对环境依赖、配置文件和网络连接进行全面检查。该脚本采用面向对象的设计，通过一系列检查方法确保项目准备就绪。

```mermaid
classDiagram
class PreDeployChecker {
+errors : string[]
+warnings : string[]
+projectRoot : string
+log(message : string, type : string) : void
+addError(message : string) : void
+addWarning(message : string) : void
+checkProjectStructure() : void
+checkPackageJson() : void
+checkEnvironmentConfig() : void
+checkTypeScriptConfig() : void
+checkCodeQuality() : void
+runTests() : void
+checkBuild() : void
+checkDependencySecurity() : void
+checkNewFeatures() : void
+generateReport() : boolean
+runAllChecks() : Promise~boolean~
}
```

**图示来源**
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs#L0-L370)

**本节来源**
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs#L0-L370)

### 配置一致性比对机制
`verify-config-match.js`脚本通过比对本地配置与远程部署平台的设置一致性来确保部署配置的正确性。该脚本检查多个配置文件中的关键值是否匹配预期的部署配置。

```mermaid
flowchart TD
Start([开始验证配置匹配性]) --> CheckConfigFiles["检查配置文件\n(deploy.yml, supabase-deploy-fixed.yml,\nnetlify.toml, config.toml, CNAME)"]
CheckConfigFiles --> CheckScriptFiles["检查脚本文件中的配置\n(check-github-secrets.js, monitor-deployment.js)"]
CheckScriptFiles --> CheckEnvVars["检查环境变量配置\n(.env.local)"]
CheckEnvVars --> GenerateSummary["生成配置总结"]
GenerateSummary --> ShowResults["显示验证结果"]
ShowResults --> End([完成])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
```

**图示来源**
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js#L0-L255)

**本节来源**
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js#L0-L255)

### GitHub Secrets 自动化配置
`setup-github-secrets.js`和`update-github-secrets.js`脚本实现了GitHub Secrets的自动化配置和更新功能。前者使用GitHub CLI直接设置Secrets，后者使用Octokit REST API进行更精细的控制。

```mermaid
sequenceDiagram
participant User as 用户
participant SetupScript as setup-github-secrets.js
participant GitHubCLI as GitHub CLI
participant GitHubAPI as GitHub API
User->>SetupScript : 运行脚本
SetupScript->>GitHubCLI : 检查gh命令是否存在
GitHubCLI-->>SetupScript : 返回版本信息
SetupScript->>GitHubCLI : 检查认证状态
GitHubCLI-->>SetupScript : 返回登录状态
alt CLI已安装且已认证
SetupScript->>GitHubCLI : 调用gh secret set命令
GitHubCLI->>GitHubAPI : 发送设置Secret请求
GitHubAPI-->>GitHubCLI : 返回结果
GitHubCLI-->>SetupScript : 返回执行结果
SetupScript->>User : 显示配置结果
else CLI未安装或未认证
SetupScript->>User : 提示安装和认证GitHub CLI
end
```

**图示来源**
- [setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js#L0-L127)
- [update-github-secrets.js](file://scripts/deployment/update-github-secrets.js#L0-L189)

**本节来源**
- [setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js#L0-L127)
- [update-github-secrets.js](file://scripts/deployment/update-github-secrets.js#L0-L189)

### Supabase 项目自动化初始化
`setup-supabase.sh`和`setup-supabase.ps1`脚本根据环境变量自动初始化Supabase项目配置。这两个脚本分别针对Unix和Windows系统提供了跨平台支持。

```mermaid
flowchart LR
A[开始] --> B{检查Supabase CLI}
B --> |未安装| C[提示安装Supabase CLI]
B --> |已安装| D{检查登录状态}
D --> |未登录| E[执行supabase login]
D --> |已登录| F[提示输入项目引用ID和数据库密码]
F --> G[执行supabase link]
G --> H[执行supabase db push]
H --> I[生成TypeScript类型定义]
I --> J[获取项目信息]
J --> K{成功获取信息?}
K --> |是| L[创建.env.local文件]
K --> |否| M[提示手动配置]
L --> N[显示完成信息]
M --> N
N --> O[结束]
```

**图示来源**
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh#L0-L126)
- [setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1#L0-L138)

**本节来源**
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh#L0-L126)
- [setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1#L0-L138)

## 依赖分析
部署准备脚本体系依赖于多个外部工具和服务，包括GitHub CLI、Supabase CLI、Node.js运行时环境以及相关的npm包。这些依赖关系确保了脚本能够与外部服务进行有效交互。

```mermaid
graph LR
A[部署准备脚本] --> B[GitHub CLI]
A --> C[Supabase CLI]
A --> D[Node.js]
A --> E[npm]
A --> F[@supabase/supabase-js]
A --> G[@octokit/rest]
A --> H[dotenv]
B --> I[GitHub API]
C --> J[Supabase服务]
D --> K[操作系统]
E --> L[包管理]
```

**图示来源**
- [package.json](file://package.json)
- [scripts/deployment](file://scripts/deployment)

**本节来源**
- [package.json](file://package.json)
- [scripts/deployment](file://scripts/deployment)

## 性能考虑
部署准备脚本的设计考虑了执行效率和资源使用。脚本采用同步执行模式，确保检查步骤按预定顺序完成。对于耗时操作如数据库连接测试和构建检查，脚本设置了适当的超时机制。

## 故障排除指南
当部署准备脚本执行失败时，可根据以下常见问题进行排查：

1. **GitHub Secrets配置问题**：确认所有必需的Secrets都已正确配置，特别是`SUPABASE_ACCESS_TOKEN`需要手动设置。
2. **环境变量不匹配**：使用`verify-config-match.js`脚本检查本地配置与远程设置的一致性。
3. **CLI工具未安装**：确保GitHub CLI和Supabase CLI已正确安装并可从命令行访问。
4. **网络连接问题**：检查与Supabase和GitHub服务的网络连接是否正常。
5. **权限不足**：确认GitHub账户具有足够的权限来读取和修改仓库Secrets。

**本节来源**
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js#L140-L169)
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)

## 结论
部署准备脚本体系为项目提供了全面的部署前验证和自动化配置能力。通过`check-github-secrets.js`、`pre-deploy-check.mjs`、`verify-config-match.js`等脚本的协同工作，确保了部署过程的可靠性和一致性。结合`netlify.toml`和GitHub Actions工作流，形成了完整的CI/CD流水线，大大提高了部署效率和质量。