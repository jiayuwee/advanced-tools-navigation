
# 部署脚本

<cite>
**本文档中引用的文件**
- [deploy.sh](file://scripts/deployment/deploy.sh)
- [deploy.ps1](file://scripts/deployment/deploy.ps1)
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js)
- [setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js)
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)
- [fix-netlify-root-directory.mjs](file://scripts/deployment/fix-netlify-root-directory.mjs)
- [monitor-deployment.js](file://scripts/deployment/monitor-deployment.js)
- [trigger-deployment.js](file://scripts/deployment/trigger-deployment.js)
- [netlify-domain-migration.js](file://scripts/deployment/netlify-domain-migration.js)
- [netlify-domain-migration.ps1](file://scripts/deployment/netlify-domain-migration.ps1)
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh)
- [setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1)
- [setup-supabase-auto.ps1](file://scripts/deployment/setup-supabase-auto.ps1)
- [github/workflows/build-verification.yml](file://github/workflows/build-verification.yml)
- [github/workflows/health-check.yml](file://github/workflows/health-check.yml)
- [netlify.toml](file://netlify.toml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文件全面解析了高级工具导航项目的部署自动化脚本集。文档详细说明了跨平台部署脚本的工作机制，包括在不同操作系统下的执行流程；深入分析了GitHub Secrets的验证与配置过程；阐述了部署前环境校验逻辑；解释了Netlify部署路径问题的修复方法；说明了与CI/CD流水线的集成方式；描述了域名迁移脚本的应用场景；介绍了Supabase环境的自动化配置流程。结合CI/CD工作流和Netlify配置文件，文档阐明了这些脚本在持续集成与持续部署流程中的调用时机与错误处理策略，并提供了完整的部署故障排查手册。

## 项目结构
项目采用模块化结构设计，主要分为源代码、配置、公共资源和脚本四大目录。源代码位于`src`目录，包含Vue组件、服务、存储和视图等前端实现。`config`目录存放不同环境的配置文件，包括构建、部署和开发配置。`public`目录包含静态资源文件。`scripts`目录是本项目的核心，包含了数据库、部署和性能优化等多个子目录的自动化脚本。

```mermaid
graph TB
subgraph "项目根目录"
A[scripts]
B[config]
C[src]
D[public]
E[supabase]
F[netlify.toml]
G[package.json]
end
A --> A1[database]
A --> A2[deployment]
A --> A3[performance]
B --> B1[build]
B --> B2[deployment]
B --> B3[development]
C --> C1[components]
C --> C2[views]
C --> C3[services]
C --> C4[stores]
A2 --> A2a[deploy.sh]
A2 --> A2b[deploy.ps1]
A2 --> A2c[check-github-secrets.js]
A2 --> A2d[setup-github-secrets.js]
A2 --> A2e[pre-deploy-check.mjs]
A2 --> A2f[verify-config-match.js]
A2 --> A2g[fix-netlify-root-directory.mjs]
A2 --> A2h[monitor-deployment.js]
A2 --> A2i[trigger-deployment.js]
A2 --> A2j[netlify-domain-migration.js]
A2 --> A2k[netlify-domain-migration.ps1]
A2 --> A2l[setup-supabase.sh]
A2 --> A2m[setup-supabase.ps1]
A2 --> A2n[setup-supabase-auto.ps1]
```

**图示来源**
- [deploy.sh](file://scripts/deployment/deploy.sh)
- [deploy.ps1](file://scripts/deployment/deploy.ps1)
- [check-github-secrets.js](file://scripts/deployment/check-github-secrets.js)
- [setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js)
- [pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [verify-config-match.js](file://scripts/deployment/verify-config-match.js)
- [fix-netlify-root-directory.mjs](file://scripts/deployment/fix-netlify-root-directory.mjs)
- [monitor-deployment.js](file://scripts/deployment/monitor-deployment.js)
- [trigger-deployment.js](file://scripts/deployment/trigger-deployment.js)
- [netlify-domain-migration.js](file://scripts/deployment/netlify-domain-migration.js)
- [netlify-domain-migration.ps1](file://scripts/deployment/netlify-domain-migration.ps1)
- [setup-supabase.sh](file://scripts/deployment/setup-supabase.sh)
- [setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1)
- [setup-supabase-auto.ps1](file://scripts/deployment/setup-supabase-auto.ps1)

**章节来源**
- [scripts](file://scripts)
- [config](file://config)
- [src](file://src)
- [public](file://public)

## 核心组件
部署脚本集的核心组件包括跨平台部署脚本、GitHub Secrets管理工具、部署前检查工具、Netlify配置修复工具、CI/CD集成工具、域名迁移工具和Supabase自动化配置工具。这些组件共同构成了一个完整的自动化部署生态系统，确保了从开发到生产环境的平滑过渡。

**章节来源**
- [scripts/deployment](file://scripts/deployment)
- [github/workflows](file://github/workflows)
- [netlify.toml](file://netlify.toml)

## 架构概述
部署架构采用分层设计，包括本地开发环境、CI/CD流水线和生产环境三个主要层次。本地脚本负责环境准备和预部署检查，GitHub Actions工作流处理持续集成和自动化测试，Netlify负责静态站点的构建和部署。整个流程通过环境变量和密钥管理确保安全性，通过自动化脚本提高部署效率和可靠性。

```mermaid
graph LR
A[本地开发环境] --> B[CI/CD流水线]
B --> C[生产环境]
A --> A1[deploy.sh]
A --> A2[deploy.ps1]
A --> A3[pre-deploy-check.mjs]
A --> A4[verify-config-match.js]
B --> B1[build-verification.yml]
B --> B2[health-check.yml]
B --> B3[GitHub Actions]
C --> C1[Netlify]
C --> C2[Supabase]
C --> C3[自定义域名]
A1 --> B1
A2 --> B1
A3 --> B1
A4 --> B1
B3 --> C1
C1 --> C3
D[监控] --> C
D --> E[警报]
F[域名迁移] --> C3
G[Supabase配置] --> C2
```

**图示来源**
- [github/workflows/build-verification.yml](file://github/workflows/build-verification.yml)
- [github/workflows/health-check.yml](file://github/workflows/health-check.yml)
- [netlify.toml](file://netlify.toml)
- [scripts/deployment/deploy.sh](file://scripts/deployment/deploy.sh)
- [scripts/deployment/deploy.ps1](file://scripts/deployment/deploy.ps1)
- [scripts/deployment/pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [scripts/deployment/verify-config-match.js](file://scripts/deployment/verify-config-match.js)

## 详细组件分析

### 跨平台部署脚本分析
跨平台部署脚本包括`deploy.sh`和`deploy.ps1`，分别用于Linux/Unix和Windows系统。这些脚本实现了统一的部署流程，包括环境检查、依赖安装、项目构建和服务器部署等步骤。

#### 部署脚本流程图
```mermaid
flowchart TD
Start([开始部署]) --> CheckNode["检查 Node.js 环境"]
CheckNode --> CheckNPM["检查 npm 环境"]
CheckNPM --> InstallDeps["安装依赖"]
InstallDeps --> Build["构建项目"]
Build --> CheckDist["检查 dist 目录"]
CheckDist --> Deploy["部署到服务器"]
Deploy --> Complete["部署完成"]
CheckNode --> |未安装| Error1["❌ Node.js 未安装"]
CheckNPM --> |未安装| Error2["❌ npm 未安装"]
CheckDist --> |不存在| Error3["❌ 构建失败"]
Error1 --> Exit1[退出]
Error2 --> Exit1
Error3 --> Exit1
Complete --> Success["✅ 部署完成"]
style Start fill:#4CAF50,stroke:#388E3C
style Complete fill:#4CAF50,stroke:#388E3C
style Success fill:#4CAF50,stroke:#388E3C
style Error1 fill:#F44336,stroke:#D32F2F
style Error2 fill:#F44336,stroke:#D32F2F
style Error3 fill:#F44336,stroke:#D32F2F
```

**图示来源**
- [scripts/deployment/deploy.sh](file://scripts/deployment/deploy.sh)
- [scripts/deployment/deploy.ps1](file://scripts/deployment/deploy.ps1)

**章节来源**
- [scripts/deployment/deploy.sh](file://scripts/deployment/deploy.sh#L1-L60)
- [scripts/deployment/deploy.ps1](file://scripts/deployment/deploy.ps1#L1-L37)

### GitHub Secrets管理分析
GitHub Secrets管理工具包括`check-github-secrets.js`和`setup-github-secrets.js`，用于验证和配置GitHub Actions所需的密钥。这些工具确保了敏感信息的安全存储和正确配置。

#### GitHub Secrets配置流程
```mermaid
sequenceDiagram
participant User as "用户"
participant SetupScript as "setup-github-secrets.js"
participant GHCLI as "GitHub CLI"
participant GitHub as "GitHub API"
User->>SetupScript : 运行脚本
SetupScript->>SetupScript : 检查 GitHub CLI
SetupScript->>GHCLI : gh --version
GHCLI-->>SetupScript : 版本信息
SetupScript->>SetupScript : 检查认证状态
SetupScript->>GHCLI : gh auth status
GHCLI-->>SetupScript : 登录状态
SetupScript->>SetupScript : 加载环境变量
SetupScript->>SetupScript : 配置 Secrets
loop 每个 Secret
SetupScript->>GitHub : gh secret set
GitHub-->>SetupScript : 设置结果
SetupScript->>User : 显示配置状态
end
SetupScript->>User : 完成提示
```

**图示来源**
- [scripts/deployment/setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js)
- [scripts/deployment/check-github-secrets.js](file://scripts/deployment/check-github-secrets.js)

**章节来源**
- [scripts/deployment/setup-github-secrets.js](file://scripts/deployment/setup-github-secrets.js#L1-L49)
- [scripts/deployment/check-github-secrets.js](file://scripts/deployment/check-github-secrets.js#L1-L169)

### 部署前检查分析
部署前检查工具包括`pre-deploy-check.mjs`和`verify-config-match.js`，用于在部署前验证项目配置、依赖、测试等是否准备就绪。

#### 部署前检查流程
```mermaid
flowchart TD
A[开始检查] --> B[检查项目结构]
B --> C[检查 package.json]
C --> D[检查环境配置]
D --> E[检查 TypeScript 配置]
E --> F[检查代码质量]
F --> G[运行测试]
G --> H[检查构建]
H --> I[检查依赖安全]
I --> J[检查新功能]
J --> K[生成报告]
K --> L{错误数量 > 0}
L --> |是| M[显示错误]
L --> |否| N{警告数量 > 0}
N --> |是| O[显示警告]
N --> |否| P[检查通过]
M --> Q[检查失败]
O --> R[建议修复]
P --> S[检查通过]
style Q fill:#F44336,stroke:#D32F2F
style R fill:#FFC107,stroke:#FFA000
style S fill:#4CAF50,stroke:#388E3C
```

**图示来源**
- [scripts/deployment/pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs)
- [scripts/deployment/verify-config-match.js](file://scripts/deployment/verify-config-match.js)

**章节来源**
- [scripts/deployment/pre-deploy-check.mjs](file://scripts/deployment/pre-deploy-check.mjs#L1-L61)
- [scripts/deployment/verify-config-match.js](file://scripts/deployment/verify-config-match.js#L1-L152)

### Netlify配置修复分析
`fix-netlify-root-directory.mjs`脚本用于修复Netlify部署路径问题，特别是当Netlify站点设置中配置了错误的根目录时。

#### Netlify配置修复流程
```mermaid
flowchart TD
A[开始修复] --> B[分析问题]
B --> C[检查项目结构]
C --> D[检查 netlify.toml]
D --> E[提供修复步骤]
B --> B1["❌ 错误: 根目录不存在"]
B --> B2["🔍 原因: 配置了错误的根目录"]
B --> B3["💡 解决方案: 修正 Root Directory 设置"]
C --> C1["✅ 项目根目录存在"]
C --> C2["✅ 关键文件存在"]
D --> D1["✅ netlify.toml 存在"]
D --> D2["✅ 发布目录配置正确"]
D --> D3["⚠️ base 配置可能导致问题"]
E --> E1["1. 登录 Netlify 控制台"]
E --> E2["2. 进入站点设置"]
E --> E3["3. 修改构建设置"]
E --> E4["4. 保存设置"]
E --> E5["5. 触发新部署"]
style A fill:#2196F3,stroke:#1976D2
style B fill:#FF9800,stroke:#F57C00
style C fill:#4CAF50,stroke:#388E3C
style D fill:#4CAF50,stroke:#388E3C
style E fill:#9C27B0,stroke:#7B1FA2
```

**图示来源**
- [scripts/deployment/fix-netlify-root-directory.mjs](file://scripts/deployment/fix-netlify-root-directory.mjs)

**章节来源**
- [scripts/deployment/fix-netlify-root-directory.mjs](file://scripts/deployment/fix-netlify-root-directory.mjs#L1-L85)

### CI/CD集成分析
CI/CD集成工具包括`monitor-deployment.js`和`trigger-deployment.js`，用于与GitHub Actions流水线集成，实现部署的监控和触发。

#### CI/CD集成流程
```mermaid
sequenceDiagram
participant User as "用户"
participant Trigger as "trigger-deployment.js"
participant GitHub as "GitHub API"
participant Actions as "GitHub Actions"
participant Monitor as "monitor-deployment.js"
User->>Trigger : 运行触发脚本
Trigger->>Trigger : 检查环境变量
Trigger->>GitHub : 认证请求
GitHub-->>Trigger : 认证结果
Trigger->>Actions : 触发工作流
Actions-->>Trigger : 触发结果
Trigger->>User : 显示结果
User->>Monitor : 运行监控脚本
Monitor->>Monitor : 加载配置
Monitor->>Actions : 获取运行状态
Actions-->>Monitor : 状态信息
Monitor->>Monitor : 分析结果
Monitor->>User : 显示健康状态
loop 定期检查
Monitor->>Actions : 获取最新状态
Actions-->>Monitor : 状态更新
Monitor->>Monitor : 评估健康度
alt 状态异常
Monitor->>User : 发送警报
end
end
```

**图示来源**
- [scripts/deployment/trigger-deployment.js](file://scripts/deployment/trigger-deployment.js)
- [scripts/deployment/monitor-deployment.js](file://scripts/deployment/monitor-deployment.js)

**章节来源**
- [scripts/deployment/trigger-deployment.js](file://scripts/deployment/trigger-deployment.js#L1-L180)
- [scripts/deployment/monitor-deployment.js](file://scripts/deployment/monitor-deployment.js#L1-L341)

### 域名迁移分析
`netlify-domain-migration`系列脚本用于在Netlify站点之间迁移自定义域名，支持JavaScript和PowerShell两种实现。

#### 域名迁移流程
```mermaid
flowchart TD
A[开始迁移] --> B[验证参数]
B --> C[查找源站点]
C --> D[验证目标站点]
D --> E[从源站点移除域名]
E --> F[等待更改生效]
F --> G[添加域名到目标站点]
G --> H[完成迁移]
B --> B1["AccessToken"]
B --> B2["Domain"]
B --> B3["TargetSiteId"]
C --> C1["获取所有站点"]
C --> C2["查找使用域名的站点"]
D --> D1["获取目标站点信息"]
D --> D2["验证权限"]
E --> E1["更新源站点配置"]
E --> E2["移除自定义域名"]
F --> F1["等待 3 秒"]
G --> G1["更新目标站点配置"]
G --> G2["设置自定义域名"]
H --> H1["显示迁移结果"]
H --> H2["提供后续步骤"]
style A fill:#2196F3,stroke:#1976D2
style B fill:#FF9800,stroke:#F57C00
style C fill:#4CAF50,stroke:#388E3C
style D fill:#4CAF50,stroke:#388E3C
style E fill:#FF5722,stroke:#D84315
style F fill:#795548,stroke:#5D4037
style G fill:#FF5722,stroke:#D84315
style H fill:#4CAF50,stroke:#388E3C
```

**图示来源**
- [scripts/deployment/netlify-domain-migration.js](file://scripts/deployment/netlify-domain-migration.js)
- [scripts/deployment/netlify-domain-migration.ps1](file://scripts/deployment/netlify-domain-migration.ps1)

**章节来源**
- [scripts/deployment/netlify-domain-migration.js](file://scripts/deployment/netlify-domain-migration.js#L1-L274)
- [scripts/deployment/netlify-domain-migration.ps1](file://scripts/deployment/netlify-domain-migration.ps1#L1-L214)

### Supabase配置分析
Supabase配置工具包括`setup-supabase`系列脚本，用于自动化配置Supabase环境，支持跨平台操作。

#### Supabase配置流程
```mermaid
flowchart TD
A[开始配置] --> B[检查环境]
B --> C[检查 Supabase CLI]
C --> D[检查登录状态]
D --> E[获取项目信息]
E --> F[链接到项目]
F --> G[配置环境变量]
G --> H[完成设置]
B --> B1["Node.js"]
B --> B2["npm"]
C --> C1["检查命令是否存在"]
C --> C2["提示安装"]
D --> D1["检查认证状态"]
D --> D2["提示登录"]
E --> E1["输入项目引用 ID"]
E --> E2["输入数据库密码"]
F --> F1["supabase link"]
F --> F2["验证链接结果"]
G --> G1["创建 .env.local"]
G --> G2["写入配置"]
H --> H1["显示完成信息"]
H --> H2["提供后续步骤"]
style A fill:#2196F3,stroke:#1976D2
style B fill:#FF9800,stroke:#F57C00
style C fill:#4CAF50,stroke:#388E3C
style D fill:#4CAF50,stroke:#388E3C
style E fill:#FF5722,stroke:#D84315
style F fill:#FF5722,stroke:#D84315
style G fill:#9C27B0,stroke:#7B1FA2
style H fill:#4CAF50,stroke:#388E3C
```

**图示来源**
- [scripts/deployment/setup-supabase.sh](file://scripts/deployment/setup-supabase.sh)
- [scripts/deployment/setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1)
- [scripts/deployment/setup-supabase-auto.ps1](file://scripts/deployment/setup-supabase-auto.ps1)

**章节来源**
- [scripts/deployment/setup-supabase.sh](file://scripts/deployment/setup-supabase.sh#L1-L59)
- [scripts/deployment/setup-supabase.ps1](file://scripts/deployment/setup-supabase.ps1#L1-L44)
- [scripts/deployment/setup-supabase-auto.ps1](file://scripts/deployment/setup-supabase-auto.ps1#L1-L49)

## 依赖分析
部署脚本集依赖于多个外部工具和API，包括Node.js、npm、Supabase CLI、GitHub CLI和Netlify API。这些依赖关系确保了脚本能够与相应的服务进行交互，实现自动化部署和管理功能。

```mermaid
graph TD
A[部署脚本] --> B[Node.js]
A --> C[npm]
A --> D[Supabase CLI]
A --> E[GitHub CLI]
A --> F[Netlify API]
B --> G[JavaScript 运行时]
C --> H[包管理]
D --> I[Supabase 服务管理]
E --> J[GitHub 仓库管理]
F --> K[Netlify 部署管理]
A --> L[本地环境]
L --> M[操作系统]
M --> N[Linux/Unix]
M --> O[Windows]
A --> P[配置文件]
P --> Q[.env.local]
P --> R[netlify.toml]
P --> S[supabase/config.toml]
style A fill:#2196F3,stroke:#1976D2
style B fill:#4CAF50,stroke:#388E3C
style C fill:#4CAF50,stroke:#388E3C
style D fill:#4CAF50,stroke:#388E3C
style E fill:#4CAF50,stroke:#388E3C
style F fill:#4CAF50,stroke:#388E3C
style L fill:#FF9800,stroke:#F57C00
style P fill:#9C27B0,stroke:#7B1FA2
```

**图示来源**
- [package.json](file://package.json)
- [go.mod](file://go.mod)

