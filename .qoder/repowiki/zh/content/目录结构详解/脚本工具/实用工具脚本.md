# 实用工具脚本

<cite>
**本文档中引用的文件**  
- [fix-database-connection.js](file://scripts/fix-database-connection.js)
- [generate-default-icon.js](file://scripts/generate-default-icon.js)
- [init-data.js](file://scripts/init-data.js)
</cite>

## 目录
1. [简介](#简介)
2. [数据库连接修复脚本](#数据库连接修复脚本)
3. [默认图标生成脚本](#默认图标生成脚本)
4. [数据初始化脚本](#数据初始化脚本)
5. [命令行调用方式与参数说明](#命令行调用方式与参数说明)
6. [典型使用场景](#典型使用场景)
7. [在开发工作流中的定位](#在开发工作流中的定位)

## 简介
本项目包含多个独立的实用工具脚本，用于支持开发、部署和维护流程。这些脚本分别负责数据库连接诊断与修复、默认图标生成以及项目初始化时的数据填充。它们通过命令行调用，具备清晰的功能划分和可复用性，是项目自动化和环境一致性保障的重要组成部分。

## 数据库连接修复脚本

`fix-database-connection.js` 是一个用于诊断并修复 Supabase 数据库连接问题的独立工具脚本。该脚本通过系统化的检查流程，帮助开发者快速识别和解决常见的连接故障。

### 功能机制
该脚本实现了以下核心功能：

- **环境配置校验**：加载 `.env.local` 文件中的 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 环境变量，并验证其是否存在。若缺失，脚本将输出错误提示并终止执行。
- **连接诊断**：使用 `@supabase/supabase-js` 创建客户端实例，尝试从 `categories` 表中查询一条记录以测试基本连接能力。
- **智能错误提示**：当连接失败且错误信息包含 "Legacy API keys are disabled" 时，脚本会提供具体的解决方案指引，包括访问 Supabase 控制台重新启用旧版密钥或更新密钥。
- **表状态检查**：连接成功后，脚本会检查 `categories` 和 `tools` 表的数据可读性，并输出前10条记录的摘要信息。
- **数据重初始化（可选）**：当传入 `--reinit` 参数时，脚本将清空现有数据并插入预设的示例分类和工具数据，用于快速恢复测试环境。

此脚本集成了超时重试（由 Supabase 客户端内部处理）、配置校验和详细的错误日志输出机制，为开发者提供了端到端的诊断体验。

**Section sources**
- [fix-database-connection.js](file://scripts/fix-database-connection.js#L1-L262)

## 默认图标生成脚本

`generate-default-icon.js` 是一个用于基于工具名称生成 SVG 格式默认图标的脚本。它利用 `canvas` 库在 Node.js 环境中动态绘制图像。

### 功能机制
该脚本的工作流程如下：

- **画布创建**：创建一个 180x180 像素的画布。
- **颜色算法**：背景色固定为 Google 风格的蓝色 `#4285f4`，文字颜色为白色 `#ffffff`，确保高对比度和视觉一致性。
- **文字布局**：使用 `Arial` 字体，字号为 100px，加粗显示。文字水平和垂直居中对齐，坐标为画布中心点 (90, 90)。
- **文件输出流程**：脚本绘制一个大写的字母 "A" 作为占位符图标，然后通过 `createPNGStream()` 将画布内容转换为 PNG 流，并通过 `createWriteStream` 写入 `public/apple-touch-icon.png` 文件。操作完成后输出成功日志。

尽管当前脚本生成的是静态的 "A" 图标，但其结构为未来扩展（如根据工具名称首字母动态生成图标）提供了基础。

**Section sources**
- [generate-default-icon.js](file://scripts/generate-default-icon.js#L1-L34)

## 数据初始化脚本

`init-data.js` 是一个在项目初始化时用于搭建完整数据环境的一站式脚本。它通过调用 Supabase API 完成数据库的初始数据填充。

### 功能机制
该脚本的主要流程包括：

- **环境准备**：加载环境变量并验证 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 的存在性。
- **Supabase 客户端初始化**：使用环境变量创建 Supabase 客户端实例。
- **分类数据插入**：定义了包含名称、图标、描述和颜色的五个示例分类（如“开发工具”、“设计工具”等），并将其批量插入 `categories` 表。
- **工具数据插入**：定义了多个示例工具数据，每个工具关联到一个分类名称。脚本在插入前会根据分类名称查找对应的 `category_id`，确保外键关系的正确性。工具数据包含名称、描述、URL、标签、是否推荐等丰富属性。
- **错误处理**：在插入过程中，脚本会捕获并输出任何错误，确保初始化过程的透明性。

该脚本通过一次执行完成数据库的初始化，是项目快速启动和演示环境搭建的关键。

**Section sources**
- [init-data.js](file://scripts/init-data.js#L1-L219)

## 命令行调用方式与参数说明

以下是三个脚本的命令行调用方式和参数说明：

| 脚本名称 | 调用命令 | 参数说明 | 典型输出 |
|--------|--------|--------|--------|
| `fix-database-connection.js` | `node scripts/fix-database-connection.js` | 无参数：仅诊断连接<br>`--reinit`：诊断后重新初始化数据 | 连接状态、环境变量检查、表数据摘要、数据重初始化结果 |
| `generate-default-icon.js` | `node scripts/generate-default-icon.js` | 无参数 | 输出 "默认图标已生成: public/apple-touch-icon.png" |
| `init-data.js` | `node scripts/init-data.js` | 无参数 | 输出数据插入过程日志，包括分类和工具的插入状态 |

## 典型使用场景

- **`fix-database-connection.js`**：
  - 开发者在本地启动项目时遇到数据库连接失败。
  - 部署后发现数据表为空或数据异常，需要快速恢复示例数据。
  - 团队新成员配置环境后，验证 Supabase 连接是否正确。

- **`generate-default-icon.js`**：
  - 项目初始化时，为 PWA（渐进式 Web 应用）生成默认的 `apple-touch-icon.png`。
  - 在缺少自定义图标的情况下，提供一个临时的、视觉上一致的占位图标。

- **`init-data.js`**：
  - 项目首次部署或数据库重置后，填充基础分类和示例工具数据。
  - 在演示或测试环境中，快速搭建一个包含丰富数据的可交互系统。

## 在开发工作流中的定位

这些实用工具脚本在开发工作流中扮演着“自动化助手”的角色。它们将重复性、易出错的手动操作（如检查环境变量、手动插入数据、生成静态资源）转化为可执行、可版本控制的脚本。这不仅提高了开发效率，还确保了不同环境（本地、测试、演示）之间的一致性。通过将这些脚本集成到项目的 `package.json` 的 `scripts` 字段中，可以进一步简化调用，成为标准开发流程的一部分。