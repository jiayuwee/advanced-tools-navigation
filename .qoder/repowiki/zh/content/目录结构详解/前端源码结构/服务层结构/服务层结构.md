# 服务层结构

<cite>
**本文档中引用的文件**  
- [authService.ts](file://src/services/authService.ts)
- [categoriesService.ts](file://src/services/categoriesService.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [favoritesService.ts](file://src/services/favoritesService.ts)
- [feedbackService.ts](file://src/services/feedbackService.ts)
- [localStorageService.ts](file://src/services/localStorageService.ts)
- [notificationService.ts](file://src/services/notificationService.ts)
- [orderService.ts](file://src/services/orderService.ts)
- [performanceService.ts](file://src/services/performanceService.ts)
- [productsService.ts](file://src/services/productsService.ts)
- [reviewService.ts](file://src/services/reviewService.ts)
- [searchService.ts](file://src/services/searchService.ts)
- [toolsService.ts](file://src/services/toolsService.ts)
- [userService.ts](file://src/services/userService.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
</cite>

## 目录
1. [简介](#简介)
2. [认证服务](#认证服务)
3. [分类服务](#分类服务)
4. [数据库服务](#数据库服务)
5. [收藏服务](#收藏服务)
6. [反馈服务](#反馈服务)
7. [本地存储服务](#本地存储服务)
8. [通知服务](#通知服务)
9. [订单服务](#订单服务)
10. [性能服务](#性能服务)
11. [产品服务](#产品服务)
12. [评价服务](#评价服务)
13. [搜索服务](#搜索服务)
14. [工具服务](#工具服务)
15. [用户服务](#用户服务)
16. [Supabase客户端集成](#supabase客户端集成)

## 简介
本项目的服务层位于`src/services`目录下，为前端应用提供了统一的后端交互接口。各服务模块通过封装Supabase API，实现了用户认证、数据操作、状态管理等核心功能。服务层采用类静态方法模式，提供清晰的API接口，同时通过错误处理、缓存机制和实时订阅等功能，确保了应用的稳定性和响应性。

## 认证服务
`authService.ts`封装了用户认证流程，包括登录、注册、密码重置等核心功能。服务通过Supabase Auth模块实现安全的身份验证，支持邮箱密码登录、第三方登录（Google、GitHub）以及密码管理功能。

认证流程包括：
- **登录**：验证用户凭证，更新最后登录时间，并获取用户资料
- **注册**：检查用户名可用性，创建用户账户和资料
- **密码管理**：支持忘记密码、重置密码和更改密码功能
- **会话管理**：提供会话获取、刷新和登出功能
- **邮箱验证**：支持邮箱验证和重新发送验证邮件

服务还实现了错误处理机制，通过`ErrorHandler`统一处理API错误，并提供用户友好的错误信息。

**Section sources**
- [authService.ts](file://src/services/authService.ts#L1-L293)

## 分类服务
`categoriesService.ts`负责分类数据的获取与管理。服务提供了分类的增删改查功能，并实现了分类树结构的构建和统计信息的获取。

核心功能包括：
- **分类获取**：获取所有激活的分类，按排序顺序排列
- **分类树构建**：将扁平化的分类数据构建成树形结构，支持多级分类
- **统计信息**：获取每个分类的工具数量统计，并在分类树中显示
- **分类管理**：支持创建、更新和删除分类，删除时进行完整性检查

服务在获取分类数据时，会自动构建树形结构，将具有父子关系的分类组织成层级结构，便于前端展示。

**Section sources**
- [categoriesService.ts](file://src/services/categoriesService.ts#L1-L278)

## 数据库服务
`databaseService.ts`提供了底层数据库操作的抽象层。服务封装了通用的CRUD操作，并实现了缓存、分页、排序和实时订阅等高级功能。

主要特性包括：
- **通用查询**：支持分页、排序、过滤和搜索的通用查询方法
- **缓存机制**：内置内存缓存，支持TTL过期策略，提高数据访问性能
- **批量操作**：支持批量创建、更新和删除操作
- **实时订阅**：支持对数据库表的实时变更订阅
- **统计功能**：提供表级统计信息和健康检查功能

服务通过`QueryResult`接口返回分页数据，包含数据列表、总数、页码等信息，便于前端实现分页控件。

**Section sources**
- [databaseService.ts](file://src/services/databaseService.ts#L1-L405)

## 收藏服务
`favoritesService.ts`管理用户的收藏功能，支持工具和产品的收藏与状态同步。服务通过`favorites`表记录用户的收藏行为，并提供相应的查询和管理接口。

核心功能包括：
- **收藏管理**：添加、移除和清空收藏
- **收藏查询**：获取用户收藏的工具和产品列表
- **状态检查**：检查特定项目是否已被收藏
- **统计信息**：获取用户的收藏统计
- **批量操作**：支持批量添加收藏

服务在查询收藏时，会通过JOIN操作获取关联的工具或产品信息，并标记`isFavorite`状态，便于前端直接使用。

**Section sources**
- [favoritesService.ts](file://src/services/favoritesService.ts#L1-L342)

## 反馈服务
`feedbackService.ts`处理用户反馈的提交与管理。服务提供了完整的反馈生命周期管理，包括提交、回复、状态更新和统计分析。

主要功能包括：
- **反馈提交**：用户提交反馈，支持多种类型和优先级
- **反馈管理**：管理员查看、回复和更新反馈状态
- **通知机制**：反馈提交和回复时通知相关人员
- **统计分析**：提供反馈的统计信息，包括响应率和平均响应时间
- **搜索功能**：支持按条件搜索反馈

服务通过`user_feedback`表存储反馈数据，并关联用户资料，便于识别反馈来源。

**Section sources**
- [feedbackService.ts](file://src/services/feedbackService.ts#L1-L508)

## 本地存储服务
`localStorageService.ts`封装了浏览器本地存储功能，提供统一的数据管理接口。服务支持工具、分类等数据的本地存储，并实现了离线操作队列和同步机制。

核心功能包括：
- **数据管理**：提供工具、分类等数据的增删改查
- **用户偏好**：存储和管理用户界面偏好设置
- **离线队列**：记录离线操作，支持网络恢复后同步
- **同步管理**：跟踪最后同步时间，支持数据同步
- **存储监控**：提供本地存储使用情况的统计信息

服务通过`LOCAL_STORAGE_KEYS`常量定义存储键名，确保键名的一致性和可维护性。

**Section sources**
- [localStorageService.ts](file://src/services/localStorageService.ts#L1-L339)

## 通知服务
`notificationService.ts`管理实时通知的推送与读取。服务支持系统通知、产品通知和订单通知等多种类型，并提供通知偏好设置。

主要功能包括：
- **通知管理**：创建、读取、删除通知
- **实时推送**：通过Supabase实时功能推送新通知
- **通知偏好**：用户可自定义通知接收偏好
- **浏览器通知**：支持桌面通知提醒
- **批量操作**：支持批量标记已读和发送系统通知

服务通过`notifications`表存储通知数据，并支持重要通知标记和过期时间设置。

**Section sources**
- [notificationService.ts](file://src/services/notificationService.ts#L1-L514)

## 订单服务
`orderService.ts`处理订单的创建、查询和状态更新。服务实现了完整的订单生命周期管理，包括创建、支付、取消和统计分析。

核心功能包括：
- **订单创建**：创建新订单，验证产品信息和库存
- **支付处理**：更新订单支付状态
- **订单查询**：获取用户订单列表和详情
- **订单管理**：支持取消订单和管理员操作
- **权限验证**：验证用户对数字产品的下载权限
- **统计报表**：提供订单统计和数据导出功能

服务通过`orders`和`order_items`表管理订单数据，并关联用户和产品信息。

**Section sources**
- [orderService.ts](file://src/services/orderService.ts#L1-L591)

## 性能服务
`performanceService.ts`负责性能监控与数据上报。服务收集应用运行时的性能数据，包括加载时间、API响应时间和资源使用情况，并将数据上报到分析系统。

主要功能包括：
- **性能监控**：记录关键操作的执行时间
- **数据上报**：将性能数据发送到分析服务器
- **错误追踪**：记录和上报运行时错误
- **用户体验指标**：收集用户交互数据

服务通过`analytics`表存储性能数据，支持后续的数据分析和优化决策。

**Section sources**
- [performanceService.ts](file://src/services/performanceService.ts)

## 产品服务
`productsService.ts`管理产品数据的操作与库存。服务提供产品的增删改查功能，并实现库存管理和状态同步。

核心功能包括：
- **产品管理**：创建、更新和删除产品
- **库存管理**：跟踪产品库存数量，支持库存更新
- **状态管理**：管理产品上下架状态
- **分类关联**：管理产品与分类的关联关系
- **搜索优化**：支持产品搜索和过滤

服务通过`products`表存储产品数据，并关联分类信息，支持多维度的产品展示。

**Section sources**
- [productsService.ts](file://src/services/productsService.ts)

## 评价服务
`reviewService.ts`处理评价的提交、审核与展示。服务实现完整的评价生命周期管理，包括创建、更新、删除和审核流程。

主要功能包括：
- **评价提交**：用户提交产品评价
- **评价管理**：查看、更新和删除评价
- **审核流程**：支持评价的审核和状态管理
- **评分计算**：自动计算产品平均评分
- **展示优化**：支持评价的分页和排序展示

服务通过`reviews`表存储评价数据，并关联用户和产品信息，确保评价的真实性和可追溯性。

**Section sources**
- [reviewService.ts](file://src/services/reviewService.ts)

## 搜索服务
`searchService.ts`实现全文搜索与过滤查询功能。服务支持对工具、产品等内容的多字段搜索，并提供高级过滤选项。

核心功能包括：
- **全文搜索**：支持关键词在多个字段中的模糊匹配
- **过滤查询**：支持按分类、状态等条件过滤
- **排序功能**：支持按相关性、时间等维度排序
- **结果高亮**：在搜索结果中高亮匹配关键词
- **性能优化**：通过索引和缓存提高搜索性能

服务通过组合多个字段的ILIKE查询实现全文搜索，并支持搜索结果的分页和统计。

**Section sources**
- [searchService.ts](file://src/services/searchService.ts)

## 工具服务
`toolsService.ts`管理工具数据的全生命周期。服务提供工具的创建、更新、删除和查询功能，并实现分类关联和状态管理。

主要功能包括：
- **工具管理**：完整的CRUD操作
- **分类关联**：管理工具与分类的关联关系
- **状态管理**：支持工具的激活、停用状态
- **排序管理**：支持自定义排序
- **元数据管理**：管理SEO相关的元标题和描述

服务通过`tools`表存储工具数据，并关联分类和标签信息，支持丰富的工具展示。

**Section sources**
- [toolsService.ts](file://src/services/toolsService.ts)

## 用户服务
`userService.ts`处理用户信息操作与权限验证。服务提供用户资料的管理功能，并实现角色权限验证。

核心功能包括：
- **用户管理**：创建、更新和删除用户资料
- **权限验证**：验证用户角色和操作权限
- **资料同步**：同步用户资料与认证信息
- **最后登录**：记录用户最后登录时间
- **账户管理**：支持账户删除等操作

服务通过`user_profiles`表存储用户扩展资料，并与Supabase Auth系统集成，实现统一的用户管理。

**Section sources**
- [userService.ts](file://src/services/userService.ts)

## Supabase客户端集成
`supabaseClient.ts`是所有服务模块与Supabase后端交互的核心配置。文件创建了Supabase客户端实例，并定义了全局常量和工具函数。

主要配置包括：
- **客户端初始化**：使用环境变量配置Supabase URL和匿名密钥
- **表名常量**：定义所有数据库表的常量，避免硬编码
- **存储桶常量**：定义文件存储桶的常量
- **实时频道**：定义实时订阅的频道名称
- **错误处理**：提供统一的错误处理函数
- **辅助函数**：提供用户认证状态检查、角色验证和文件操作等辅助功能

服务模块通过导入`supabase`实例与Supabase API交互，确保了配置的一致性和可维护性。环境变量验证机制确保了开发和生产环境的正确配置。

**Section sources**
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L1-L267)