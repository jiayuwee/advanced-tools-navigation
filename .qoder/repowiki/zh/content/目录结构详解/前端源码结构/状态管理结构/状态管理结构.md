# 状态管理结构

<cite>
**本文档中引用的文件**  
- [auth.ts](file://src/stores/auth.ts)
- [categories.ts](file://src/stores/categories.ts)
- [localManagement.ts](file://src/stores/localManagement.ts)
- [products.ts](file://src/stores/products.ts)
- [tools.ts](file://src/stores/tools.ts)
- [main.ts](file://src/main.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本项目采用 Vue 3 和 Pinia 构建，实现了基于 Supabase 的全栈工具导航系统。状态管理模块是整个应用的核心，负责用户认证、工具数据、分类信息、产品管理及本地化功能的统一管理。通过 Pinia 的模块化 Store 设计，实现了状态的集中化、响应式和可维护性。本文档深入解析 `src/stores` 目录下的各个状态管理模块及其在 `main.ts` 中的集成方式。

## 项目结构
项目采用标准的 Vue + Vite 架构，状态管理集中于 `src/stores` 目录。各 Store 模块职责分明，通过 `main.ts` 统一注册和初始化。

```mermaid
graph TB
subgraph "src"
subgraph "stores"
auth[auth.ts]
categories[categories.ts]
localManagement[localManagement.ts]
products[products.ts]
tools[tools.ts]
end
main[main.ts]
services[services/]
types[types/]
end
supabase[Supabase]
auth --> supabase
categories --> supabase
products --> supabase
tools --> supabase
localManagement --> services
main --> stores
```

**Diagram sources**
- [main.ts](file://src/main.ts#L1-L59)
- [auth.ts](file://src/stores/auth.ts#L1-L152)
- [categories.ts](file://src/stores/categories.ts#L1-L199)
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)
- [products.ts](file://src/stores/products.ts#L1-L363)
- [tools.ts](file://src/stores/tools.ts#L1-L342)

**Section sources**
- [main.ts](file://src/main.ts#L1-L59)
- [src/stores](file://src/stores)

## 核心组件
`src/stores` 目录下的五个核心 Store 模块构成了应用的全局状态中心，分别管理用户认证、分类数据、本地化功能、产品信息和工具列表。

**Section sources**
- [auth.ts](file://src/stores/auth.ts#L1-L152)
- [categories.ts](file://src/stores/categories.ts#L1-L199)
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)
- [products.ts](file://src/stores/products.ts#L1-L363)
- [tools.ts](file://src/stores/tools.ts#L1-L342)

## 架构概览
系统采用分层架构，Pinia Store 作为中间层，连接 Vue 组件与后端服务（Supabase）。`main.ts` 负责初始化所有核心 Store。

```mermaid
graph TD
A[Vue Components] --> B[Pinia Stores]
B --> C[Supabase API]
B --> D[Local Storage]
B --> E[Services]
F[main.ts] --> B
F --> G[Router]
A --> F
```

**Diagram sources**
- [main.ts](file://src/main.ts#L1-L59)
- [auth.ts](file://src/stores/auth.ts#L1-L152)
- [services](file://src/services)

## 详细组件分析

### 认证模块分析
`auth.ts` 模块负责管理用户登录状态、权限和用户资料。

#### 类图
```mermaid
classDiagram
class useAuthStore {
+user : UserProfile | null
+loading : boolean
+initialized : boolean
+error : AuthError | null
+isAuthenticated : boolean
+isAdmin : boolean
+initialize() : void
+logout() : Promise~void~
+clearError() : void
}
class UserProfile {
+id : string
+email : string
+username : string
+avatar_url : string
+role : "user" | "admin" | "super_admin"
}
useAuthStore --> UserProfile : "包含"
```

**Diagram sources**
- [auth.ts](file://src/stores/auth.ts#L1-L152)

**Section sources**
- [auth.ts](file://src/stores/auth.ts#L1-L152)

### 分类模块分析
`categories.ts` 模块管理工具分类数据，支持缓存和离线回退。

#### 类图
```mermaid
classDiagram
class useCategoriesStore {
+categories : Category[]
+loading : boolean
+error : Error | null
+initialized : boolean
+fetchCategories() : Promise~void~
+initialize() : Promise~void~
+clearError() : void
+loadCategories() : Promise~void~
}
class Category {
+id : string
+name : string
+description : string
+icon : string
+color : string
+parent_id : string | null
+sort_order : number
+is_active : boolean
+created_at : string
+updated_at : string
}
useCategoriesStore --> Category : "包含"
```

**Diagram sources**
- [categories.ts](file://src/stores/categories.ts#L1-L199)

**Section sources**
- [categories.ts](file://src/stores/categories.ts#L1-L199)

### 本地化管理模块分析
`localManagement.ts` 模块提供离线功能、数据同步和用户偏好设置。

#### 类图
```mermaid
classDiagram
class useLocalManagementStore {
+isOfflineMode : boolean
+isSyncing : boolean
+syncError : string | null
+lastSyncTime : string | null
+userPreferences : UserPreferences
+localTools : LocalTool[]
+localCategories : LocalCategory[]
+offlineQueue : OfflineAction[]
+pendingSyncCount : number
+hasLocalChanges : boolean
+storageInfo : object
+isOnline : boolean
+initialize() : Promise~void~
+addLocalTool(data) : LocalTool
+updateLocalTool(id, updates) : boolean
+deleteLocalTool(id) : boolean
+updateUserPreferences(preferences) : void
+syncData() : Promise~void~
+forceSyncData() : Promise~void~
+toggleOfflineMode() : void
+clearLocalData() : void
+exportLocalData() : void
+importLocalData(file) : Promise~void~
}
class LocalTool {
+id : string
+name : string
+url : string
+category_id : string
+syncStatus : "synced" | "pending"
}
class LocalCategory {
+id : string
+name : string
+syncStatus : "synced" | "pending"
}
class UserPreferences {
+theme : string
+language : string
+autoSync : boolean
+offlineMode : boolean
}
class OfflineAction {
+entity : "tool" | "category"
+type : "create" | "update" | "delete"
+data : object
}
useLocalManagementStore --> LocalTool : "包含"
useLocalManagementStore --> LocalCategory : "包含"
useLocalManagementStore --> UserPreferences : "包含"
useLocalManagementStore --> OfflineAction : "包含"
```

**Diagram sources**
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)

**Section sources**
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)

### 产品模块分析
`products.ts` 模块管理产品数据，支持分页、筛选和详情缓存。

#### 类图
```mermaid
classDiagram
class useProductsStore {
+loading : boolean
+error : string | null
+initialized : boolean
+products : Product[]
+categories : Category[]
+searchResult : SearchResult~Product~ | null
+featuredProducts : Product[]
+currentProduct : Product | null
+searchQuery : string
+selectedCategory : string
+priceRange : [number, number] | null
+sortBy : string
+sortOrder : "asc" | "desc"
+filteredProducts : Product[]
+totalProducts : number
+productsByCategory : Map~string, Product[]~
+recentProducts : Product[]
+initialize() : Promise~void~
+loadProducts(filters?) : Promise~SearchResult~
+loadProduct(id) : Promise~Product~
+loadFeaturedProducts(limit?) : Promise~Product[]~
+loadRelatedProducts(productId, categoryId, limit?) : Promise~Product[]~
+searchProducts(query, filters?) : Promise~void~
+createProduct(data) : Promise~Product~
+updateProduct(id, data) : Promise~Product~
+deleteProduct(id) : Promise~void~
+uploadProductImage(file, productId) : Promise~string~
+setSearchQuery(query) : void
+setSelectedCategory(categoryId) : void
+setPriceRange(range) : void
+setSortBy(sort) : void
+setSortOrder(order) : void
+clearFilters() : void
+clearError() : void
}
class Product {
+id : string
+name : string
+description : string
+price : number
+category : Category
+imageUrl : string
+createdAt : string
+updatedAt : string
}
class Category {
+id : string
+name : string
}
class SearchResult~T~ {
+items : T[]
+total : number
+page : number
+limit : number
}
useProductsStore --> Product : "包含"
useProductsStore --> Category : "包含"
useProductsStore --> SearchResult : "使用"
```

**Diagram sources**
- [products.ts](file://src/stores/products.ts#L1-L363)

**Section sources**
- [products.ts](file://src/stores/products.ts#L1-L363)

### 工具模块分析
`tools.ts` 模块管理工具列表，支持搜索、分类和点击统计。

#### 类图
```mermaid
classDiagram
class useToolsStore {
+tools : Tool[]
+loading : boolean
+error : Error | null
+initialized : boolean
+searchQuery : string
+selectedCategory : string
+sidebarCollapsed : boolean
+filteredTools : Tool[]
+fetchTools() : Promise~void~
+initialize() : Promise~void~
+toggleSidebar() : void
+clearError() : void
+setSearchQuery(query) : void
+setSelectedCategory(categoryId) : void
+incrementClickCount(toolId) : Promise~void~
+toggleFavorite(toolId) : Promise~void~
}
class Tool {
+id : string
+name : string
+description : string
+url : string
+category_id : string
+is_featured : boolean
+click_count : number
+status : "active"
+categories : Category | null
+tool_tags : ToolTag[] | null
+tags : string[]
}
class Category {
+id : string
+name : string
+description : string
+icon : string
+color : string
}
class ToolTag {
+tags : Tag
}
class Tag {
+id : string
+name : string
}
useToolsStore --> Tool : "包含"
Tool --> Category : "关联"
Tool --> ToolTag : "包含"
ToolTag --> Tag : "关联"
```

**Diagram sources**
- [tools.ts](file://src/stores/tools.ts#L1-L342)

**Section sources**
- [tools.ts](file://src/stores/tools.ts#L1-L342)

## 依赖分析
各 Store 模块之间通过 `main.ts` 进行协调初始化，部分模块依赖于 `services` 层。

```mermaid
graph TD
main[main.ts] --> auth[auth.ts]
main --> categories[categories.ts]
main --> tools[tools.ts]
localManagement[localManagement.ts] --> toolsService[toolsService.ts]
localManagement --> categoriesService[categoriesService.ts]
products[products.ts] --> productsService[productsService.ts]
auth --> supabaseClient[supabaseClient.ts]
categories --> supabaseClient
tools --> supabaseClient
products --> supabaseClient
```

**Diagram sources**
- [main.ts](file://src/main.ts#L1-L59)
- [auth.ts](file://src/stores/auth.ts#L1-L152)
- [categories.ts](file://src/stores/categories.ts#L1-L199)
- [localManagement.ts](file://src/stores/localManagement.ts#L1-L350)
- [products.ts](file://src/stores/products.ts#L1-L363)
- [tools.ts](file://src/stores/tools.ts#L1-L342)
- [services](file://src/services)

**Section sources**
- [main.ts](file://src/main.ts#L1-L59)
- [services](file://src/services)

## 性能考虑
- `main.ts` 中使用 `Promise.all` 并发初始化核心 Store，提升启动性能。
- 各 Store 模块均实现 `initialized` 标志，避免重复数据加载。
- `categories.ts` 和 `tools.ts` 在环境变量未配置时提供模拟数据，保证开发体验。
- `localManagement.ts` 实现离线队列和自动同步，优化离线用户体验。

## 故障排除指南
- **Store 方法未定义**：确保在 `return` 语句中正确导出 action 方法。
- **数据未加载**：检查 `initialize` 方法是否被正确调用。
- **Supabase 连接失败**：确认 `.env` 文件中的 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 已正确配置。
- **类型错误**：确保 `@/types/database` 类型文件已由 Supabase CLI 生成并保持最新。

## 结论
该项目的状态管理设计清晰、模块化程度高。通过 Pinia 的模块化 Store，实现了复杂状态的可维护性。`main.ts` 中的集中初始化确保了应用启动的可靠性。各 Store 模块职责分明，既独立又通过服务层协同工作，构成了一个健壮的应用状态管理架构。