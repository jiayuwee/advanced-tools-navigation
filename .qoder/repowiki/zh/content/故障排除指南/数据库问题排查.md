ç°åœ¨æˆ‘å·²ç»æ”¶é›†äº†è¶³å¤Ÿçš„ä¿¡æ¯æ¥ç¼–å†™å®Œæ•´çš„æ•°æ®åº“é—®é¢˜æ’æŸ¥æ‰‹å†Œã€‚è®©æˆ‘å¼€å§‹ç”Ÿæˆæ–‡æ¡£ï¼š

<docs>
# æ•°æ®åº“é—®é¢˜æ’æŸ¥æ‰‹å†Œ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js)
- [update-database.js](file://scripts/database/update-database.js)
- [fix-database.js](file://scripts/fix-database.js)
- [fix-database-connection.js](file://scripts/fix-database-connection.js)
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql)
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql)
- [run-sql-script.js](file://scripts/database/run-sql-script.js)
- [check-wee-table.js](file://scripts/database/check-wee-table.js)
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒæ•°æ®åº“è„šæœ¬](#æ ¸å¿ƒæ•°æ®åº“è„šæœ¬)
4. [è¿æ¥é—®é¢˜æ’æŸ¥](#è¿æ¥é—®é¢˜æ’æŸ¥)
5. [RLSç­–ç•¥é—®é¢˜](#rlsç­–ç•¥é—®é¢˜)
6. [è¿ç§»é—®é¢˜æ’æŸ¥](#è¿ç§»é—®é¢˜æ’æŸ¥)
7. [è¡¨ç»“æ„é—®é¢˜](#è¡¨ç»“æ„é—®é¢˜)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
10. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ç®€ä»‹

æœ¬æ‰‹å†Œä¸“é—¨é’ˆå¯¹Supabaseæ•°æ®åº“è¿æ¥ä¸ç»“æ„é—®é¢˜æä¾›å…¨é¢çš„æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆã€‚æ¶µç›–äº†ä»åŸºç¡€è¿æ¥æµ‹è¯•åˆ°å¤æ‚è¿ç§»é—®é¢˜çš„å®Œæ•´æ’æŸ¥æµç¨‹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å’Œè§£å†³æ•°æ®åº“ç›¸å…³é—®é¢˜ã€‚

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```mermaid
graph TB
subgraph "æ•°æ®åº“è„šæœ¬ç›®å½•"
A[scripts/database/]
A1[test-supabase-connection.js]
A2[update-database.js]
A3[fix-database.js]
A4[fix-database-connection.js]
A5[safe-create-tables.sql]
A6[create-rls-policies-fixed.sql]
A7[run-sql-script.js]
A8[check-wee-table.js]
end
subgraph "è¿ç§»æ–‡ä»¶"
B[supabase/migrations/]
B1[20241224000001_initial_schema.sql]
B2[20241224000002_rls_policies.sql]
B3[20241224000003_storage_setup.sql]
B4[20241224000004_seed_data.sql]
end
subgraph "é…ç½®æ–‡ä»¶"
C[.env.local]
D[package.json]
end
A --> A1
A --> A2
A --> A3
A --> A4
A --> A5
A --> A6
A --> A7
A --> A8
B --> B1
B --> B2
B --> B3
B --> B4
```

**å›¾è¡¨æ¥æº**
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js#L1-L112)
- [update-database.js](file://scripts/database/update-database.js#L1-L305)
- [fix-database.js](file://scripts/fix-database.js#L1-L228)

## æ ¸å¿ƒæ•°æ®åº“è„šæœ¬

### è¿æ¥æµ‹è¯•è„šæœ¬

`test-supabase-connection.js` æ˜¯æ•°æ®åº“è¿æ¥æµ‹è¯•çš„æ ¸å¿ƒå·¥å…·ï¼Œæä¾›å…¨é¢çš„è¿é€šæ€§æ£€æŸ¥ï¼š

```javascript
// ä¸»è¦åŠŸèƒ½æ¨¡å—
async function testConnection() {
  console.log("ğŸ” æµ‹è¯•Supabaseæ•°æ®åº“è¿æ¥...");
  
  // æµ‹è¯•1: è·å–åˆ†ç±»æ•°æ®
  const { data: categories, error: categoriesError } = await supabase
    .from("categories")
    .select("*")
    .eq("is_active", true)
    .order("sort_order", { ascending: true });

  // æµ‹è¯•2: è·å–å·¥å…·æ•°æ®
  const { data: tools, error: toolsError } = await supabase
    .from("tools")
    .select("*, category:categories(*)")
    .eq("status", "active")
    .eq("is_active", true);

  // æµ‹è¯•3: è·å–äº§å“æ•°æ®
  const { data: products, error: productsError } = await supabase
    .from("products")
    .select("*, category:product_categories(*)")
    .eq("status", "active");
}
```

**ç« èŠ‚æ¥æº**
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js#L25-L85)

### æ•°æ®åº“æ›´æ–°è„šæœ¬

`update-database.js` æä¾›å®Œæ•´çš„æ•°æ®åº“æ›´æ–°å’Œé‡ç½®åŠŸèƒ½ï¼š

```javascript
async function updateDatabase() {
  // æ¸…ç©ºç°æœ‰æ•°æ®
  await supabase.from("tool_tags").delete().neq("tool_id", "");
  await supabase.from("tools").delete().neq("id", "");
  await supabase.from("tags").delete().neq("id", "");

  // æ’å…¥æ–°æ ‡ç­¾
  const tags = [
    { id: "750e8400-e29b-41d4-a716-446655440001", name: "ä»£ç æ‰˜ç®¡", color: "#0078d4" },
    { id: "750e8400-e29b-41d4-a716-446655440002", name: "ç‰ˆæœ¬æ§åˆ¶", color: "#0078d4" },
    // ... æ›´å¤šæ ‡ç­¾
  ];
}
```

**ç« èŠ‚æ¥æº**
- [update-database.js](file://scripts/database/update-database.js#L15-L100)

## è¿æ¥é—®é¢˜æ’æŸ¥

### å¸¸è§è¿æ¥é”™è¯¯ç±»å‹

```mermaid
flowchart TD
A[è¿æ¥æµ‹è¯•å¼€å§‹] --> B{ç¯å¢ƒå˜é‡æ£€æŸ¥}
B --> |ç¼ºå¤±| C[ç¼ºå°‘VITE_SUPABASE_URLæˆ–VITE_SUPABASE_ANON_KEY]
B --> |å®Œæ•´| D[å°è¯•å»ºç«‹è¿æ¥]
D --> E{è¿æ¥ç»“æœ}
E --> |å¤±è´¥| F[æ£€æŸ¥APIå¯†é’¥çŠ¶æ€]
E --> |æˆåŠŸ| G[æµ‹è¯•æ•°æ®æŸ¥è¯¢]
F --> H{APIå¯†é’¥ç±»å‹}
H --> |Legacy API keyså·²ç¦ç”¨| I[è§£å†³æ–¹æ¡ˆ: å¯ç”¨Legacy keysæˆ–è·å–æ–°çš„publishable key]
H --> |å…¶ä»–é—®é¢˜| J[æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®]
G --> K{æŸ¥è¯¢ç»“æœ}
K --> |å¤±è´¥| L[æ£€æŸ¥RLSç­–ç•¥]
K --> |æˆåŠŸ| M[è¿æ¥æ­£å¸¸]
C --> N[æ›´æ–°.env.localæ–‡ä»¶]
I --> O[æ›´æ–°.env.localæ–‡ä»¶]
J --> P[æ£€æŸ¥ç½‘ç»œé…ç½®]
```

**å›¾è¡¨æ¥æº**
- [fix-database-connection.js](file://scripts/fix-database-connection.js#L30-L60)
- [test-supabase-connection.js](file://scripts/database/test-supabase-connection.js#L15-L25)

### è¿æ¥ä¿®å¤æ­¥éª¤

1. **ç¯å¢ƒå˜é‡éªŒè¯**
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
echo $VITE_SUPABASE_URL
echo $VITE_SUPABASE_ANON_KEY
```

2. **APIå¯†é’¥é—®é¢˜è¯Šæ–­**
```javascript
// æ£€æŸ¥APIå¯†é’¥çŠ¶æ€
if (error.message.includes("Legacy API keys are disabled")) {
  console.log("è§£å†³æ–¹æ¡ˆï¼š");
  console.log("1. è®¿é—® Supabase æ§åˆ¶å°");
  console.log("2. è¿›å…¥é¡¹ç›®è®¾ç½® > API");
  console.log("3. é‡æ–°å¯ç”¨ legacy keys æˆ–è·å–æ–°çš„ publishable key");
}
```

3. **ç½‘ç»œè¿æ¥æµ‹è¯•**
```javascript
// æµ‹è¯•åŸºæœ¬è¿æ¥
const { error } = await supabase
  .from("categories")
  .select("count")
  .limit(1);
```

**ç« èŠ‚æ¥æº**
- [fix-database-connection.js](file://scripts/fix-database-connection.js#L30-L80)

## RLSç­–ç•¥é—®é¢˜

### RLSç­–ç•¥ä¿®å¤æµç¨‹

```mermaid
sequenceDiagram
participant Script as ä¿®å¤è„šæœ¬
participant DB as æ•°æ®åº“
participant Policy as ç­–ç•¥å¼•æ“
participant Auth as è®¤è¯æœåŠ¡
Script->>DB : æ£€æŸ¥ç°æœ‰ç­–ç•¥
DB-->>Script : è¿”å›ç­–ç•¥åˆ—è¡¨
Script->>Policy : åˆ é™¤æ—§ç­–ç•¥
Policy-->>Script : ç¡®è®¤åˆ é™¤
Script->>DB : åˆ›å»ºå®‰å…¨å‡½æ•°
DB-->>Script : å‡½æ•°åˆ›å»ºæˆåŠŸ
Script->>Policy : åº”ç”¨æ–°ç­–ç•¥
Policy-->>Script : ç­–ç•¥åº”ç”¨æˆåŠŸ
Script->>DB : å¯ç”¨RLS
DB-->>Script : RLSå¯ç”¨æˆåŠŸ
Script->>Auth : éªŒè¯ç­–ç•¥æ•ˆæœ
Auth-->>Script : éªŒè¯ç»“æœ
```

**å›¾è¡¨æ¥æº**
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql#L1-L50)
- [fix-database-connection.js](file://scripts/fix-database-connection.js#L60-L90)

### RLSç­–ç•¥ä¿®å¤è„šæœ¬

`create-rls-policies-fixed.sql` æä¾›äº†å®Œæ•´çš„RLSç­–ç•¥ä¿®å¤åŠŸèƒ½ï¼š

```sql
-- åˆ›å»ºå®‰å…¨å®šä¹‰å‡½æ•°ä»¥æé«˜æ€§èƒ½
CREATE OR REPLACE FUNCTION private.get_user_role()
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN (
        SELECT role 
        FROM user_profiles 
        WHERE id = auth.uid()
    );
END;
$$;

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
CREATE OR REPLACE FUNCTION private.is_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN (
        SELECT role IN ('admin', 'super_admin')
        FROM user_profiles 
        WHERE id = auth.uid()
    );
END;
$$;
```

**ç« èŠ‚æ¥æº**
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql#L15-L45)

### å¸¸è§RLSé—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **ç­–ç•¥æ‹’ç»è®¿é—®**
   - æ£€æŸ¥ç”¨æˆ·è§’è‰²æƒé™
   - éªŒè¯RLSç­–ç•¥è¯­æ³•
   - ç¡®è®¤å®‰å…¨å‡½æ•°æ­£ç¡®æ€§

2. **æ€§èƒ½é—®é¢˜**
   - ä½¿ç”¨å®‰å…¨å®šä¹‰å‡½æ•°é¿å…é€’å½’æ£€æŸ¥
   - åˆ›å»ºé€‚å½“çš„ç´¢å¼•
   - ä¼˜åŒ–ç­–ç•¥é€»è¾‘

3. **æšä¸¾å€¼é”™è¯¯**
   - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æšä¸¾å€¼
   - æ£€æŸ¥è¡¨ç»“æ„ä¸€è‡´æ€§
   - éªŒè¯ç­–ç•¥æ¡ä»¶åŒ¹é…

**ç« èŠ‚æ¥æº**
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql#L400-L500)

## è¿ç§»é—®é¢˜æ’æŸ¥

### è¿ç§»è„šæœ¬å¯¹æ¯”

```mermaid
graph LR
subgraph "æœ¬åœ°è¿ç§»æ–‡ä»¶"
A[20241224000001_initial_schema.sql]
B[20241224000002_rls_policies.sql]
C[20241224000003_storage_setup.sql]
D[20241224000004_seed_data.sql]
end
subgraph "æ•°æ®åº“çŠ¶æ€"
E[å½“å‰æ•°æ®åº“æ¶æ„]
F[RLSç­–ç•¥çŠ¶æ€]
G[å­˜å‚¨æ¡¶é…ç½®]
H[ç§å­æ•°æ®çŠ¶æ€]
end
subgraph "ä¿®å¤è„šæœ¬"
I[update-database.js]
J[run-sql-script.js]
K[safe-create-tables.sql]
end
A --> E
B --> F
C --> G
D --> H
I --> A
I --> B
J --> C
K --> D
```

**å›¾è¡¨æ¥æº**
- [update-database.js](file://scripts/database/update-database.js#L15-L30)
- [run-sql-script.js](file://scripts/database/run-sql-script.js#L15-L30)

### è¿ç§»åŒæ­¥æ­¥éª¤

1. **æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬**
```javascript
// ä½¿ç”¨run-sql-script.jsåŒæ­¥æœ€æ–°è¿ç§»
node scripts/database/run-sql-script.js supabase/migrations/20241224000001_initial_schema.sql
```

2. **éªŒè¯è¿ç§»å®Œæ•´æ€§**
```javascript
// æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦ä¸è¿ç§»æ–‡ä»¶ä¸€è‡´
const { data: columns, error: columnsError } = await supabase.rpc("exec_sql", {
  sql: `
    SELECT column_name, data_type, is_nullable, column_default
    FROM information_schema.columns 
    WHERE table_name = 'tools' AND table_schema = 'public'
    ORDER BY ordinal_position;
  `,
});
```

3. **å¤„ç†è¿ç§»å†²çª**
```javascript
// ä½¿ç”¨safe-create-tables.sqlå®‰å…¨åˆ›å»ºè¡¨
node scripts/database/run-sql-script.js scripts/database/safe-create-tables.sql
```

**ç« èŠ‚æ¥æº**
- [run-sql-script.js](file://scripts/database/run-sql-script.js#L25-L80)
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql#L1-L50)

## è¡¨ç»“æ„é—®é¢˜

### è¡¨ç»“æ„æ£€æŸ¥æµç¨‹

```mermaid
flowchart TD
A[å¼€å§‹è¡¨ç»“æ„æ£€æŸ¥] --> B[æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨]
B --> C{è¡¨å­˜åœ¨?}
C --> |å¦| D[åˆ›å»ºç¼ºå¤±è¡¨]
C --> |æ˜¯| E[æ£€æŸ¥è¡¨ç»“æ„]
E --> F[æ¯”è¾ƒå­—æ®µå®šä¹‰]
F --> G{å­—æ®µä¸€è‡´?}
G --> |å¦| H[ä¿®å¤å­—æ®µå·®å¼‚]
G --> |æ˜¯| I[æ£€æŸ¥ç´¢å¼•]
I --> J[éªŒè¯ç´¢å¼•å®Œæ•´æ€§]
J --> K{ç´¢å¼•å®Œæ•´?}
K --> |å¦| L[åˆ›å»ºç¼ºå¤±ç´¢å¼•]
K --> |æ˜¯| M[æ£€æŸ¥çº¦æŸ]
M --> N[éªŒè¯çº¦æŸæ¡ä»¶]
N --> O{çº¦æŸæœ‰æ•ˆ?}
O --> |å¦| P[ä¿®å¤çº¦æŸé—®é¢˜]
O --> |æ˜¯| Q[æ£€æŸ¥æ•°æ®å®Œæ•´æ€§]
D --> R[éªŒè¯åˆ›å»ºç»“æœ]
H --> S[éªŒè¯ä¿®å¤ç»“æœ]
L --> T[éªŒè¯ç´¢å¼•åˆ›å»º]
P --> U[éªŒè¯çº¦æŸä¿®å¤]
Q --> V[æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§]
R --> W[æ£€æŸ¥å®Œæˆ]
S --> W
T --> W
U --> W
V --> W
```

**å›¾è¡¨æ¥æº**
- [check-wee-table.js](file://scripts/database/check-wee-table.js#L20-L80)
- [safe-create-tables.sql](file://scripts/database/safe-create-tables.sql#L1-L30)

### è¡¨ç»“æ„ä¿®å¤è„šæœ¬

`check-wee-table.js` æä¾›äº†å®Œæ•´çš„è¡¨ç»“æ„æ£€æŸ¥å’Œä¿®å¤åŠŸèƒ½ï¼š

```javascript
async function checkWeeTable() {
  console.log("ğŸ” æ£€æŸ¥ wee è¡¨...");
  
  // å°è¯•ç›´æ¥æŸ¥è¯¢ wee è¡¨
  const { error: weeError } = await supabase.from("wee").select("*").limit(1);
  
  if (weeError) {
    if (weeError.message.includes("does not exist") || weeError.code === "42P01") {
      console.log("âœ… wee è¡¨ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤");
      return false;
    }
  }
  
  console.log("âš ï¸ å‘ç° wee è¡¨å­˜åœ¨");
  return true;
}
```

**ç« èŠ‚æ¥æº**
- [check-wee-table.js](file://scripts/database/check-wee-table.js#L20-L60)

### å¸¸è§è¡¨ç»“æ„é—®é¢˜

1. **è¡¨ä¸å­˜åœ¨**
   - ä½¿ç”¨ `safe-create-tables.sql` åˆ›å»ºç¼ºå¤±è¡¨
   - éªŒè¯è¡¨ç»“æ„å®šä¹‰
   - æ£€æŸ¥æƒé™è®¾ç½®

2. **å­—æ®µç±»å‹ä¸åŒ¹é…**
   - æ¯”è¾ƒè¿ç§»æ–‡ä»¶å’Œæ•°æ®åº“ç»“æ„
   - ä½¿ç”¨ALTER TABLEä¿®å¤å­—æ®µ
   - éªŒè¯æ•°æ®å…¼å®¹æ€§

3. **ç´¢å¼•ç¼ºå¤±**
   - åˆ†ææŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ
   - åˆ›å»ºå¿…è¦çš„ç´¢å¼•
   - ä¼˜åŒ–ç´¢å¼•ç­–ç•¥

**ç« èŠ‚æ¥æº**
- [check-wee-table.js](file://scripts/database/check-wee-table.js#L80-L150)

## æ€§èƒ½ä¼˜åŒ–

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

```mermaid
graph TB
subgraph "æ€§èƒ½ç›‘æ§ç»´åº¦"
A[æŸ¥è¯¢å“åº”æ—¶é—´]
B[å¹¶å‘è¿æ¥æ•°]
C[é”ç­‰å¾…æ—¶é—´]
D[ç£ç›˜I/O]
end
subgraph "ä¼˜åŒ–ç­–ç•¥"
E[ç´¢å¼•ä¼˜åŒ–]
F[æŸ¥è¯¢ä¼˜åŒ–]
G[è¿æ¥æ± ç®¡ç†]
H[ç¼“å­˜ç­–ç•¥]
end
subgraph "ç›‘æ§å·¥å…·"
I[Supabaseä»ªè¡¨æ¿]
J[PostgreSQLæ‰©å±•]
K[è‡ªå®šä¹‰ç›‘æ§è„šæœ¬]
end
A --> E
B --> F
C --> G
D --> H
E --> I
F --> J
G --> K
H --> I
```

### æ€§èƒ½ä¼˜åŒ–è„šæœ¬

`create-rls-policies-fixed.sql` åŒ…å«äº†æ€§èƒ½ä¼˜åŒ–çš„å…³é”®éƒ¨åˆ†ï¼š

```sql
-- åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_profiles_role ON user_profiles(role);
CREATE INDEX IF NOT EXISTS idx_orders_user_id_status ON orders(user_id, status);
CREATE INDEX IF NOT EXISTS idx_favorites_user_id ON favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_product_reviews_user_id ON product_reviews(user_id);

-- ä½¿ç”¨å®‰å…¨å®šä¹‰å‡½æ•°é¿å…RLSé€’å½’æ£€æŸ¥
CREATE OR REPLACE FUNCTION private.is_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN (
        SELECT role IN ('admin', 'super_admin')
        FROM user_profiles 
        WHERE id = auth.uid()
    );
END;
$$;
```

**ç« èŠ‚æ¥æº**
- [create-rls-policies-fixed.sql](file://scripts/database/create-rls-policies-fixed.sql#L650-L680)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é”™è¯¯ä»£ç åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ä»£ç  | é”™è¯¯æè¿° | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| 42P01 | è¡¨ä¸å­˜åœ¨ | ä½¿ç”¨safe-create-tables.sqlåˆ›å»ºè¡¨ |
| 42703 | åˆ—ä¸å­˜åœ¨ | æ£€æŸ¥è¿ç§»æ–‡ä»¶å’Œè¡¨ç»“æ„ |
| 42804 | ç±»å‹ä¸åŒ¹é… | ä¿®å¤å­—æ®µç±»å‹å®šä¹‰ |
| 23505 | è¿åå”¯ä¸€çº¦æŸ | æ¸…ç†é‡å¤æ•°æ®æˆ–ä¿®æ”¹çº¦æŸ |

### æ•…éšœæ’é™¤æ£€æŸ¥æ¸…å•

```mermaid
flowchart LR
A[å¼€å§‹æ•…éšœæ’é™¤] --> B[æ£€æŸ¥ç¯å¢ƒå˜é‡]
B --> C[éªŒè¯æ•°æ®åº“è¿æ¥]
C --> D[æ£€æŸ¥RLSç­–ç•¥]
D --> E[éªŒè¯è¡¨ç»“æ„]
E --> F[æ£€æŸ¥ç´¢å¼•çŠ¶æ€]
F --> G[åˆ†ææŸ¥è¯¢æ€§èƒ½]
G --> H[æ£€æŸ¥æ•°æ®å®Œæ•´æ€§]
H --> I[ç¡®è®¤ä¿®å¤å®Œæˆ]
subgraph "æ£€æŸ¥ç‚¹"
J[ç½‘ç»œè¿æ¥]
K[APIå¯†é’¥]
L[æƒé™è®¾ç½®]
M[æ•°æ®ç±»å‹]
N[ç´¢å¼•è¦†ç›–]
O[æŸ¥è¯¢è®¡åˆ’]
P[çº¦æŸæ¡ä»¶]
end
B -.-> J
C -.-> K
D -.-> L
E -.-> M
F -.-> N
G -.-> O
H -.-> P
```

### è‡ªåŠ¨åŒ–æ•…éšœæ’é™¤è„šæœ¬

```javascript
// ç»¼åˆæ•…éšœæ’é™¤è„šæœ¬
async function comprehensiveDiagnostics() {
  console.log("ğŸ” å¼€å§‹ç»¼åˆè¯Šæ–­...");
  
  // 1. è¿æ¥æµ‹è¯•
  await testConnection();
  
  // 2. è¡¨ç»“æ„æ£€æŸ¥
  await checkTables();
  
  // 3. RLSç­–ç•¥éªŒè¯
  await validateRLSPolicies();
  
  // 4. æ€§èƒ½æŒ‡æ ‡åˆ†æ
  await analyzePerformance();
  
  console.log("âœ… è¯Šæ–­å®Œæˆ");
}
```

**ç« èŠ‚æ¥æº**
- [fix-database-connection.js](file://scripts/fix-database-connection.js#L180-L220)

## æœ€ä½³å®è·µ

### æ•°æ®åº“ç»´æŠ¤æœ€ä½³å®è·µ

1. **å®šæœŸå¤‡ä»½**
   ```bash
   # ä½¿ç”¨Supabase CLIå¤‡ä»½
   supabase db dump --file backup.sql
   ```

2. **ç›‘æ§å‘Šè­¦**
   - è®¾ç½®è¿æ¥è¶…æ—¶å‘Šè­¦
   - ç›‘æ§RLSç­–ç•¥æ‰§è¡Œæ—¶é—´
   - è·Ÿè¸ªæŸ¥è¯¢æ€§èƒ½å˜åŒ–

3. **ç‰ˆæœ¬æ§åˆ¶**
   - ä¿æŒè¿ç§»æ–‡ä»¶ç‰ˆæœ¬åŒ–
   - è®°å½•æ¯æ¬¡å˜æ›´åŸå› 
   - ç»´æŠ¤å›æ»šç­–ç•¥

4. **å®‰å…¨é…ç½®**
   - å®šæœŸæ›´æ–°APIå¯†é’¥
   - æ£€æŸ¥RLSç­–ç•¥æœ‰æ•ˆæ€§
   - éªŒè¯æƒé™è®¾ç½®

### å¼€å‘ç¯å¢ƒé…ç½®

```javascript
// å¼€å‘ç¯å¢ƒæ•°æ®åº“é…ç½®
const devConfig = {
  url: process.env.VITE_SUPABASE_URL_DEV,
  key: process.env.VITE_SUPABASE_ANON_KEY_DEV,
  serviceRole: process.env.SUPABASE_SERVICE_ROLE_KEY_DEV
};

// ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é…ç½®
const prodConfig = {
  url: process.env.VITE_SUPABASE_URL,
  key: process