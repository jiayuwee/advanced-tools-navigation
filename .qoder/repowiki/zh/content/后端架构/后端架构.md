# 后端架构

<cite>
**本文档引用的文件**
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [database.ts](file://src/types/database.ts)
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql)
- [20241224000003_storage_setup.sql](file://supabase/migrations/20241224000003_storage_setup.sql)
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js)
- [useRealtime.ts](file://src/composables/useRealtime.ts)
- [databaseService.ts](file://src/services/databaseService.ts)
- [20241227000001_user_feedback.sql](file://supabase/migrations/20241227000001_user_feedback.sql)
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql) - *更新于最近提交*
- [20250101000003_merge_categories.sql](file://supabase/migrations/20250101000003_merge_categories.sql) - *更新于最近提交*
- [20250101000004_add_billing_address_to_orders.sql](file://supabase/migrations/20250101000004_add_billing_address_to_orders.sql) - *更新于最近提交*
- [database_migration.sql](file://database_migration.sql) - *新增于最近提交*
- [database_migration_check.sql](file://database_migration_check.sql) - *新增于最近提交*
- [database_rollback.sql](file://database_rollback.sql) - *新增于最近提交*
</cite>

## 更新摘要
**变更内容**
- 更新了数据库架构与实体关系部分，反映分类表合并和订单表结构变更
- 增加了支付系统架构和迁移管理的新章节
- 更新了行级安全策略部分，包含最新的RLS策略实现
- 修订了TypeScript类型映射部分，反映最新的类型定义
- 更新了数据访问流程图，包含支付系统组件
- 所有受影响的源文件引用均已更新，标记了变更状态

## 目录
1. [简介](#简介)
2. [Supabase客户端封装](#supabase客户端封装)
3. [数据库架构与实体关系](#数据库架构与实体关系)
4. [TypeScript类型映射](#typescript类型映射)
5. [行级安全策略](#行级安全策略)
6. [存储服务管理](#存储服务管理)
7. [实时功能实现](#实时功能实现)
8. [支付系统架构](#支付系统架构)
9. [数据库迁移管理](#数据库迁移管理)
10. [数据访问流程](#数据访问流程)

## 简介
本文档详细阐述了基于Supabase作为后端即服务（BaaS）的集成方案。文档涵盖了Supabase客户端的封装机制、数据库架构设计、TypeScript类型映射、行级安全策略（RLS）、存储服务管理、实时功能以及新引入的支付系统架构和数据库迁移管理。通过分析核心文件和数据库迁移脚本，为开发者提供了全面的后端架构理解。

## Supabase客户端封装
`src/lib/supabaseClient.ts`文件封装了Supabase客户端实例，统一了API调用入口。该文件通过环境变量配置Supabase URL和匿名密钥，创建了全局可用的`supabase`实例。同时，定义了数据库表名、存储桶名和实时频道的常量，便于在应用中统一引用。

**Section sources**
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L1-L245)

## 数据库架构与实体关系
数据库架构通过一系列迁移文件逐步构建，定义了用户、工具、产品、订单等核心实体及其关系。初始架构文件`20241224000001_initial_schema.sql`创建了所有基础表和索引。近期的迁移文件对架构进行了重要优化，包括分类表合并和支付系统增强。

```mermaid
erDiagram
user_profiles ||--o{ tools : "创建"
user_profiles ||--o{ products : "创建"
user_profiles ||--o{ orders : "拥有"
user_profiles ||--o{ favorites : "收藏"
user_profiles ||--o{ product_reviews : "撰写"
user_profiles ||--o{ user_feedback : "提交"
unified_categories ||--o{ tools : "分类"
unified_categories ||--o{ products : "分类"
tools ||--o{ tool_tags : "包含"
tags ||--o{ tool_tags : "标签"
tools ||--o{ favorites : "收藏"
products ||--o{ favorites : "收藏"
orders ||--o{ order_items : "包含"
products ||--o{ order_items : "关联"
orders ||--o{ payments : "支付"
products ||--o{ product_reviews : "关联"
products ||--o{ products : "父子产品"
unified_categories ||--o{ unified_categories : "父子分类"
user_profiles }|--|| user_feedback : "提交"
user_profiles }|--|| user_feedback : "回复"
user_profiles }|--|| analytics : "生成"
user_profiles {
string id PK
string email UK
string username UK
string full_name
string avatar_url
string bio
string website
string location
user_role role
boolean is_active
boolean email_verified
timestamp created_at
timestamp updated_at
timestamp last_login_at
}
tools {
string id PK
string name
string description
string url
string icon
string category_id FK
int click_count
boolean is_featured
tool_status status
timestamp created_at
timestamp updated_at
string created_by FK
string meta_title
string meta_description
int sort_order
}
products {
string id PK
string name
string description
string short_description
decimal price
decimal original_price
string currency
string category_id FK
string[] images
string[] features
string demo_url
string download_url
boolean is_featured
boolean is_digital
int stock_quantity
product_status status
timestamp created_at
timestamp updated_at
string created_by FK
string meta_title
string meta_description
int sort_order
decimal average_rating
int total_reviews
}
orders {
string id PK
string user_id FK
decimal total_amount
string currency
order_status status
string payment_method
string payment_id
json billing_address
timestamp created_at
timestamp updated_at
timestamp completed_at
}
order_items {
string id PK
string order_id FK
string product_id FK
int quantity
decimal unit_price
decimal total_price
timestamp created_at
}
payments {
string id PK
string order_id FK
decimal amount
decimal refund_amount
string currency
string payment_method
string transaction_id UK
string external_reference
string payment_provider
string provider_payment_id
payment_status status
json payment_data
string failure_reason
timestamp expires_at
timestamp created_at
timestamp updated_at
timestamp completed_at
timestamp refunded_at
}
product_reviews {
string id PK
string user_id FK
string product_id FK
int rating
string title
string content
boolean is_verified
timestamp created_at
timestamp updated_at
}
user_feedback {
string id PK
string type
string title
string content
string priority
string status
string user_id FK
json system_info
string response
timestamp response_at
string response_by FK
string updated_by FK
boolean is_read
timestamp created_at
timestamp updated_at
}
unified_categories {
string id PK
string name
string description
string icon
string color
string parent_id FK
int sort_order
boolean is_active
timestamp created_at
timestamp updated_at
string category_type
}
tags {
string id PK
string name UK
string color
timestamp created_at
}
tool_tags {
string id PK
string tool_id FK
string tag_id FK
timestamp created_at
}
favorites {
string id PK
string user_id FK
string tool_id FK
string product_id FK
timestamp created_at
}
analytics {
string id PK
string event_type
json event_data
string user_id FK
string session_id
inet ip_address
string user_agent
timestamp created_at
}
```

**Diagram sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L1-L285)
- [20250101000003_merge_categories.sql](file://supabase/migrations/20250101000003_merge_categories.sql#L1-L135) - *分类表合并*
- [20250101000004_add_billing_address_to_orders.sql](file://supabase/migrations/20250101000004_add_billing_address_to_orders.sql#L1-L43) - *订单表扩展*

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L1-L285)
- [20250101000003_merge_categories.sql](file://supabase/migrations/20250101000003_merge_categories.sql#L1-L135) - *更新于最近提交*
- [20250101000004_add_billing_address_to_orders.sql](file://supabase/migrations/20250101000004_add_billing_address_to_orders.sql#L1-L43) - *更新于最近提交*
- [20241227000001_user_feedback.sql](file://supabase/migrations/20241227000001_user_feedback.sql#L1-L283)

## TypeScript类型映射
`src/types/database.ts`文件定义了与数据库表结构对应的TypeScript类型，实现了类型安全的数据库操作。该文件为每个表定义了`Row`、`Insert`和`Update`三种类型，分别对应查询结果、插入数据和更新数据的结构。近期的数据库架构变更已反映在类型定义中，包括统一分类表和增强的订单结构。

**Section sources**
- [database.ts](file://src/types/database.ts#L1-L439) - *更新以反映最新架构*

## 行级安全策略
行级安全策略（RLS）在`20250101000002_fix_schema_issues.sql`文件中进行了全面优化，实现了细粒度的数据访问控制。策略根据用户角色和数据所有权来限制对表的访问权限，并为所有表启用了RLS。新的策略集包括增强的注释和更精确的访问控制规则。

```mermaid
graph TD
A[数据访问请求] --> B{用户身份验证}
B --> |未认证| C[拒绝访问]
B --> |已认证| D{检查RLS策略}
D --> E[用户资料表]
E --> F{操作类型}
F --> |SELECT| G{用户ID匹配?}
G --> |是| H[允许查看]
G --> |否| I[拒绝查看]
F --> |UPDATE| J{用户ID匹配?}
J --> |是| K[允许更新]
J --> |否| L[拒绝更新]
D --> M[统一分类表]
M --> N{操作类型}
N --> |SELECT| O[允许查看]
N --> |INSERT/UPDATE/DELETE| P{用户是管理员?}
P --> |是| Q[允许操作]
P --> |否| R[拒绝操作]
D --> S[工具表]
S --> T{操作类型}
T --> |SELECT| U{状态为active或用户是创建者?}
U --> |是| V[允许查看]
U --> |否| W[拒绝查看]
T --> |INSERT/UPDATE/DELETE| X{用户是创建者或管理员?}
X --> |是| Y[允许操作]
X --> |否| Z[拒绝操作]
D --> AA[订单表]
AA --> AB{操作类型}
AB --> |SELECT| AC{用户是所有者或管理员?}
AC --> |是| AD[允许查看]
AC --> |否| AE[拒绝查看]
AB --> |INSERT| AF{用户ID匹配?}
AF --> |是| AG[允许创建]
AF --> |否| AH[拒绝创建]
AB --> |UPDATE| AI{用户是所有者且订单待支付?}
AI --> |是| AJ[允许更新]
AI --> |否| AK{用户是管理员?}
AK --> |是| AL[允许更新]
AK --> |否| AM[拒绝更新]
D --> AN[支付表]
AN --> AO{操作类型}
AO --> |SELECT| AP{用户是订单所有者或管理员?}
AP --> |是| AQ[允许查看]
AP --> |否| AR[拒绝查看]
AO --> |INSERT| AS{用户是订单所有者?}
AS --> |是| AT[允许创建]
AS --> |否| AU[拒绝创建]
```

**Diagram sources**
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L1-L217) - *更新的RLS策略*

**Section sources**
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L1-L217) - *更新于最近提交*

## 存储服务管理
存储服务通过`20241224000003_storage_setup.sql`和`scripts/database/setup-storage-buckets.js`文件进行配置和管理。系统创建了四个存储桶：avatars（头像）、product-images（产品图片）、tool-icons（工具图标）和uploads（用户上传文件），并为每个存储桶设置了相应的访问策略。

```mermaid
graph TD
A[存储桶创建] --> B[avatars]
A --> C[product-images]
A --> D[tool-icons]
A --> E[uploads]
B --> F[访问策略]
C --> G[访问策略]
D --> H[访问策略]
E --> I[访问策略]
F --> J[所有人可查看]
F --> K[用户可上传/更新/删除自己的头像]
G --> L[所有人可查看]
G --> M[管理员可管理]
H --> N[所有人可查看]
H --> O[管理员可管理]
I --> P[用户可查看/上传/删除自己的文件]
I --> Q[管理员可查看所有文件]
```

**Diagram sources**
- [20241224000003_storage_setup.sql](file://supabase/migrations/20241224000003_storage_setup.sql#L1-L128)
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js#L1-L292)

**Section sources**
- [20241224000003_storage_setup.sql](file://supabase/migrations/20241224000003_storage_setup.sql#L1-L128)
- [setup-storage-buckets.js](file://scripts/database/setup-storage-buckets.js#L1-L292)

## 实时功能实现
实时功能通过PostgreSQL的复制机制实现，允许客户端订阅数据库变更并接收实时通知。`src/composables/useRealtime.ts`文件提供了Vue组合式API，简化了实时功能的使用。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "databaseService"
participant Supabase as "Supabase"
participant DB as "PostgreSQL数据库"
Client->>Service : 调用useRealtime()
Service->>Supabase : 创建实时频道
Supabase->>DB : 监听postgres_changes
DB-->>Supabase : 数据变更事件
Supabase-->>Service : 推送变更通知
Service-->>Client : 触发回调函数
Client->>Client : 更新UI
```

**Diagram sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)

**Section sources**
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)

## 支付系统架构
支付系统通过`database_migration.sql`脚本进行了全面升级，引入了专门的支付表和增强的订单结构。系统现在支持多种支付方式（Stripe、支付宝、微信支付、银行转账），并具有完整的支付状态管理和退款机制。

```mermaid
erDiagram
orders ||--o{ payments : "关联"
orders {
string id PK
string user_id FK
decimal total_amount
string currency
order_status status
string payment_method
string payment_id
json billing_address
timestamp created_at
timestamp updated_at
timestamp completed_at
}
payments {
string id PK
string order_id FK
decimal amount
decimal refund_amount
string currency
string payment_method
string transaction_id UK
string external_reference
string payment_provider
string provider_payment_id
payment_status status
json payment_data
string failure_reason
timestamp expires_at
timestamp created_at
timestamp updated_at
timestamp completed_at
timestamp refunded_at
}
```

**Diagram sources**
- [database_migration.sql](file://database_migration.sql#L1-L187) - *支付系统架构*
- [database.ts](file://src/types/database.ts#L1-L439) - *支付类型定义*

**Section sources**
- [database_migration.sql](file://database_migration.sql#L1-L187) - *新增于最近提交*
- [database_migration_check.sql](file://database_migration_check.sql#L1-L188) - *新增于最近提交*
- [database_rollback.sql](file://database_rollback.sql#L1-L148) - *新增于最近提交*
- [src/types/database.ts](file://src/types/database.ts#L1-L439) - *更新以反映支付系统*

## 数据库迁移管理
数据库迁移通过一系列脚本进行管理，确保架构变更的可追溯性和可逆性。系统提供了完整的迁移、验证和回滚脚本，支持安全的数据库结构演进。

```mermaid
graph TD
A[迁移流程] --> B[database_migration.sql]
A --> C[database_migration_check.sql]
A --> D[database_rollback.sql]
B --> E[应用变更]
C --> F[验证状态]
D --> G[回滚变更]
E --> H[生产环境]
F --> H
G --> H
H --> I[监控]
I --> J[告警]
```

**Diagram sources**
- [database_migration.sql](file://database_migration.sql#L1-L187) - *迁移脚本*
- [database_migration_check.sql](file://database_migration_check.sql#L1-L188) - *验证脚本*
- [database_rollback.sql](file://database_rollback.sql#L1-L148) - *回滚脚本*

**Section sources**
- [database_migration.sql](file://database_migration.sql#L1-L187) - *新增于最近提交*
- [database_migration_check.sql](file://database_migration_check.sql#L1-L188) - *新增于最近提交*
- [database_rollback.sql](file://database_rollback.sql#L1-L148) - *新增于最近提交*

## 数据访问流程
数据访问流程整合了客户端封装、类型映射、安全策略和实时功能，形成了完整的数据生命周期管理。更新后的流程包含了支付系统组件，反映了最新的架构设计。

```mermaid
flowchart TD
A[前端组件] --> B[调用services]
B --> C[databaseService]
C --> D[类型检查]
D --> E[supabaseClient]
E --> F[环境变量验证]
F --> G[Supabase API]
G --> H[PostgreSQL数据库]
H --> I[RLS策略检查]
I --> J[数据操作]
J --> K[触发器执行]
K --> L[实时通知]
L --> M[客户端更新]
M --> A
J --> N[返回结果]
N --> E
E --> C
C --> B
B --> A
J --> O[支付系统]
O --> P[第三方支付网关]
P --> Q[支付回调]
Q --> R[更新支付状态]
R --> J
```

**Diagram sources**
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L1-L245)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L1-L217) - *更新的RLS策略*
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [database_migration.sql](file://database_migration.sql#L1-L187) - *支付系统集成*

**Section sources**
- [supabaseClient.ts](file://src/lib/supabaseClient.ts#L1-L245)
- [databaseService.ts](file://src/services/databaseService.ts#L1-L404)
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L1-L217) - *更新于最近提交*
- [useRealtime.ts](file://src/composables/useRealtime.ts#L1-L402)
- [database_migration.sql](file://database_migration.sql#L1-L187) - *新增于最近提交*