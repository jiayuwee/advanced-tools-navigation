# 用户表结构设计

<cite>
**本文档中引用的文件**
- [database.ts](file://src/types/database.ts)
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql)
- [userService.ts](file://src/services/userService.ts)
</cite>

## 目录
1. [用户资料表字段定义](#用户资料表字段定义)
2. [Supabase Auth 集成机制](#supabase-auth-集成机制)
3. [行级安全（RLS）策略](#行级安全rls策略)
4. [前端类型安全实现](#前端类型安全实现)
5. [时间戳字段与触发器](#时间戳字段与触发器)
6. [典型查询示例](#典型查询示例)

## 用户资料表字段定义

用户资料表（user_profiles）定义了系统中用户的核心信息，其字段结构如下：

- **id**: UUID 类型，主键，引用 Supabase Auth 系统的 `auth.users(id)`，删除时级联删除
- **email**: TEXT 类型，唯一且非空，存储用户注册邮箱
- **username**: TEXT 类型，唯一，用户自定义的用户名
- **avatar_url**: TEXT 类型，可为空，存储用户头像的存储路径或URL
- **created_at**: TIMESTAMP WITH TIME ZONE 类型，默认值为 `NOW()`，记录用户创建时间
- **full_name**: TEXT 类型，可为空，用户全名
- **bio**: TEXT 类型，可为空，用户简介
- **website**: TEXT 类型，可为空，用户个人网站
- **location**: TEXT 类型，可为空，用户所在地
- **role**: user_role 枚举类型，默认值为 'user'，可选值为 'user', 'admin', 'super_admin'
- **is_active**: BOOLEAN 类型，默认值为 true，表示用户状态是否激活
- **email_verified**: BOOLEAN 类型，默认值为 false，表示邮箱是否验证
- **updated_at**: TIMESTAMP WITH TIME ZONE 类型，默认值为 `NOW()`，记录最后更新时间
- **last_login_at**: TIMESTAMP WITH TIME ZONE 类型，可为空，记录最后登录时间

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L32-L71)
- [database.ts](file://src/types/database.ts#L168-L220)

## Supabase Auth 集成机制

用户系统与 Supabase Auth 深度集成，通过外键约束 `id UUID REFERENCES auth.users(id)` 确保用户资料表与认证系统同步。当用户通过 Supabase Auth 注册或登录时，系统会自动在 `user_profiles` 表中创建或更新对应的用户资料。

前端通过 `UserService.getCurrentUser()` 方法获取当前用户信息。该方法首先调用 `supabase.auth.getUser()` 获取认证用户，然后查询 `user_profiles` 表获取完整资料。如果用户资料不存在（错误码 PGRST116），系统会自动创建一个新的用户资料记录。

这种设计实现了认证与用户资料的分离，既利用了 Supabase Auth 的强大认证功能，又允许系统扩展自定义的用户属性。

**Section sources**
- [userService.ts](file://src/services/userService.ts#L0-L46)
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L32-L33)

## 行级安全（RLS）策略

系统通过行级安全（Row Level Security）策略严格控制用户对数据的访问权限。`user_profiles` 表的 RLS 策略如下：

- **读取策略**：用户可以查看所有公开资料（`FOR SELECT USING (true)`），同时也有策略限制用户只能查看自己的资料
- **更新策略**：用户只能更新自己的资料（`FOR UPDATE USING (auth.uid() = id)`）
- **插入策略**：用户只能插入自己的资料（`FOR INSERT WITH CHECK (auth.uid() = id)`）
- **管理员策略**：管理员角色（admin, super_admin）可以管理所有用户资料

这些策略通过 `ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY` 启用，并通过 `CREATE POLICY` 语句定义。RLS 策略确保了数据的安全性，防止用户越权访问或修改他人数据。

**Section sources**
- [20241224000002_rls_policies.sql](file://supabase/migrations/20241224000002_rls_policies.sql#L0-L35)
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L31-L65)

## 前端类型安全实现

前端通过 TypeScript 类型定义实现了类型安全。`src/types/database.ts` 文件中的 `Database` 接口为 `user_profiles` 表定义了精确的类型结构：

```typescript
interface Database {
  public: {
    Tables: {
      user_profiles: {
        Row: {
          id: string;
          email: string;
          username: string | null;
          avatar_url: string | null;
          created_at: string;
          // ... 其他字段
        };
        Insert: {
          id: string;
          email: string;
          username?: string | null;
          // ... 其他可选字段
        };
        Update: {
          id?: string;
          email?: string;
          username?: string | null;
          // ... 其他可选字段
        };
      };
    };
  };
}
```

这种类型定义分为 `Row`、`Insert` 和 `Update` 三种模式，分别对应查询结果、插入操作和更新操作的字段类型。`Insert` 模式中除必填字段外均为可选，`Update` 模式中所有字段均为可选，这与数据库的实际约束完美匹配，提供了编译时的类型检查，避免了运行时错误。

**Section sources**
- [database.ts](file://src/types/database.ts#L216-L258)

## 时间戳字段与触发器

`created_at` 字段的默认值设置为 `NOW()`，确保在插入新记录时自动记录创建时间。`updated_at` 字段同样默认为 `NOW()`，并在每次更新时通过数据库触发器自动更新。

系统定义了 `update_updated_at_column()` 函数作为触发器函数：

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

该函数被绑定到 `user_profiles` 表的 `update_user_profiles_updated_at` 触发器上，配置为在每次 `UPDATE` 操作前执行。这种机制确保了 `updated_at` 字段的准确性，无需在应用层代码中手动维护，减少了出错的可能性。

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L262-L284)
- [supabase_deploy_fixed.sql](file://scripts/database/supabase_deploy_fixed.sql#L227-L252)

## 典型查询示例

以下是用户数据查询的典型 SQL 示例：

```sql
-- 查询当前用户完整资料
SELECT * FROM user_profiles WHERE id = auth.uid();

-- 查询特定用户名的用户（用于用户名唯一性检查）
SELECT id, username, avatar_url FROM user_profiles WHERE username = 'desired_username';

-- 更新用户资料（由前端服务调用）
UPDATE user_profiles 
SET full_name = 'New Name', 
    bio = 'Updated bio', 
    updated_at = NOW() 
WHERE id = 'user-id-here';

-- 查询管理员用户列表
SELECT id, email, username, role, created_at 
FROM user_profiles 
WHERE role IN ('admin', 'super_admin') 
ORDER BY created_at DESC;

-- 查询最近注册的用户
SELECT id, email, username, created_at 
FROM user_profiles 
ORDER BY created_at DESC 
LIMIT 10;
```

这些查询示例展示了系统中常见的用户数据操作模式，结合了 RLS 策略和类型安全的最佳实践。

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql)
- [userService.ts](file://src/services/userService.ts)