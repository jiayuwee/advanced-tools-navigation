# 数据库约束与索引策略

<cite>
**本文档引用的文件**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql) - *初始数据库架构*
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql) - *修复架构问题并优化索引*
- [database_migration.sql](file://database_migration.sql) - *支付系统表结构迁移*
</cite>

## 更新摘要
**变更内容**
- 新增了支付系统相关表（payments）的约束与索引说明
- 更新了主键与外键约束分析，包含新表的关联关系
- 扩展了核心索引策略，涵盖支付系统的新索引
- 增加了支付系统索引优化的迭代过程说明
- 更新了慢查询诊断建议，包含支付相关查询的优化建议

## 目录
1. [主键与外键约束分析](#主键与外键约束分析)
2. [唯一性与非空约束说明](#唯一性与非空约束说明)
3. [核心索引策略与性能优化](#核心索引策略与性能优化)
4. [索引优化迭代过程](#索引优化迭代过程)
5. [慢查询诊断与索引建议](#慢查询诊断与索引建议)

## 主键与外键约束分析

数据库中的主键和外键约束确保了数据的完整性和一致性。主键约束在各表中通过 `PRIMARY KEY` 定义，确保每条记录的唯一性。外键约束则通过 `REFERENCES` 关键字建立表间关联，维护引用完整性。

在 `user_profiles` 表中，`id` 字段作为主键，引用 `auth.users` 表的 `id`，并设置 `ON DELETE CASCADE` 级联删除策略。`tools` 表的 `category_id` 外键引用 `categories` 表的 `id`，并设置 `ON DELETE SET NULL` 策略，确保分类删除时工具记录仍可保留。类似地，`products` 表通过 `category_id` 与 `product_categories` 表建立关联，`favorites` 表通过 `tool_id` 和 `product_id` 分别与 `tools` 和 `products` 表建立外键关系。

新增的 `payments` 表通过 `order_id` 外键引用 `orders` 表的 `id`，并设置 `ON DELETE CASCADE` 策略，确保订单删除时相关支付记录也被清除。`order_items` 表的 `product_id` 外键引用 `products` 表的 `id`，并设置 `ON DELETE SET NULL` 策略，保证产品删除后订单项仍可保留。

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L1-L285)
- [database_migration.sql](file://database_migration.sql#L69-L91) - *新增支付表结构*

## 唯一性与非空约束说明

数据库通过唯一性约束（UNIQUE）和非空约束（NOT NULL）确保关键字段的数据质量。`tools.url` 字段的唯一性约束防止重复的工具链接被插入，确保每个工具都有唯一的访问地址。该约束在 `tools` 表定义中通过 `url TEXT NOT NULL` 实现，结合业务逻辑层的验证，形成双重保障。

`user_profiles.email` 字段具有非空约束和唯一性约束，确保每个用户必须提供有效的电子邮件地址，且系统中不存在重复邮箱。此约束在 `user_profiles` 表中定义为 `email TEXT UNIQUE NOT NULL`，是用户身份识别和认证的基础。此外，`tags.name` 字段也设置了唯一性约束，避免标签名称重复，保证标签系统的清晰性。

在支付系统中，`payments.transaction_id` 字段设置了唯一性约束，确保第三方支付平台的交易ID在系统中唯一。`payments` 表中的 `amount` 和 `currency` 字段具有非空约束，保证支付记录的完整性。`orders` 表新增的 `billing_address` 字段为 JSONB 类型，用于存储账单地址信息，而 `payment_id` 字段用于关联支付记录。

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L1-L285)
- [database_migration.sql](file://database_migration.sql#L75-L82) - *支付表约束定义*

## 核心索引策略与性能优化

数据库的核心索引策略旨在提升查询性能，特别是在搜索和排序操作中。`tools` 表上创建了多个单列索引，包括 `idx_tools_category_id`（按分类ID）、`idx_tools_status`（按状态）和 `idx_tools_click_count`（按点击量），这些索引显著加速了基于这些字段的过滤查询。

复合索引进一步优化了多条件查询的性能。`idx_tools_category_status` 复合索引在 `tools` 表的 `category_id` 和 `status` 字段上创建，使得“按分类查看活跃工具”这类常见查询能够高效执行。同样，`products` 表上的 `idx_products_price_status` 复合索引优化了按价格和状态筛选产品的查询。GIN 索引 `idx_products_images_gin` 和 `idx_products_features_gin` 针对数组字段进行优化，支持高效的数组包含查询。

支付系统引入了新的索引策略：`idx_payments_order_id` 索引优化了通过订单ID查询支付记录的性能；`idx_payments_status` 索引加速了按支付状态（如“待支付”、“已完成”）的筛选；`idx_payments_transaction_id` 索引确保了第三方交易ID的快速查找；`idx_payments_data_gin` GIN 索引支持对 `payment_data` JSONB 字段的高效查询。

**Section sources**
- [20241224000001_initial_schema.sql](file://supabase/migrations/20241224000001_initial_schema.sql#L230-L234)
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L170-L175)
- [database_migration.sql](file://database_migration.sql#L95-L110) - *支付表索引创建*

## 索引优化迭代过程

索引优化是一个持续迭代的过程，`fix_schema_issues.sql` 迁移文件记录了这一演进。初始架构中，仅创建了基础的单列索引。在后续优化中，通过 `20250101000002_fix_schema_issues.sql` 文件引入了更高级的索引策略。

该文件使用 `CREATE INDEX IF NOT EXISTS` 语句安全地添加了复合索引和 GIN 索引，避免重复创建。`idx_tools_category_status` 复合索引的添加，解决了按分类和状态联合查询的性能瓶颈。同时，为 `analytics.event_data` 字段添加的 GIN 索引 `idx_analytics_event_data_gin`，极大提升了对 JSONB 数据的查询效率。这些优化通过 `COMMENT ON INDEX` 添加了详细注释，便于后续维护。

支付系统的迁移文件 `database_migration.sql` 进一步扩展了索引策略，为 `payments` 表创建了多个专用索引。`idx_payments_expires_at` 索引优化了过期支付的清理任务，`idx_payments_external_ref` 索引支持通过外部参考号快速定位支付记录。这些索引的设计考虑了实际业务场景中的查询模式，如按支付状态批量处理、按交易ID对账等。

**Section sources**
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L160-L180)
- [database_migration.sql](file://database_migration.sql#L95-L110) - *支付系统索引优化*

## 慢查询诊断与索引建议

针对慢查询问题，建议首先通过 `EXPLAIN ANALYZE` 命令分析查询执行计划，识别全表扫描等性能瓶颈。对于频繁按 `created_at` 排序的查询，建议确保 `idx_tools_created_at` 和 `idx_products_created_at` 索引存在并有效。

对于复杂的多条件过滤查询，如“在特定分类中查找价格区间内的活跃产品”，应创建相应的复合索引 `idx_products_category_price_status`。对于涉及数组字段的查询，如搜索包含特定功能的产品，必须确保 GIN 索引已创建。定期审查 `pg_stat_user_indexes` 视图，识别未被使用的索引并进行清理，以减少写入开销。

针对支付系统，建议为高频查询创建专用索引：
- 对于“查询用户所有待支付订单”的场景，确保 `idx_orders_user_status` 和 `idx_payments_status` 索引存在
- 对于“通过交易ID查找支付记录”的场景，`idx_payments_transaction_id` 索引至关重要
- 对于“分析支付失败原因”的场景，考虑为 `failure_reason` 字段创建索引
- 对于“处理过期支付”的定时任务，`idx_payments_expires_at` 索引能显著提升性能

**Section sources**
- [20250101000002_fix_schema_issues.sql](file://supabase/migrations/20250101000002_fix_schema_issues.sql#L160-L217)
- [database_migration.sql](file://database_migration.sql#L95-L110) - *支付系统索引建议*