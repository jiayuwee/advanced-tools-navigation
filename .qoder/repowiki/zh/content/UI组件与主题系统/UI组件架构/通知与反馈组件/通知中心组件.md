# 通知中心组件

<cite>
**本文档引用的文件**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue)
- [notificationService.ts](file://src/services/notificationService.ts)
- [supabaseClient.ts](file://src/lib/supabaseClient.ts)
- [NotificationItem.vue](file://src/components/notifications/NotificationItem.vue)
- [NotificationSettings.vue](file://src/components/notifications/NotificationSettings.vue)
- [auth.ts](file://src/stores/auth.ts)
</cite>

## 目录
1. [架构设计与实时通信机制](#架构设计与实时通信机制)
2. [未读通知计数与性能优化](#未读通知计数与性能优化)
3. [通知列表渲染机制](#通知列表渲染机制)
4. [Pinia状态同步机制](#pinia状态同步机制)
5. [用户交互流程](#用户交互流程)
6. [生命周期管理](#生命周期管理)

## 架构设计与实时通信机制

`NotificationCenter.vue` 组件通过 `notificationService` 集成 Supabase Realtime API，实现了高效的实时通信机制。该组件采用事件驱动架构，利用 Supabase 的实时数据库功能建立 WebSocket 长连接。

在初始化时，组件通过 `setupRealtimeSubscription` 方法创建实时订阅，使用 `supabase.channel()` 方法建立以用户ID为标识的专用通信频道 `notifications:${userId}`。该订阅监听数据库 `notifications` 表的 `INSERT` 事件，当有新通知插入时，会立即触发回调函数。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Supabase as "Supabase"
participant Database as "数据库"
Client->>Supabase : 建立WebSocket连接
Supabase->>Database : 订阅INSERT事件
Database->>Supabase : 新通知插入
Supabase->>Client : 推送新通知
Client->>Client : 更新UI并显示浏览器通知
```

**Diagram sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L348-L405)
- [notificationService.ts](file://src/services/notificationService.ts#L401-L455)

**Section sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L301-L472)
- [notificationService.ts](file://src/services/notificationService.ts#L401-L455)

## 未读通知计数与性能优化

未读通知计数的实时更新逻辑通过本地状态管理和服务端统计相结合的方式实现。当用户接收到新通知时，组件不仅会将通知添加到列表中，还会立即更新本地的统计状态，包括总通知数、未读通知数、重要通知数以及按类型分类的统计。

性能优化方案包括批量更新和节流处理机制。在标记全部已读操作中，采用了批量更新策略，通过 `markAllAsRead` 方法一次性更新数据库中的多个记录，减少网络请求次数。同时，组件在处理大量通知时采用了分页加载机制，每次只加载20条通知，避免一次性加载过多数据导致性能下降。

```mermaid
flowchart TD
A[新通知到达] --> B[更新本地状态]
B --> C[增加未读计数]
C --> D[更新类型统计]
D --> E[显示浏览器通知]
E --> F[用户交互]
F --> G{是否标记已读?}
G --> |是| H[批量更新数据库]
G --> |否| I[保持未读状态]
H --> J[同步更新本地状态]
```

**Diagram sources**
- [notificationService.ts](file://src/services/notificationService.ts#L254-L311)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L348-L405)

**Section sources**
- [notificationService.ts](file://src/services/notificationService.ts#L155-L208)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L348-L405)

## 通知列表渲染机制

通知列表采用虚拟化渲染策略，通过分页加载和懒加载机制支持大规模通知的高效渲染。组件实现了无限滚动功能，当用户滚动到列表底部时，会自动加载更多通知。

列表渲染采用了响应式设计，支持多种筛选条件，包括全部、未读、重要以及按类型（系统、产品、订单）分类。每个通知项通过 `NotificationItem.vue` 组件独立渲染，确保了渲染性能和可维护性。

```mermaid
classDiagram
class NotificationCenter {
+showPanel : boolean
+notifications : Notification[]
+stats : NotificationStats
+activeFilter : string
+loadNotifications()
+loadMore()
+markAllAsRead()
}
class NotificationItem {
+notification : Notification
+markAsRead()
+deleteNotification()
+handleAction()
}
class NotificationService {
+getUserNotifications()
+getNotificationStats()
+markAllAsRead()
+subscribeToNotifications()
}
NotificationCenter --> NotificationItem : "包含多个"
NotificationCenter --> NotificationService : "依赖"
```

**Diagram sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L1-L715)
- [NotificationItem.vue](file://src/components/notifications/NotificationItem.vue#L1-L363)

**Section sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L1-L715)
- [NotificationItem.vue](file://src/components/notifications/NotificationItem.vue#L1-L363)

## Pinia状态同步机制

组件与 Pinia store 的数据同步机制确保了跨组件状态的一致性。通过 `useAuthStore()` 获取用户认证状态，组件能够根据用户登录状态动态调整行为。

当用户登录时，组件自动初始化实时订阅并加载通知数据；当用户登出时，组件会正确销毁连接并清空本地状态。这种双向同步机制保证了用户状态变化时通知中心能够及时响应。

```mermaid
sequenceDiagram
participant AuthStore as "AuthStore"
participant NotificationCenter as "通知中心"
participant NotificationService as "通知服务"
AuthStore->>NotificationCenter : 用户状态变化
NotificationCenter->>NotificationService : 初始化订阅
NotificationService->>Supabase : 建立实时连接
Supabase->>NotificationService : 推送新通知
NotificationService->>NotificationCenter : 更新通知列表
NotificationCenter->>AuthStore : 状态更新确认
```

**Diagram sources**
- [auth.ts](file://src/stores/auth.ts#L1-L151)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L400-L472)

**Section sources**
- [auth.ts](file://src/stores/auth.ts#L1-L151)
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L400-L472)

## 用户交互流程

用户交互流程涵盖了通知点击跳转、标记已读、批量清除等操作的完整事件处理链路。每个操作都经过精心设计，确保用户体验流畅。

- **通知点击**：点击通知会触发 `handleNotificationAction` 方法，如果通知包含操作URL，则在新窗口打开；同时自动将通知标记为已读。
- **标记已读**：通过 `handleNotificationRead` 方法更新单个通知的阅读状态，并同步更新本地统计。
- **批量清除**：通过 `markAllAsRead` 方法实现批量标记已读功能，支持按类型筛选后批量操作。

```mermaid
flowchart TD
A[用户点击通知] --> B{是否有操作URL?}
B --> |是| C[打开新窗口]
B --> |否| D[无操作]
C --> E[标记为已读]
D --> E
E --> F[更新UI]
G[用户点击标记全部已读] --> H[调用markAllAsRead]
H --> I[批量更新数据库]
I --> J[更新本地状态]
J --> K[刷新UI]
L[用户删除通知] --> M[调用deleteNotification]
M --> N[从数据库删除]
N --> O[更新本地列表]
O --> P[刷新UI]
```

**Diagram sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L301-L352)
- [NotificationItem.vue](file://src/components/notifications/NotificationItem.vue#L1-L363)

**Section sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L301-L352)
- [NotificationItem.vue](file://src/components/notifications/NotificationItem.vue#L1-L363)

## 生命周期管理

组件的生命周期管理确保了在用户登录后自动初始化监听，在登出时正确销毁连接。`onMounted` 钩子中调用 `setupRealtimeSubscription` 方法建立实时连接，并在 `onUnmounted` 钩子中通过 `unsubscribe` 函数清理资源。

通过 `watch` 监听用户状态变化，组件能够响应用户登录和登出事件，实现连接的自动建立和销毁。这种精细化的生命周期管理避免了内存泄漏和不必要的网络连接。

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 登录状态 : 用户登录
登录状态 --> 建立连接 : setupRealtimeSubscription
建立连接 --> 监听中 : 订阅成功
监听中 --> 接收通知 : 实时推送
接收通知 --> 更新UI : 渲染通知
登录状态 --> 登出状态 : 用户登出
登出状态 --> 清理资源 : unsubscribe
清理资源 --> 初始化
```

**Diagram sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L400-L472)
- [notificationService.ts](file://src/services/notificationService.ts#L401-L455)

**Section sources**
- [NotificationCenter.vue](file://src/components/notifications/NotificationCenter.vue#L400-L472)
- [notificationService.ts](file://src/services/notificationService.ts#L401-L455)